<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>鸿易讯 | XBXyftx</title><meta name="author" content="XBXyftx"><meta name="copyright" content="XBXyftx"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="鸿易讯，鸿蒙新闻与鸿蒙开发问答助手应用。">
<meta property="og:type" content="article">
<meta property="og:title" content="鸿易讯">
<meta property="og:url" content="https://xbxyftx.top/2025/11/18/HongYiXun/index.html">
<meta property="og:site_name" content="XBXyftx">
<meta property="og:description" content="鸿易讯，鸿蒙新闻与鸿蒙开发问答助手应用。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://xbxyftx.top/imgs/ArticleTopImgs/HongYiXunTopImg.webp">
<meta property="article:published_time" content="2025-11-18T07:19:14.000Z">
<meta property="article:modified_time" content="2026-01-28T06:14:46.234Z">
<meta property="article:author" content="XBXyftx">
<meta property="article:tag" content="技术向">
<meta property="article:tag" content="鸿蒙">
<meta property="article:tag" content="V2">
<meta property="article:tag" content="项目">
<meta property="article:tag" content="鸿易讯">
<meta property="article:tag" content="扣子">
<meta property="article:tag" content="智能体">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xbxyftx.top/imgs/ArticleTopImgs/HongYiXunTopImg.webp"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "鸿易讯",
  "url": "https://xbxyftx.top/2025/11/18/HongYiXun/",
  "image": "https://xbxyftx.top/imgs/ArticleTopImgs/HongYiXunTopImg.webp",
  "datePublished": "2025-11-18T07:19:14.000Z",
  "dateModified": "2026-01-28T06:14:46.234Z",
  "author": [
    {
      "@type": "Person",
      "name": "XBXyftx",
      "url": "https://github.com/XBXyftx"
    }
  ]
}</script><link rel="shortcut icon" href="/img/logo.png"><link rel="canonical" href="https://xbxyftx.top/2025/11/18/HongYiXun/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//cn.vercount.one"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><link rel="stylesheet" href="/css/typewriter-effect.css"><link rel="stylesheet" href="/css/entrance-popup.css"><link rel="stylesheet" href="/css/lazy-loading.css"><link rel="stylesheet" href="/css/lazy-image-refresh.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":true,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":2000,"languages":{"author":"作者: XBXyftx","link":"链接: ","source":"来源: XBXyftx","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'null',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: '/',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '鸿易讯',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post',
  typewriter: '⚡ 鸿蒙应用性能优化实战：异步链条管理、分页数据流、Map查询加速191倍、GitHub风格热力日历'
}</script><script>document.documentElement.setAttribute('data-theme','dark');</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="/css/universe.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/css/transpancy.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/css/styles.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/css/rightmenu.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/css/twikoo.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/css/lazy-loading-optimized.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="/css/readmode-enhanced.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" media="print" onload="this.media='all'"><script src="/js/header-universe.js"></script><!-- 新增缓存管理脚本 - 已禁用Service Worker--><!-- hexo injector head_end start --><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiperstyle.css" media="print" onload="this.media='all'"><!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="cat__scene"><div class="cat__main"><div class="cat__body"></div><div class="cat__body"></div><div class="cat__tail"></div><div class="cat__head"></div></div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
      setTimeout(() => {
        $loadingBox.style.display = 'none'
      }, 800)
    },
    initLoading: () => {
      $loadingBox.style.display = 'flex'
      $loadingBox.classList.remove('loaded')
      $body.style.overflow = 'hidden'
    }
  }

  preloader.initLoading()
  
  // 设置10秒超时
  const loadingTimeout = setTimeout(() => {
    preloader.endLoading()
  }, 10000)
  
  window.addEventListener('load', () => {
    clearTimeout(loadingTimeout)
    preloader.endLoading()
  })

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(https://bu.dusays.com/2025/07/04/6867890f5d403.png);"></div><div class="entrance-popup" id="entrance-popup"><div class="popup-content"><div class="popup-header"><span class="popup-title">温馨提示</span><span class="popup-close">×</span></div><div class="popup-body"><div class="popup-text"></div></div></div><div class="popup-overlay"></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-close-btn"><i class="fas fa-times"></i></div><div class="avatar-img text-center"><img src="/img/logo.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">46</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">44</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 文库</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/coffer/"><i class="fa-fw fa-solid fa-key"></i><span> 秘密基地</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-i"></i><span> Myself</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li><li><a class="site-page child" href="/swiper/"><i class="fa-fw fa-solid fa-star-of-david"></i><span> 昨日重现</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fa-solid fa-comment"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/LianlianKan/"><i class="fa-fw fa-solid fa-gamepad"></i><span> 连连看</span></a></div><div class="menus_item"><a class="site-page" href="/MarkdownPreview/"><i class="fa-fw fa-solid fa-file-code"></i><span> MD在线编辑器</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/imgs/ArticleTopImgs/HongYiXunTopImg.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/logo.png" alt="Logo"><span class="site-name">XBXyftx</span></a><a class="nav-page-title" href="/"><span class="site-name">鸿易讯</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 文库</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/coffer/"><i class="fa-fw fa-solid fa-key"></i><span> 秘密基地</span></a></li></ul></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fa-solid fa-i"></i><span> Myself</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接</span></a></li><li><a class="site-page child" href="/swiper/"><i class="fa-fw fa-solid fa-star-of-david"></i><span> 昨日重现</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fa-solid fa-comment"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/LianlianKan/"><i class="fa-fw fa-solid fa-gamepad"></i><span> 连连看</span></a></div><div class="menus_item"><a class="site-page" href="/MarkdownPreview/"><i class="fa-fw fa-solid fa-file-code"></i><span> MD在线编辑器</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">鸿易讯</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-11-18T07:19:14.000Z" title="发表于 2025-11-18 15:19:14">2025-11-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2026-01-28T06:14:46.234Z" title="更新于 2026-01-28 14:14:46">2026-01-28</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">46.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>191分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:100,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2026-01-28 14:14:46&quot;}" hidden></div><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在完成了鸿小易以及NowInOpenHarmony这两个项目的开发之后我们，子安学长将我引荐给了陈若愚老师，陈老师联系到中软国际，想要让我们去开发应用并协助我们将应用上架，这对于我来说可谓是千载难逢的机会了，毕竟我一直渴望能真正上架一个应用，但一致被后端服务器，备案，资质，内容过于简单等等一系列的问题所卡住，这次有了中软的协助我们应该就能更加专注于开发了。</p>
<p>而且这一次，我不再是独立开发，而是有了孙妈以及bqf，zxjc，hyx的协作，五个人的力量，再加上Codex，Claude Code的协助我相信我们一定能成功上架的。</p>
<h2 id="选题"><a href="#选题" class="headerlink" title="选题"></a>选题</h2><p>中软的老师确实是给了我们很多可选的选题，都是很标准的两个主功能的小应用，很轻量化，但也确实是没什么实际用途做出来也只是在应用市场上充数罢了，所以不如说是去圆一下之前的梦，把鸿小易和NowInOpenHarmony这两个应用给融合为一个新应用，于是“鸿易讯”诞生了。</p>
<h3 id="核心功能"><a href="#核心功能" class="headerlink" title="核心功能"></a>核心功能</h3><div class="table-container">
<table>
<thead>
<tr>
<th>功能层级</th>
<th>功能名称</th>
<th>子功能/具体内容</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>一级功能</strong></td>
<td>鸿蒙新闻资讯</td>
<td>二级功能1：鸿蒙新闻</td>
<td>展示鸿蒙系统相关的最新行业新闻、官方动态、技术更新等内容</td>
</tr>
<tr>
<td></td>
<td></td>
<td>二级功能2：开源鸿蒙新闻</td>
<td>聚焦开源鸿蒙项目的进展、社区动态、代码提交、开源合作等信息</td>
</tr>
<tr>
<td><strong>一级功能</strong></td>
<td>鸿蒙智能问答AI助手</td>
<td>二级功能1：快速问答模式</td>
<td>针对鸿蒙开发相关的基础问题、常见疑问，提供快速精准的解答</td>
</tr>
<tr>
<td></td>
<td></td>
<td>二级功能2：DeepResearch模式</td>
<td>针对复杂的鸿蒙开发技术难题、深度研究需求，进行多维度分析与详细解答</td>
</tr>
<tr>
<td><strong>一级功能</strong></td>
<td>设置</td>
<td>隐私政策</td>
<td>展示应用数据收集、使用、存储及保护相关的隐私条款内容</td>
</tr>
<tr>
<td></td>
<td></td>
<td>版本号</td>
<td>显示当前应用的版本信息（示例：V1.0.0）</td>
</tr>
</tbody>
</table>
</div>
<hr>
<h2 id="核心问题记录"><a href="#核心问题记录" class="headerlink" title="核心问题记录"></a>核心问题记录</h2><p>这一次我不准备再像过去一样事无巨细的去记录全部流程，而是只去分析记录核心问题的解决方案以及一些试错方案，并且对于AI生成的代码去进行更进一步的解读。</p>
<h3 id="AppInit"><a href="#AppInit" class="headerlink" title="AppInit"></a>AppInit</h3><p>在我开发NowInOpenHarmony的时候，我参考子安学长曾经项目中的模式，将全部需要进行初始化的模块功能统一封装到了Product模块的AppInit类中，这也是可以针对于不同形态的设备配置不同的AppInit流程。这一块我此前并没有很多实践经验，对于具体的初始化流程规划以及日志的打印格式都是以实用主义的模式去进行编写的，一切以能排查出Bug为目标，就没有很规范。所以我决定要用AI去帮我进行一下重构。</p>
<p>在此前的经验中我们可以知道Claude对于ArkTS的开发有一定的基础认知但是对于接口的版本以及TS于ArkTS的语法临界区没有很好的把握，所以我选择使用详尽的描述以及在现有代码结构上举例说明的形式，来让Claude把其他应用开发中的通识性经验迁移到我的项目中，我也可以趁机学习一下对于多Promise的管理以及对于日志的格式化输出。</p>
<p>首先我先放一下在NowInOpenHarmony中AppInit的代码作为对比。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2025 XBXyftx</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="variable constant_">GET_USER_CONFIG</span>, logger, preferenceDB, <span class="title class_">UserConfigViewModel</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; common &#125; <span class="keyword">from</span> <span class="string">&quot;@kit.AbilityKit&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppStorageV2</span>, promptAction &#125; <span class="keyword">from</span> <span class="string">&quot;@kit.ArkUI&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; colorModManager, newsManager, userConfigManager &#125; <span class="keyword">from</span> <span class="string">&quot;feature&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; lvCode, lvText &#125; <span class="keyword">from</span> <span class="string">&quot;@luvi/lv-markdown-in&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">AppInit</span>_LOG_TAG = <span class="string">&#x27;AppInit: &#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 应用初始化接口</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppInit</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 用户配置项初始化</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">configInit</span>(<span class="params"><span class="attr">context</span>: common.<span class="title class_">UIAbilityContext</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">isPreferenceDBInitSuccess</span>: <span class="built_in">boolean</span> = preferenceDB.<span class="title function_">init</span>(context)</span><br><span class="line">    <span class="keyword">if</span> (isPreferenceDBInitSuccess) &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;AppInit_LOG_TAG&#125;</span>首选项数据对象初始化成功`</span>)</span><br><span class="line">      <span class="keyword">if</span> (userConfigManager.<span class="title function_">syncDataToAppStorage</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      promptAction.<span class="title function_">openToast</span>(&#123; <span class="attr">message</span>: <span class="string">`<span class="subst">$&#123;AppInit_LOG_TAG&#125;</span>首选项数据对象初始化错误`</span> &#125;)</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;AppInit_LOG_TAG&#125;</span>首选项数据对象初始化错误`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">initAll</span>(<span class="params"><span class="attr">uiAbilityContext</span>: common.<span class="title class_">UIAbilityContext</span>, <span class="attr">applicationContext</span>: common.<span class="title class_">ApplicationContext</span></span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> newsManager.<span class="title function_">init</span>(uiAbilityContext)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">configInit</span>(uiAbilityContext)</span><br><span class="line">    colorModManager.<span class="title function_">init</span>(applicationContext)</span><br><span class="line">    <span class="keyword">await</span> newsManager.<span class="title function_">updateNewsListToDB</span>()</span><br><span class="line">    <span class="keyword">await</span> newsManager.<span class="title function_">updateNewsSwiperToDB</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">markDownConfigInit</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> baseFontSize =</span><br><span class="line">      <span class="title class_">AppStorageV2</span>.<span class="title function_">connect</span>(<span class="title class_">UserConfigViewModel</span>, <span class="variable constant_">GET_USER_CONFIG</span>, <span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">UserConfigViewModel</span>())!.<span class="property">fontSize</span></span><br><span class="line">    lvCode.<span class="title function_">setIndexState</span>(<span class="literal">true</span>)</span><br><span class="line">    lvText.<span class="title function_">setTextSize</span>(baseFontSize)</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;AppInit_LOG_TAG&#125;</span>Markdown初始化成功`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> appInit = <span class="keyword">new</span> <span class="title class_">AppInit</span>()</span><br></pre></td></tr></table></figure>
<p>我原本的手搓版本只是在一位的滥用await去进行异步的处理，并没用到很多Promise原生的对于多异步任务的管理方法。</p>
<p>接下来让我们来看一下Claude给出的版本。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2025 XBXyftx</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="variable constant_">APP_STORAGE_KEYS</span>, logger, preferenceDB, <span class="title class_">UserConfigViewModel</span>, <span class="variable constant_">LOG_TAG</span>, kvDatabase</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;common&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; common &#125; <span class="keyword">from</span> <span class="string">&quot;@kit.AbilityKit&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; colorModManager, newsManager, userConfigManager &#125; <span class="keyword">from</span> <span class="string">&quot;feature&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppStorageV2</span>, promptAction &#125; <span class="keyword">from</span> <span class="string">&quot;@kit.ArkUI&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; lvCode, lvText &#125; <span class="keyword">from</span> <span class="string">&quot;@luvi/lv-markdown-in&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">InitStatus</span> &#125; <span class="keyword">from</span> <span class="string">&quot;../modules/AppInit/InitStatus&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 应用初始化管理类</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 负责管理应用启动时各个模块的初始化流程，采用分阶段初始化策略</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment"> * 初始化阶段设计：</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * **阶段 1 - 基础模块初始化（onCreate）**</span></span><br><span class="line"><span class="comment"> * - 数据库初始化：KVDatabase、PreferenceDB</span></span><br><span class="line"><span class="comment"> * - 用户配置加载：从持久化存储恢复配置</span></span><br><span class="line"><span class="comment"> * - 业务管理器初始化：NewsManager 等</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * **阶段 2 - 窗口相关初始化（onWindowStageCreate）**</span></span><br><span class="line"><span class="comment"> * - AppStorageV2 初始化：窗口宽度等全局状态</span></span><br><span class="line"><span class="comment"> * - 主题管理器初始化：ColorModManager（依赖 ApplicationContext）</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * **阶段 3 - UI 依赖初始化（页面加载后）**</span></span><br><span class="line"><span class="comment"> * - Markdown 配置：依赖 AppStorageV2 中的用户配置</span></span><br><span class="line"><span class="comment"> * - 其他 UI 相关配置</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 初始化顺序的重要性：</span></span><br><span class="line"><span class="comment"> * - AppStorageV2 必须在 Window 创建后才能使用</span></span><br><span class="line"><span class="comment"> * - 用户配置需要先从 PreferenceDB 加载再同步到 AppStorageV2</span></span><br><span class="line"><span class="comment"> * - Markdown 配置依赖 AppStorageV2 中的字体大小设置</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment"> * ```typescript</span></span><br><span class="line"><span class="comment"> * // 在 EntryAbility 中使用</span></span><br><span class="line"><span class="comment"> * class EntryAbility extends UIAbility &#123;</span></span><br><span class="line"><span class="comment"> *   // 阶段 1：基础初始化</span></span><br><span class="line"><span class="comment"> *   onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void &#123;</span></span><br><span class="line"><span class="comment"> *     appInit.initPhase1_BaseModules(this.context)</span></span><br><span class="line"><span class="comment"> *   &#125;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *   // 阶段 2：窗口初始化</span></span><br><span class="line"><span class="comment"> *   onWindowStageCreate(windowStage: window.WindowStage): void &#123;</span></span><br><span class="line"><span class="comment"> *     appInit.initPhase2_WindowRelated(this.context.getApplicationContext())</span></span><br><span class="line"><span class="comment"> *     </span></span><br><span class="line"><span class="comment"> *     windowStage.loadContent(&#x27;pages/StartPage&#x27;, (err) =&gt; &#123;</span></span><br><span class="line"><span class="comment"> *       if (!err.code) &#123;</span></span><br><span class="line"><span class="comment"> *         // 阶段 3：UI 依赖初始化</span></span><br><span class="line"><span class="comment"> *         appInit.initPhase3_UIDependent()</span></span><br><span class="line"><span class="comment"> *       &#125;</span></span><br><span class="line"><span class="comment"> *     &#125;)</span></span><br><span class="line"><span class="comment"> *   &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * ```</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> EntryAbility 应用入口，协调初始化流程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppInit</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 初始化状态追踪</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 记录各个模块的初始化状态，便于调试和错误定位</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">initStatus</span>: <span class="title class_">InitStatus</span> = &#123;</span><br><span class="line">    <span class="attr">databases</span>: <span class="literal">false</span>,        <span class="comment">// 数据库初始化状态</span></span><br><span class="line">    <span class="attr">userConfig</span>: <span class="literal">false</span>,       <span class="comment">// 用户配置初始化状态</span></span><br><span class="line">    <span class="attr">managers</span>: <span class="literal">false</span>,         <span class="comment">// 管理器初始化状态</span></span><br><span class="line">    <span class="attr">appStorageV2</span>: <span class="literal">false</span>,     <span class="comment">// AppStorageV2 初始化状态</span></span><br><span class="line">    <span class="attr">markdown</span>: <span class="literal">false</span>          <span class="comment">// Markdown 初始化状态</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ==================== 阶段 1：基础模块初始化 ====================</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 阶段 1：基础模块初始化</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 在 EntryAbility.onCreate() 中调用，初始化不依赖窗口的基础模块</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">uiAbilityContext</span> - UIAbility 上下文对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> Promise&lt;boolean&gt; - 初始化是否成功</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 初始化内容：</span></span><br><span class="line"><span class="comment">   * 1. 数据库模块（KV数据库、偏好设置数据库）</span></span><br><span class="line"><span class="comment">   * 2. 用户配置加载（从持久化存储恢复）</span></span><br><span class="line"><span class="comment">   * 3. 业务管理器（新闻管理器等）</span></span><br><span class="line"><span class="comment">   * 4. 数据预加载（新闻列表、轮播图）</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 调用时机：</span></span><br><span class="line"><span class="comment">   * - 应用启动的最早阶段</span></span><br><span class="line"><span class="comment">   * - 在创建窗口之前</span></span><br><span class="line"><span class="comment">   * - 在访问 UI 之前</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 注意事项：</span></span><br><span class="line"><span class="comment">   * - 此阶段不能访问 AppStorageV2</span></span><br><span class="line"><span class="comment">   * - 不能进行 UI 操作</span></span><br><span class="line"><span class="comment">   * - 应尽快完成，避免阻塞启动</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment">   * ```typescript</span></span><br><span class="line"><span class="comment">   * onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void &#123;</span></span><br><span class="line"><span class="comment">   *   appInit.initPhase1_BaseModules(this.context).then(success =&gt; &#123;</span></span><br><span class="line"><span class="comment">   *     if (success) &#123;</span></span><br><span class="line"><span class="comment">   *       logger.info(&#x27;基础模块初始化成功&#x27;)</span></span><br><span class="line"><span class="comment">   *     &#125; else &#123;</span></span><br><span class="line"><span class="comment">   *       logger.error(&#x27;基础模块初始化失败，应用可能无法正常运行&#x27;)</span></span><br><span class="line"><span class="comment">   *     &#125;</span></span><br><span class="line"><span class="comment">   *   &#125;)</span></span><br><span class="line"><span class="comment">   * &#125;</span></span><br><span class="line"><span class="comment">   * ```</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">initPhase1_BaseModules</span>(<span class="attr">uiAbilityContext</span>: common.<span class="property">UIAbilityContext</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>========== 开始阶段 1：基础模块初始化 ==========`</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 步骤 1：初始化数据库</span></span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>步骤 1/4：初始化数据库模块...`</span>)</span><br><span class="line">      <span class="keyword">const</span> dbInitSuccess = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">initDatabases</span>(uiAbilityContext)</span><br><span class="line">      <span class="keyword">if</span> (!dbInitSuccess) &#123;</span><br><span class="line">        logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✗ 数据库初始化失败，终止初始化流程 - 请检查应用权限和存储空间`</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 步骤 2：加载用户配置</span></span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>步骤 2/4：加载用户配置...`</span>)</span><br><span class="line">      <span class="keyword">const</span> configInitSuccess = <span class="variable language_">this</span>.<span class="title function_">initUserConfig</span>(uiAbilityContext)</span><br><span class="line">      <span class="keyword">if</span> (!configInitSuccess) &#123;</span><br><span class="line">        logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>用户配置初始化失败，将使用默认配置`</span>)</span><br><span class="line">        <span class="comment">// 配置加载失败不影响应用运行，继续执行</span></span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 步骤 3：初始化业务管理器</span></span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>步骤 3/4：初始化业务管理器...`</span>)</span><br><span class="line">      <span class="keyword">const</span> managersInitSuccess = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">initManagers</span>(uiAbilityContext)</span><br><span class="line">      <span class="keyword">if</span> (!managersInitSuccess) &#123;</span><br><span class="line">        logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✗ 管理器初始化失败 - 应用可继续运行但新闻功能不可用`</span>)</span><br><span class="line">        <span class="comment">// 管理器初始化失败不终止流程，允许应用继续启动</span></span><br><span class="line">        <span class="comment">// return false</span></span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 步骤 4：预加载数据</span></span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>步骤 4/4：预加载应用数据...`</span>)</span><br><span class="line">      <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">preloadData</span>()</span><br><span class="line">      </span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>========== 阶段 1 完成：基础模块初始化成功 ==========`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      </span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✗ 阶段 1 初始化异常 - 详细信息：<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">      promptAction.<span class="title function_">openToast</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;应用初始化失败，请重启应用&#x27;</span> &#125;)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 初始化数据库模块</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 初始化 KV 数据库和偏好设置数据库</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">context</span> - UIAbility 上下文</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> Promise&lt;boolean&gt; - 是否初始化成功</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 初始化顺序：</span></span><br><span class="line"><span class="comment">   * 1. KV 数据库：用于缓存业务数据（新闻列表等）</span></span><br><span class="line"><span class="comment">   * 2. 偏好设置数据库：用于存储用户配置</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 失败处理：</span></span><br><span class="line"><span class="comment">   * - KV 数据库失败：可能影响离线功能</span></span><br><span class="line"><span class="comment">   * - 偏好设置失败：会使用默认配置</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">initDatabases</span>(<span class="attr">context</span>: common.<span class="property">UIAbilityContext</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// 初始化 KV 数据库</span></span><br><span class="line">    <span class="keyword">const</span> kvInitSuccess = kvDatabase.<span class="title function_">init</span>(context)</span><br><span class="line">    <span class="keyword">if</span> (kvInitSuccess) &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✓ KV 数据库初始化成功`</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">databases</span> = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✗ KV 数据库初始化失败 - 原因：KVManager 创建失败或 context 无效`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化偏好设置数据库</span></span><br><span class="line">    <span class="keyword">const</span> preferenceInitSuccess = preferenceDB.<span class="title function_">init</span>(context)</span><br><span class="line">    <span class="keyword">if</span> (preferenceInitSuccess) &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✓ 偏好设置数据库初始化成功`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✗ 偏好设置数据库初始化失败 - 原因：Preferences 实例创建失败`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 初始化用户配置</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 从偏好设置数据库加载用户配置，恢复用户的个性化设置</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">context</span> - UIAbility 上下文</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> <span class="variable">boolean</span> - 是否初始化成功</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 配置内容：</span></span><br><span class="line"><span class="comment">   * - 字体大小（FONT_SIZE）</span></span><br><span class="line"><span class="comment">   * - 颜色模式（COLOR_MODE）</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 数据流：</span></span><br><span class="line"><span class="comment">   * PreferenceDB → UserConfigManager → 内存状态</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 注意：此阶段还不能同步到 AppStorageV2，因为窗口还未创建</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">initUserConfig</span>(<span class="attr">context</span>: common.<span class="property">UIAbilityContext</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> syncSuccess = userConfigManager.<span class="title function_">syncDataToAppStorage</span>()</span><br><span class="line">      <span class="keyword">if</span> (syncSuccess) &#123;</span><br><span class="line">        logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✓ 用户配置加载成功`</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">userConfig</span> = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>⚠ 用户配置加载失败 - 原因：PreferenceDB 数据读取失败，将使用默认配置`</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✗ 用户配置加载异常 - 原因：<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 初始化业务管理器</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 初始化各个业务模块的管理器</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">context</span> - UIAbility 上下文</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> Promise&lt;boolean&gt; - 是否初始化成功</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 管理器列表：</span></span><br><span class="line"><span class="comment">   * - NewsManager：新闻数据管理</span></span><br><span class="line"><span class="comment">   * - 其他业务管理器...</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 注意：ColorModManager 依赖 ApplicationContext，在阶段 2 初始化</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">initManagers</span>(<span class="attr">context</span>: common.<span class="property">UIAbilityContext</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 初始化新闻管理器</span></span><br><span class="line">      <span class="keyword">const</span> newsManagerInitSuccess = <span class="keyword">await</span> newsManager.<span class="title function_">init</span>(context)</span><br><span class="line">      <span class="keyword">if</span> (newsManagerInitSuccess) &#123;</span><br><span class="line">        logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✓ 新闻管理器初始化成功`</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">managers</span> = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✗ 新闻管理器初始化失败 - 原因：无法获取 KV 数据库实例`</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✗ 管理器初始化异常 - 原因：<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 预加载应用数据</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 在后台预加载必要的数据，提升用户体验</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 预加载策略：</span></span><br><span class="line"><span class="comment">   * - 异步执行，不阻塞主流程</span></span><br><span class="line"><span class="comment">   * - 失败不影响应用启动</span></span><br><span class="line"><span class="comment">   * - 优先加载用户可能立即需要的数据</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 预加载内容：</span></span><br><span class="line"><span class="comment">   * - 新闻文章列表</span></span><br><span class="line"><span class="comment">   * - 轮播图数据</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">preloadData</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 异步更新新闻数据，不阻塞启动流程</span></span><br><span class="line">      <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">        newsManager.<span class="title function_">updateNewsListToDB</span>(),</span><br><span class="line">        newsManager.<span class="title function_">updateNewsSwiperToDB</span>()</span><br><span class="line">      ]).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>数据预加载完成`</span>)</span><br><span class="line">      &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">error</span>: <span class="title class_">Error</span></span>) =&gt;</span> &#123;</span><br><span class="line">        logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>数据预加载失败: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>，将使用缓存数据`</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>数据预加载异常: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ==================== 阶段 2：窗口相关初始化 ====================</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 阶段 2：窗口相关初始化</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 在 EntryAbility.onWindowStageCreate() 中调用，初始化依赖窗口的模块</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">applicationContext</span> - 应用上下文对象</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> <span class="variable">boolean</span> - 初始化是否成功</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 初始化内容：</span></span><br><span class="line"><span class="comment">   * 1. 颜色模式管理器（需要 ApplicationContext 来设置系统主题）</span></span><br><span class="line"><span class="comment">   * 2. 其他依赖窗口的初始化</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 调用时机：</span></span><br><span class="line"><span class="comment">   * - 在窗口创建后</span></span><br><span class="line"><span class="comment">   * - 在加载页面之前</span></span><br><span class="line"><span class="comment">   * - AppStorageV2 可用之后</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 前置条件：</span></span><br><span class="line"><span class="comment">   * - 阶段 1 必须成功完成</span></span><br><span class="line"><span class="comment">   * - Window 对象已创建</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment">   * ```typescript</span></span><br><span class="line"><span class="comment">   * onWindowStageCreate(windowStage: window.WindowStage): void &#123;</span></span><br><span class="line"><span class="comment">   *   // 初始化窗口相关模块</span></span><br><span class="line"><span class="comment">   *   appInit.initPhase2_WindowRelated(this.context.getApplicationContext())</span></span><br><span class="line"><span class="comment">   *   </span></span><br><span class="line"><span class="comment">   *   // 加载页面</span></span><br><span class="line"><span class="comment">   *   windowStage.loadContent(&#x27;pages/StartPage&#x27;, ...)</span></span><br><span class="line"><span class="comment">   * &#125;</span></span><br><span class="line"><span class="comment">   * ```</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">initPhase2_WindowRelated</span>(<span class="attr">applicationContext</span>: common.<span class="property">ApplicationContext</span>): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>========== 开始阶段 2：窗口相关初始化 ==========`</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 初始化颜色模式管理器</span></span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>初始化颜色模式管理器...`</span>)</span><br><span class="line">      <span class="keyword">const</span> colorModInitSuccess = colorModManager.<span class="title function_">init</span>(applicationContext)</span><br><span class="line">      <span class="keyword">if</span> (colorModInitSuccess) &#123;</span><br><span class="line">        logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✓ 颜色模式管理器初始化成功`</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">appStorageV2</span> = <span class="literal">true</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>⚠ 颜色模式管理器初始化失败 - 原因：ApplicationContext 无效，将使用默认主题`</span>)</span><br><span class="line">        <span class="comment">// 不影响应用运行</span></span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>========== 阶段 2 完成：窗口相关初始化成功 ==========`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      </span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>阶段 2 初始化异常: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ==================== 阶段 3：UI 依赖初始化 ====================</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 阶段 3：UI 依赖模块初始化</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 在页面加载完成后调用，初始化依赖 AppStorageV2 的模块</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 初始化内容：</span></span><br><span class="line"><span class="comment">   * - Markdown 配置：需要从 AppStorageV2 获取用户字体大小设置</span></span><br><span class="line"><span class="comment">   * - 其他 UI 相关配置</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 调用时机：</span></span><br><span class="line"><span class="comment">   * - 在 windowStage.loadContent() 的回调中</span></span><br><span class="line"><span class="comment">   * - AppStorageV2 已完全可用</span></span><br><span class="line"><span class="comment">   * - 在显示首页之前</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 独立性：</span></span><br><span class="line"><span class="comment">   * - 此方法保持独立，方便单独调用</span></span><br><span class="line"><span class="comment">   * - 可在需要时重新配置 Markdown</span></span><br><span class="line"><span class="comment">   * - 不影响其他初始化流程</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 前置条件：</span></span><br><span class="line"><span class="comment">   * - 阶段 1 和阶段 2 必须完成</span></span><br><span class="line"><span class="comment">   * - AppStorageV2 中的 USER_CONFIG 必须已初始化</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment">   * ```typescript</span></span><br><span class="line"><span class="comment">   * windowStage.loadContent(&#x27;pages/StartPage&#x27;, (err) =&gt; &#123;</span></span><br><span class="line"><span class="comment">   *   if (err.code) &#123;</span></span><br><span class="line"><span class="comment">   *     hilog.error(DOMAIN, &#x27;testTag&#x27;, &#x27;页面加载失败: %&#123;public&#125;s&#x27;, JSON.stringify(err))</span></span><br><span class="line"><span class="comment">   *     return</span></span><br><span class="line"><span class="comment">   *   &#125;</span></span><br><span class="line"><span class="comment">   *   </span></span><br><span class="line"><span class="comment">   *   // 页面加载成功，初始化 UI 依赖模块</span></span><br><span class="line"><span class="comment">   *   appInit.initPhase3_UIDependent()</span></span><br><span class="line"><span class="comment">   * &#125;)</span></span><br><span class="line"><span class="comment">   * ```</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">initPhase3_UIDependent</span>(): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>========== 开始阶段 3：UI 依赖模块初始化 ==========`</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 初始化 Markdown 配置</span></span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>初始化 Markdown 配置...`</span>)</span><br><span class="line">      <span class="keyword">const</span> markdownInitSuccess = <span class="variable language_">this</span>.<span class="title function_">markDownConfigInit</span>()</span><br><span class="line">      <span class="keyword">if</span> (markdownInitSuccess) &#123;</span><br><span class="line">        logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✓ Markdown 配置初始化成功`</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>⚠ Markdown 配置初始化失败 - 原因：无法从 AppStorageV2 获取用户配置，将使用默认配置`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>========== 阶段 3 完成：UI 依赖模块初始化成功 ==========`</span>)</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      </span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>阶段 3 初始化异常: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 配置 Markdown 渲染引擎</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 根据用户的字体大小设置配置 Markdown 渲染参数</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> <span class="variable">boolean</span> - 配置是否成功</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 配置内容：</span></span><br><span class="line"><span class="comment">   * - 代码块行号显示：启用行号</span></span><br><span class="line"><span class="comment">   * - 文本基础字体大小：使用用户设置的字体大小</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 依赖关系：</span></span><br><span class="line"><span class="comment">   * - 依赖 AppStorageV2 中的 USER_CONFIG</span></span><br><span class="line"><span class="comment">   * - 必须在 AppStorageV2 初始化后调用</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 独立性说明：</span></span><br><span class="line"><span class="comment">   * - 此方法可以独立调用</span></span><br><span class="line"><span class="comment">   * - 用户修改字体大小后可重新调用此方法</span></span><br><span class="line"><span class="comment">   * - 不影响其他初始化流程</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 使用的第三方库：</span></span><br><span class="line"><span class="comment">   * - <span class="doctag">@luvi</span>/lv-markdown-in: Markdown 渲染引擎</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment">   * ```typescript</span></span><br><span class="line"><span class="comment">   * // 应用启动时初始化</span></span><br><span class="line"><span class="comment">   * appInit.markDownConfigInit()</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * // 用户修改字体大小后重新配置</span></span><br><span class="line"><span class="comment">   * userConfig.fontSize = 18</span></span><br><span class="line"><span class="comment">   * appInit.markDownConfigInit() // 重新应用配置</span></span><br><span class="line"><span class="comment">   * ```</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">markDownConfigInit</span>(): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 从 AppStorageV2 获取用户字体大小设置</span></span><br><span class="line">      <span class="keyword">const</span> userConfig = <span class="title class_">AppStorageV2</span>.<span class="title function_">connect</span>(</span><br><span class="line">        <span class="title class_">UserConfigViewModel</span>,</span><br><span class="line">        <span class="variable constant_">APP_STORAGE_KEYS</span>.<span class="property">USER_CONFIG</span>,</span><br><span class="line">        <span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">UserConfigViewModel</span>()</span><br><span class="line">      )</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (!userConfig) &#123;</span><br><span class="line">        logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✗ 无法获取用户配置 - 原因：AppStorageV2 中不存在 USER_CONFIG，Markdown 使用默认字体大小`</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">const</span> baseFontSize = userConfig.<span class="property">fontSize</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 配置 Markdown 渲染引擎</span></span><br><span class="line">      lvCode.<span class="title function_">setIndexState</span>(<span class="literal">true</span>)           <span class="comment">// 启用代码块行号</span></span><br><span class="line">      lvText.<span class="title function_">setTextSize</span>(baseFontSize)     <span class="comment">// 设置文本基础字体大小</span></span><br><span class="line">      </span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✓ Markdown 配置成功，字体大小: <span class="subst">$&#123;baseFontSize&#125;</span>`</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">markdown</span> = <span class="literal">true</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      </span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✗ Markdown 配置异常 - 原因：<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ==================== 工具方法 ====================</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 打印初始化状态</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 用于调试和问题诊断，输出各模块的初始化状态</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * - 成功的模块使用 info 级别</span></span><br><span class="line"><span class="comment">   * - 失败的模块使用 warn 级别，便于快速定位问题</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@public</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">printInitStatus</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>========== 初始化状态报告 ==========`</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 数据库模块</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">databases</span>) &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>[数据库模块] ✓ 初始化成功`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>[数据库模块] ✗ 初始化失败 - 影响：离线功能可能不可用`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 用户配置</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">userConfig</span>) &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>[用户配置] ✓ 初始化成功`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>[用户配置] ✗ 初始化失败 - 影响：将使用默认配置（字体16、跟随系统主题）`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 业务管理器</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">managers</span>) &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>[业务管理器] ✓ 初始化成功`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>[业务管理器] ✗ 初始化失败 - 影响：新闻数据功能不可用，请检查网络或数据库`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// AppStorageV2</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">appStorageV2</span>) &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>[AppStorageV2] ✓ 初始化成功`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>[AppStorageV2] ✗ 初始化失败 - 影响：主题切换功能可能不可用`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Markdown 配置</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">markdown</span>) &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>[Markdown配置] ✓ 初始化成功`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>[Markdown配置] ✗ 初始化失败 - 影响：文章渲染使用默认字体`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>======================================`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取初始化状态</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 供外部查询初始化状态</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> 初始化状态对象的只读副本</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 返回初始化状态的深拷贝，避免外部修改内部状态</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">getInitStatus</span>(): <span class="title class_">InitStatus</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      <span class="attr">databases</span>: <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">databases</span>,</span><br><span class="line">      <span class="attr">userConfig</span>: <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">userConfig</span>,</span><br><span class="line">      <span class="attr">managers</span>: <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">managers</span>,</span><br><span class="line">      <span class="attr">appStorageV2</span>: <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">appStorageV2</span>,</span><br><span class="line">      <span class="attr">markdown</span>: <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">markdown</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 检查是否完全初始化</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> <span class="variable">boolean</span> - 所有模块是否都初始化成功</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 检查所有初始化状态是否都为 true</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">isFullyInitialized</span>(): <span class="built_in">boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">databases</span> &amp;&amp;</span><br><span class="line">           <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">userConfig</span> &amp;&amp;</span><br><span class="line">           <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">managers</span> &amp;&amp;</span><br><span class="line">           <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">appStorageV2</span> &amp;&amp;</span><br><span class="line">           <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">markdown</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 应用初始化管理器单例</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 全局唯一的 AppInit 实例，在 EntryAbility 中使用</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment"> * 使用示例：</span></span><br><span class="line"><span class="comment"> * ```typescript</span></span><br><span class="line"><span class="comment"> * import &#123; appInit &#125; from &#x27;../init/AppInit&#x27;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * // 在 EntryAbility 中按阶段调用</span></span><br><span class="line"><span class="comment"> * onCreate() &#123; appInit.initPhase1_BaseModules(this.context) &#125;</span></span><br><span class="line"><span class="comment"> * onWindowStageCreate() &#123; appInit.initPhase2_WindowRelated(...) &#125;</span></span><br><span class="line"><span class="comment"> * // 页面加载后 &#123; appInit.initPhase3_UIDependent() &#125;</span></span><br><span class="line"><span class="comment"> * ```</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> appInit = <span class="keyword">new</span> <span class="title class_">AppInit</span>()</span><br></pre></td></tr></table></figure>
<p>上面是新版的全部源码，由于这一次我是带着学习的心态去编写代码的，所以我让Claude给出了较为详细的注释也方便我们学习。接下来让我们分段拆解一下这个代码。</p>
<h4 id="分段初始化"><a href="#分段初始化" class="headerlink" title="分段初始化"></a>分段初始化</h4><p>首先Claude对于整体初始化的流程进行了阶段的划分，它将初始化的过程切分成了三个阶段，分别是：</p>
<ul>
<li>基础模块初始化</li>
<li>窗口相关模块初始化</li>
<li>UI 依赖模块初始化</li>
</ul>
<p>这三个阶段分别对应了三个方法：</p>
<ul>
<li><code>initPhase1_BaseModules()</code></li>
<li><code>initPhase2_WindowRelated()</code></li>
<li><code>initPhase3_UIDependent()</code></li>
</ul>
<p>这个阶段的划分是依据于模块的依赖关系和初始化的时间点。</p>
<ul>
<li>基础模块初始化：包括数据库、用户配置、业务管理器、AppStorageV2 和 Markdown 配置。这些模块是其他模块的基础，必须在应用启动时就初始化完成。</li>
<li>窗口相关模块初始化：包括窗口管理器、窗口装饰器等。这些模块依赖于基础模块，必须在窗口创建时初始化。</li>
<li>UI 依赖模块初始化：包括界面元素、事件处理等。这些模块依赖于窗口相关模块，必须在界面加载完成后初始化。</li>
</ul>
<h4 id="异步任务执行顺序管理"><a href="#异步任务执行顺序管理" class="headerlink" title="异步任务执行顺序管理"></a>异步任务执行顺序管理</h4><p>在我单独花了一段时间品读了一下Claude的代码之后才发现一段好的代码是真的可以赏心悦目，可以被称之为艺术品了。</p>
<p>这里我们需要结合着<code>EntryAbility</code>的代码来理解讲解。</p>
<p>首先我们要清楚的一点在于我们不同阶段之间以及不同阶段内部存在着一定量的彼此依存，需要严格依照正确的顺序执行，就比如说是我们的新闻数据Manager模块都要依赖于键值数据库的初始化，所有的配置数据Manager模块都依赖于用户首选项数据库的初始化。所以初始化的顺序至关重要。</p>
<p>而当前我们的初始化过程中包含了大量的异步任务，这些异步任务的实际执行时长各不相同，我们所需要的是利用Promise类内置的一系列静态方法来去控制多个异步任务的执行顺序，通过在上一个异步任务的then回调函数中去拉起下一个与之存在依赖关系的异步任务进入任务队列，从而实现异步任务的有序执行。这里不禁让我联想到了当初数据结构所学过的拓扑结构，只有完成全部的前置节点才能达到下一个节点，其应用真的很广，可以说是在日常生活中无处不在的了。</p>
<p>这里我先去放一下<code>EntryAbility</code>的源码然后咱们参照着源码逐一讲解。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2025 XBXyftx</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AbilityConstant</span>, <span class="title class_">UIAbility</span>, <span class="title class_">Want</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.AbilityKit&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; hilog &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.PerformanceAnalysisKit&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppStorageV2</span>, <span class="variable language_">window</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.ArkUI&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; appInit &#125; <span class="keyword">from</span> <span class="string">&#x27;../init/AppInit&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; userConfigManager &#125; <span class="keyword">from</span> <span class="string">&#x27;feature&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">APP_STORAGE_KEYS</span>, <span class="title class_">WinWidth</span>, logger, <span class="variable constant_">LOG_TAG</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;common&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 日志域标识</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 用于 hilog 日志输出，标识日志来源</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">DOMAIN</span> = <span class="number">0x0000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * hilog 日志标签</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 用于过滤和搜索日志</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">TAG</span> = <span class="string">&#x27;EntryAbility&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 应用入口 Ability</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 作为应用的主入口，负责：</span></span><br><span class="line"><span class="comment"> * - 应用生命周期管理</span></span><br><span class="line"><span class="comment"> * - 应用初始化流程协调</span></span><br><span class="line"><span class="comment"> * - 窗口创建和页面加载</span></span><br><span class="line"><span class="comment"> * - 全局状态管理</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment"> * 生命周期方法调用顺序：</span></span><br><span class="line"><span class="comment"> * 1. onCreate(): 应用创建时调用，进行基础初始化</span></span><br><span class="line"><span class="comment"> * 2. onWindowStageCreate(): 窗口创建时调用，初始化 UI 相关模块</span></span><br><span class="line"><span class="comment"> * 3. onForeground(): 应用进入前台</span></span><br><span class="line"><span class="comment"> * 4. onBackground(): 应用进入后台，保存数据</span></span><br><span class="line"><span class="comment"> * 5. onWindowStageDestroy(): 窗口销毁</span></span><br><span class="line"><span class="comment"> * 6. onDestroy(): 应用销毁</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 初始化策略：</span></span><br><span class="line"><span class="comment"> * - 分阶段初始化：基础模块 → 窗口模块 → UI 依赖模块</span></span><br><span class="line"><span class="comment"> * - 异步处理：不阻塞主线程</span></span><br><span class="line"><span class="comment"> * - 错误容错：关键模块失败时有降级方案</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> AppInit 应用初始化管理器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">EntryAbility</span> <span class="keyword">extends</span> <span class="title class_ inherited__">UIAbility</span> &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 阶段 1 初始化 Promise</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 用于在窗口创建时等待阶段 1 完成，确保初始化顺序正确</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">phase1Promise</span>: <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="literal">null</span> = <span class="literal">null</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 应用创建生命周期回调</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 在应用启动时调用，是初始化的第一个阶段</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">want</span> - 启动意图，包含启动参数</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">launchParam</span> - 启动参数，包含启动原因等信息</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 初始化内容（阶段 1）：</span></span><br><span class="line"><span class="comment">   * - 数据库初始化（KV数据库、偏好设置数据库）</span></span><br><span class="line"><span class="comment">   * - 用户配置加载</span></span><br><span class="line"><span class="comment">   * - 业务管理器初始化</span></span><br><span class="line"><span class="comment">   * - 数据预加载</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 注意事项：</span></span><br><span class="line"><span class="comment">   * - 此时窗口还未创建，不能访问 UI</span></span><br><span class="line"><span class="comment">   * - 不能使用 AppStorageV2</span></span><br><span class="line"><span class="comment">   * - 应快速完成，避免阻塞启动</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 错误处理：</span></span><br><span class="line"><span class="comment">   * - 初始化失败会记录日志</span></span><br><span class="line"><span class="comment">   * - 关键模块失败可能影响应用功能</span></span><br><span class="line"><span class="comment">   * - 非关键模块失败应用仍可运行</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">onCreate</span>(<span class="attr">want</span>: <span class="title class_">Want</span>, <span class="attr">launchParam</span>: <span class="title class_">AbilityConstant</span>.<span class="property">LaunchParam</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    hilog.<span class="title function_">info</span>(<span class="variable constant_">DOMAIN</span>, <span class="variable constant_">TAG</span>, <span class="string">&#x27;%&#123;public&#125;s&#x27;</span>, <span class="string">&#x27;Ability onCreate&#x27;</span>);</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>应用启动，开始初始化流程`</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 阶段 1：基础模块初始化（异步执行，保存 Promise 供后续等待）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">phase1Promise</span> = appInit.<span class="title function_">initPhase1_BaseModules</span>(<span class="variable language_">this</span>.<span class="property">context</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 应用销毁生命周期回调</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 在应用退出时调用，进行资源清理</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 清理内容：</span></span><br><span class="line"><span class="comment">   * - 释放数据库连接</span></span><br><span class="line"><span class="comment">   * - 取消事件监听</span></span><br><span class="line"><span class="comment">   * - 清理临时数据</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">onDestroy</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    hilog.<span class="title function_">info</span>(<span class="variable constant_">DOMAIN</span>, <span class="variable constant_">TAG</span>, <span class="string">&#x27;%&#123;public&#125;s&#x27;</span>, <span class="string">&#x27;Ability onDestroy&#x27;</span>);</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>应用销毁`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 窗口阶段创建生命周期回调</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 在窗口创建后调用，是初始化的第二和第三阶段</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">windowStage</span> - 窗口舞台对象，用于管理窗口和加载页面</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 初始化内容：</span></span><br><span class="line"><span class="comment">   * - 等待阶段 1 完成（确保初始化顺序）</span></span><br><span class="line"><span class="comment">   * - 阶段 2：窗口相关初始化（颜色模式管理器等）</span></span><br><span class="line"><span class="comment">   * - AppStorageV2 初始化（窗口宽度）</span></span><br><span class="line"><span class="comment">   * - 页面加载（StartPage）</span></span><br><span class="line"><span class="comment">   * - 阶段 3：UI 依赖初始化（Markdown 配置等）</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * AppStorageV2 初始化时机：</span></span><br><span class="line"><span class="comment">   * - 窗口创建后，页面加载前</span></span><br><span class="line"><span class="comment">   * - 必须在访问 AppStorageV2 之前完成</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 页面加载策略：</span></span><br><span class="line"><span class="comment">   * - 首先加载启动页（StartPage）</span></span><br><span class="line"><span class="comment">   * - 启动页会自动跳转到主页（Index）</span></span><br><span class="line"><span class="comment">   * - 使用路由动画提升用户体验</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">onWindowStageCreate</span>(<span class="attr">windowStage</span>: <span class="variable language_">window</span>.<span class="property">WindowStage</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    hilog.<span class="title function_">info</span>(<span class="variable constant_">DOMAIN</span>, <span class="variable constant_">TAG</span>, <span class="string">&#x27;%&#123;public&#125;s&#x27;</span>, <span class="string">&#x27;Ability onWindowStageCreate&#x27;</span>);</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>窗口创建，等待阶段 1 完成...`</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等待阶段 1 完成（如果还在进行中）</span></span><br><span class="line">    <span class="keyword">const</span> phase1Promise = <span class="variable language_">this</span>.<span class="property">phase1Promise</span> || <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="literal">false</span>)</span><br><span class="line">    </span><br><span class="line">    phase1Promise.<span class="title function_">then</span>(<span class="function">(<span class="params">phase1Success</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 记录阶段 1 结果</span></span><br><span class="line">      <span class="keyword">if</span> (phase1Success) &#123;</span><br><span class="line">        logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>✓ 阶段 1 初始化成功`</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>✗ 阶段 1 初始化失败，应用可能无法正常运行`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 阶段 2：窗口相关模块初始化</span></span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>开始阶段 2 初始化...`</span>)</span><br><span class="line">      <span class="keyword">const</span> phase2Success = appInit.<span class="title function_">initPhase2_WindowRelated</span>(<span class="variable language_">this</span>.<span class="property">context</span>.<span class="title function_">getApplicationContext</span>())</span><br><span class="line">      <span class="keyword">if</span> (phase2Success) &#123;</span><br><span class="line">        logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>✓ 阶段 2 初始化成功`</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>⚠ 阶段 2 初始化失败，部分功能可能受影响`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 初始化 AppStorageV2：存储窗口宽度</span></span><br><span class="line">      <span class="variable language_">window</span>.<span class="title function_">getLastWindow</span>(<span class="variable language_">this</span>.<span class="property">context</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">win</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> winWidth = win.<span class="title function_">getWindowProperties</span>().<span class="property">windowRect</span>.<span class="property">width</span></span><br><span class="line">        <span class="title class_">AppStorageV2</span>.<span class="title function_">connect</span>(<span class="title class_">WinWidth</span>, <span class="variable constant_">APP_STORAGE_KEYS</span>.<span class="property">WINDOW_WIDTH</span>, <span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">WinWidth</span>(winWidth))</span><br><span class="line">        logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>窗口宽度已存储到 AppStorageV2: <span class="subst">$&#123;winWidth&#125;</span>px`</span>)</span><br><span class="line">      &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">error</span>: <span class="title class_">Error</span></span>) =&gt;</span> &#123;</span><br><span class="line">        logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>获取窗口宽度失败: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 加载启动页面</span></span><br><span class="line">      windowStage.<span class="title function_">loadContent</span>(<span class="string">&#x27;pages/StartPage&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err.<span class="property">code</span>) &#123;</span><br><span class="line">          hilog.<span class="title function_">error</span>(<span class="variable constant_">DOMAIN</span>, <span class="variable constant_">TAG</span>, <span class="string">&#x27;Failed to load the content. Cause: %&#123;public&#125;s&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(err));</span><br><span class="line">          logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>页面加载失败: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(err)&#125;</span>`</span>)</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        hilog.<span class="title function_">info</span>(<span class="variable constant_">DOMAIN</span>, <span class="variable constant_">TAG</span>, <span class="string">&#x27;Succeeded in loading the content.&#x27;</span>);</span><br><span class="line">        logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>启动页加载成功`</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 阶段 3：UI 依赖模块初始化</span></span><br><span class="line">        logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>开始阶段 3 初始化...`</span>)</span><br><span class="line">        <span class="keyword">const</span> phase3Success = appInit.<span class="title function_">initPhase3_UIDependent</span>()</span><br><span class="line">        <span class="keyword">if</span> (phase3Success) &#123;</span><br><span class="line">          logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>✓ 阶段 3 初始化成功`</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>⚠ 阶段 3 初始化失败，部分功能可能受影响`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 等待所有异步操作完成后，打印最终状态报告</span></span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">printFinalInitStatus</span>()</span><br><span class="line">        &#125;, <span class="number">100</span>) <span class="comment">// 给异步操作留出完成时间</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">error</span>: <span class="title class_">Error</span></span>) =&gt;</span> &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>✗ 阶段 1 初始化异常: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>应用启动失败，请重启应用`</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 打印最终初始化状态报告</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 在所有初始化阶段完成后调用，输出完整的状态报告</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">printFinalInitStatus</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>========================================`</span>)</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>      应用初始化完成状态报告`</span>)</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>========================================`</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 打印详细状态</span></span><br><span class="line">    appInit.<span class="title function_">printInitStatus</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查完整初始化状态</span></span><br><span class="line">    <span class="keyword">if</span> (appInit.<span class="title function_">isFullyInitialized</span>()) &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>`</span>)</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>🎉 应用完全初始化成功，所有功能可用`</span>)</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>`</span>)</span><br><span class="line">      logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>⚠️  应用初始化不完整，部分功能可能受限`</span>)</span><br><span class="line">      <span class="keyword">const</span> status = appInit.<span class="title function_">getInitStatus</span>()</span><br><span class="line">      logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>详细状态: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(status)&#125;</span>`</span>)</span><br><span class="line">      logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>========================================`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 窗口阶段销毁生命周期回调</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 在窗口销毁时调用，释放 UI 相关资源</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 清理内容：</span></span><br><span class="line"><span class="comment">   * - 释放 UI 资源</span></span><br><span class="line"><span class="comment">   * - 取消窗口监听</span></span><br><span class="line"><span class="comment">   * - 清理临时 UI 状态</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">onWindowStageDestroy</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    hilog.<span class="title function_">info</span>(<span class="variable constant_">DOMAIN</span>, <span class="variable constant_">TAG</span>, <span class="string">&#x27;%&#123;public&#125;s&#x27;</span>, <span class="string">&#x27;Ability onWindowStageDestroy&#x27;</span>);</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>窗口销毁`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 应用进入前台生命周期回调</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 当应用从后台切换到前台时调用</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 可能的操作：</span></span><br><span class="line"><span class="comment">   * - 刷新数据：检查是否有新内容</span></span><br><span class="line"><span class="comment">   * - 恢复状态：恢复用户操作状态</span></span><br><span class="line"><span class="comment">   * - 重新连接：重新建立网络连接</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">onForeground</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    hilog.<span class="title function_">info</span>(<span class="variable constant_">DOMAIN</span>, <span class="variable constant_">TAG</span>, <span class="string">&#x27;%&#123;public&#125;s&#x27;</span>, <span class="string">&#x27;Ability onForeground&#x27;</span>);</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>应用进入前台`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 应用进入后台生命周期回调</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 当应用从前台切换到后台时调用</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 数据保存：</span></span><br><span class="line"><span class="comment">   * - 自动保存用户配置到持久化存储</span></span><br><span class="line"><span class="comment">   * - 确保用户数据不丢失</span></span><br><span class="line"><span class="comment">   * - 为下次启动做准备</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 保存内容：</span></span><br><span class="line"><span class="comment">   * - 用户字体大小设置</span></span><br><span class="line"><span class="comment">   * - 用户颜色模式偏好</span></span><br><span class="line"><span class="comment">   * - 其他用户配置项</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 执行时机：</span></span><br><span class="line"><span class="comment">   * - 用户按Home键退出</span></span><br><span class="line"><span class="comment">   * - 切换到其他应用</span></span><br><span class="line"><span class="comment">   * - 系统内存不足时被挂起</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">onBackground</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    hilog.<span class="title function_">info</span>(<span class="variable constant_">DOMAIN</span>, <span class="variable constant_">TAG</span>, <span class="string">&#x27;%&#123;public&#125;s&#x27;</span>, <span class="string">&#x27;Ability onBackground&#x27;</span>);</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>应用进入后台，开始保存用户数据`</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 同步用户配置到持久化存储</span></span><br><span class="line">    <span class="keyword">const</span> syncSuccess = userConfigManager.<span class="title function_">syncDataToPreference</span>()</span><br><span class="line">    <span class="keyword">if</span> (syncSuccess) &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>用户配置保存成功`</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>用户配置保存失败，设置可能丢失`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过AppInit的源代码我们可以看到，我们所有的异步操作其实是全部被包裹在了<code>initPhase1</code>中，<code>initPhase1</code>是在<code>Ability</code>的<code>onCreate</code>中调用的，所以我们所有的异步操作都是在<code>Ability</code>的<code>onCreate</code>中完成的。但是问题在于后面的<code>onWindowStageCreate</code>窗口创建阶段与我们的<code>onCreate</code>函数是两个独立的代码块，彼此之间的局部变量并不互通，我们在<code>onCreate</code>的函数中创建的<code>Promise实例对象</code>无法在<code>onWindowStageCreate</code>中访问，所以为了保证阶段二的执行顺序，我们要将<code>appInit.initPhase1_BaseModules</code>对象的可见区域扩大，扩大至当前<code>EntryAbility</code>类的局部变量中。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 阶段 1 初始化 Promise</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 用于在窗口创建时等待阶段 1 完成，确保初始化顺序正确</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="attr">phase1Promise</span>: <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; | <span class="literal">null</span> = <span class="literal">null</span></span><br></pre></td></tr></table></figure>
<p>将作用域提升之后，我们在<code>onCreate</code>函数中去进行promise对象的启动，将启动后的对象的引用赋值给<code>this.phase1Promise</code>，然后在<code>onWindowStageCreate</code>函数中去等待这个promise对象的完成。在完成后去调用<code>appInit.initPhase2_UI</code>函数进行阶段二的初始化。二阶段之所以是没有被单独提升作用域，这是因为二阶段和三阶段都是同步的。三阶段会很自然的排在二阶段的后面，无需额外进行更多操作。</p>
<p>在三个阶段的初始化过程中，每一步的初始化成功之后都会在initStatus这个对象中去记录其初始化状态，如果成功就会在对应的键值中去记录为true，失败就会记录为false。随后在三个初始化阶段的最后会统一进行结果的输出。</p>
<p>而在这个过程中，可能会出现同步进程连续执行，持续到应用准备阶段的最后也没有流出空闲去处理异步函数，导致最后输出的结果为失败是因为还没有执行（在早期版本时，我们的的确确遇到了这个问题。）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">11-18 13:28:07.652   8088-8088     A00000/com.xbxy...EntryAbility  apppool               I     Ability onCreate</span><br><span class="line">11-18 13:28:07.652   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     EntryAbility: 应用启动，开始初始化流程</span><br><span class="line">11-18 13:28:07.652   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     AppInit: ========== 开始阶段 1：基础模块初始化 ==========</span><br><span class="line">11-18 13:28:07.652   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     AppInit: 步骤 1/4：初始化数据库模块...</span><br><span class="line">11-18 13:28:07.653   8088-8088     A03D00/com.xbx...ngYiXun/JSAPP  apppool               I     KVDatabase: Succeeded <span class="keyword">in</span> creating KVManager.</span><br><span class="line">11-18 13:28:07.653   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     KVDatabase: 数据库管理对象创建成功。</span><br><span class="line">11-18 13:28:07.653   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     AppInit: ✓ KV 数据库初始化成功</span><br><span class="line">11-18 13:28:07.653   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     AppInit: ✓ 偏好设置数据库初始化成功</span><br><span class="line">11-18 13:28:07.653   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     AppInit: 步骤 2/4：加载用户配置...</span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     PreferenceDB: Has ColorMode data: <span class="literal">true</span></span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               W     PreferenceDB: Get data ColorMode: 0</span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     UserConfigManager: 检测到COLOR_MODE = 0</span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               W     PreferenceDB: Get data ColorMode: 0</span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     PreferenceDB: Has FontSize data: <span class="literal">true</span></span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               W     PreferenceDB: Get data FontSize: 18</span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     UserConfigManager: 检测到FONT_SIZE = 18</span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               W     PreferenceDB: Get data FontSize: 18</span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     PreferenceDB: Has FontSize data: <span class="literal">true</span></span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     PreferenceDB: Has ColorMode data: <span class="literal">true</span></span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               W     PreferenceDB: Get data ColorMode: 0</span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               W     PreferenceDB: Get data FontSize: 18</span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               W     UserConfigManager: 用户首选项持久化数据读取成功,colorMode=0,fontSize=18</span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     AppInit: ✓ 用户配置加载成功</span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     AppInit: 步骤 3/4：初始化业务管理器...</span><br><span class="line">11-18 13:28:07.655   8088-8088     A03D00/com.xbx...ngYiXun/JSAPP  apppool               I     KVDatabase: Succeeded <span class="keyword">in</span> creating KVManager.</span><br><span class="line">11-18 13:28:07.655   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     KVDatabase: 数据库管理对象创建成功。</span><br><span class="line">11-18 13:28:07.665   8088-8088     A00000/com.xbxy...EntryAbility  apppool               I     Ability onWindowStageCreate</span><br><span class="line">11-18 13:28:07.665   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     EntryAbility: 窗口创建，开始窗口相关初始化</span><br><span class="line">11-18 13:28:07.666   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     AppInit: ========== 开始阶段 2：窗口相关初始化 ==========</span><br><span class="line">11-18 13:28:07.666   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     AppInit: 初始化颜色模式管理器...</span><br><span class="line">11-18 13:28:07.666   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     ColorModManager: applicationContext初始化成功</span><br><span class="line">11-18 13:28:07.666   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     ColorModManager: initColoModSetting 0: AppStorageV2colorModel = 0</span><br><span class="line">11-18 13:28:07.666   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     AppInit: ✓ 颜色模式管理器初始化成功</span><br><span class="line">11-18 13:28:07.666   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     AppInit: ========== 阶段 2 完成：窗口相关初始化成功 ==========</span><br><span class="line">11-18 13:28:07.666   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     EntryAbility: 阶段 2 初始化成功</span><br><span class="line">11-18 13:28:07.669   8088-8088     A00000/com.xbxy...EntryAbility  apppool               I     Ability onForeground</span><br><span class="line">11-18 13:28:07.669   8088-8088     A01234/com.xbx...Xun/XBXLogger  apppool               I     EntryAbility: 应用进入前台</span><br><span class="line">11-18 13:28:07.707   8088-8088     A00000/com.xbxy...EntryAbility  com.xbxyf...ongYiXun  I     Succeeded <span class="keyword">in</span> loading the content.</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     EntryAbility: 启动页加载成功</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     AppInit: ========== 开始阶段 3：UI 依赖模块初始化 ==========</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     AppInit: 初始化 Markdown 配置...</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     AppInit: ✓ Markdown 配置成功，字体大小: 18</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     AppInit: ✓ Markdown 配置初始化成功</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     AppInit: ========== 阶段 3 完成：UI 依赖模块初始化成功 ==========</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     AppInit: ========== 应用初始化全部完成 ==========</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     AppInit: ========== 初始化状态报告 ==========</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     AppInit: [数据库模块] ✓ 初始化成功</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     AppInit: [用户配置] ✓ 初始化成功</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  W     AppInit: [业务管理器] ✗ 初始化失败 - 影响：新闻数据功能不可用，请检查网络或数据库</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     AppInit: [AppStorageV2] ✓ 初始化成功</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     AppInit: [Markdown配置] ✓ 初始化成功</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     AppInit: ======================================</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     EntryAbility: 阶段 3 初始化成功</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  W     EntryAbility: 应用初始化不完整，部分功能可能受限</span><br><span class="line">11-18 13:28:07.707   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  W     EntryAbility: 初始化状态: &#123;<span class="string">&quot;databases&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;userConfig&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;managers&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;appStorageV2&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;markdown&quot;</span>:<span class="literal">true</span>&#125;</span><br><span class="line">11-18 13:28:07.708   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     KVDatabase: 成功获取storeId:HongYiXunKVDB数据库实例对象</span><br><span class="line">11-18 13:28:07.708   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     NewsManager: init: 获取appKVDb成功</span><br><span class="line">11-18 13:28:07.708   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     AppInit: ✓ 新闻管理器初始化成功</span><br><span class="line">11-18 13:28:07.708   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     AppInit: 步骤 4/4：预加载应用数据...</span><br><span class="line">11-18 13:28:07.708   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  D     AxiosHttp: 进入AxiosHttp.request URL = /api/health</span><br><span class="line">11-18 13:28:07.721   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  D     AxiosHttp: 进入AxiosHttp.request URL = /api/banner/status</span><br><span class="line">11-18 13:28:07.722   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     AppInit: ========== 阶段 1 完成：基础模块初始化成功 ==========</span><br><span class="line">11-18 13:28:07.722   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     EntryAbility: 阶段 1 初始化成功</span><br><span class="line">11-18 13:28:07.723   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  I     EntryAbility: 窗口宽度已存储到 AppStorageV2: 1320px</span><br><span class="line">11-18 13:28:07.725   8088-8088     A01234/com.xbx...Xun/XBXLogger  com.xbxyf...ongYiXun  D     StartPage: winWidth: 440</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AppInit: [业务管理器] ✗ 初始化失败 - 影响：新闻数据功能不可用，请检查网络或数据库</span><br></pre></td></tr></table></figure>
<p>从这一条和</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AppInit: ✓ 新闻管理器初始化成功</span><br><span class="line">AppInit: 步骤 4/4：预加载应用数据...</span><br></pre></td></tr></table></figure>
<p>这一条的输出顺序可以看出，异步函数的执行顺序问题是确实存在的，是需要解决的问题。</p>
<p>所以为了程序的稳定性，我们需要手动留出一段强制空闲时间去给异步操作进行。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载启动页面</span></span><br><span class="line">windowStage.<span class="title function_">loadContent</span>(<span class="string">&#x27;pages/StartPage&#x27;</span>, <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (err.<span class="property">code</span>) &#123;</span><br><span class="line">    hilog.<span class="title function_">error</span>(<span class="variable constant_">DOMAIN</span>, <span class="variable constant_">TAG</span>, <span class="string">&#x27;Failed to load the content. Cause: %&#123;public&#125;s&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(err));</span><br><span class="line">    logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>页面加载失败: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(err)&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  hilog.<span class="title function_">info</span>(<span class="variable constant_">DOMAIN</span>, <span class="variable constant_">TAG</span>, <span class="string">&#x27;Succeeded in loading the content.&#x27;</span>);</span><br><span class="line">  logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>启动页加载成功`</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 阶段 3：UI 依赖模块初始化</span></span><br><span class="line">  logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>开始阶段 3 初始化...`</span>)</span><br><span class="line">  <span class="keyword">const</span> phase3Success = appInit.<span class="title function_">initPhase3_UIDependent</span>()</span><br><span class="line">  <span class="keyword">if</span> (phase3Success) &#123;</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>✓ 阶段 3 初始化成功`</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>⚠ 阶段 3 初始化失败，部分功能可能受影响`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 等待所有异步操作完成后，打印最终状态报告</span></span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">printFinalInitStatus</span>()</span><br><span class="line">  &#125;, <span class="number">100</span>) <span class="comment">// 给异步操作留出完成时间</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>js和ts的异步逻辑是任务队列，我们通过定时器，将打印函数的调用塞在全部异步操作塞在打印之前，强制将打印函数的执行塞到任务队列的最后。这里设置为100ms是因为在正常情况下这些操作的执行总时长应该是远远低于100ms，若是高于100ms则说明他的执行过程中大概率发生了异常。</p>
<p>随后，对于<code>printFinalInitStatus</code>，这个函数会负责统一的输出三个阶段的初始化状态报告。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 打印最终初始化状态报告</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 在所有初始化阶段完成后调用，输出完整的状态报告</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">printFinalInitStatus</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">  logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>========================================`</span>)</span><br><span class="line">  logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>      应用初始化完成状态报告`</span>)</span><br><span class="line">  logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>========================================`</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 打印详细状态</span></span><br><span class="line">  appInit.<span class="title function_">printInitStatus</span>()</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 检查完整初始化状态</span></span><br><span class="line">  <span class="keyword">if</span> (appInit.<span class="title function_">isFullyInitialized</span>()) &#123;</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>`</span>)</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>🎉 应用完全初始化成功，所有功能可用`</span>)</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>`</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>`</span>)</span><br><span class="line">    logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>⚠️  应用初始化不完整，部分功能可能受限`</span>)</span><br><span class="line">    <span class="keyword">const</span> status = appInit.<span class="title function_">getInitStatus</span>()</span><br><span class="line">    logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>详细状态: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(status)&#125;</span>`</span>)</span><br><span class="line">    logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.ENTRY_ABILITY&#125;</span>========================================`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>printInitStatus()</code>打印的是每个小模块的细则，而<code>isFullyInitialized()</code>则是检查是否所有模块都初始化成功，打印的是整体的初始化情况，两者并不一致。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">Ability onCreate</span><br><span class="line">EntryAbility: 应用启动，开始初始化流程</span><br><span class="line">AppInit: ========== 开始阶段 1：基础模块初始化 ==========</span><br><span class="line">AppInit: 步骤 1/4：初始化数据库模块...</span><br><span class="line">KVDatabase: Succeeded <span class="keyword">in</span> creating KVManager.</span><br><span class="line">KVDatabase: 数据库管理对象创建成功。</span><br><span class="line">AppInit: ✓ KV 数据库初始化成功</span><br><span class="line">AppInit: ✓ 偏好设置数据库初始化成功</span><br><span class="line">AppInit: 步骤 2/4：加载用户配置...</span><br><span class="line">PreferenceDB: Has ColorMode data: <span class="literal">false</span></span><br><span class="line">PreferenceDB: Has FontSize data: <span class="literal">false</span></span><br><span class="line">PreferenceDB: Has FontSize data: <span class="literal">false</span></span><br><span class="line">UserConfigManager: 无用户配置持久化数据，执行默认配置设置</span><br><span class="line">PreferenceDB: Has ColorMode data: <span class="literal">false</span></span><br><span class="line">UserConfigManager: preferenceDB.hasData(PreferenceEnum.COLOR_MODE)=<span class="literal">false</span></span><br><span class="line">PreferenceDB: push data: key=ColorMode,value=2</span><br><span class="line">PreferenceDB: Has FontSize data: <span class="literal">false</span></span><br><span class="line">UserConfigManager: preferenceDB.hasData(PreferenceEnum.FONT_SIZE)=<span class="literal">false</span></span><br><span class="line">PreferenceDB: push data: key=FontSize,value=16</span><br><span class="line">PreferenceDB: Get data ColorMode: 2</span><br><span class="line">PreferenceDB: Get data FontSize: 16</span><br><span class="line">UserConfigManager: 用户首选项持久化数据读取成功,colorMode=2,fontSize=16</span><br><span class="line">AppInit: ✓ 用户配置加载成功</span><br><span class="line">AppInit: 步骤 3/4：初始化业务管理器...</span><br><span class="line">KVDatabase: Succeeded <span class="keyword">in</span> creating KVManager.</span><br><span class="line">KVDatabase: 数据库管理对象创建成功。</span><br><span class="line">Ability onWindowStageCreate</span><br><span class="line">EntryAbility: 窗口创建，等待阶段 1 完成...</span><br><span class="line">Ability onForeground</span><br><span class="line">EntryAbility: 应用进入前台</span><br><span class="line">PreferenceDB: The key FontSize changed</span><br><span class="line">PreferenceDB: The key ColorMode changed</span><br><span class="line">KVDatabase: 成功获取storeId:HongYiXunKVDB数据库实例对象</span><br><span class="line">NewsManager: init: 获取appKVDb成功</span><br><span class="line">AppInit: ✓ 新闻管理器初始化成功</span><br><span class="line">AppInit: 步骤 4/4：预加载应用数据...</span><br><span class="line">AxiosHttp: 进入AxiosHttp.request URL = /api/health</span><br><span class="line">AxiosHttp: 进入AxiosHttp.request URL = /api/banner/status</span><br><span class="line">AppInit: ========== 阶段 1 完成：基础模块初始化成功 ==========</span><br><span class="line">EntryAbility: ✓ 阶段 1 初始化成功</span><br><span class="line">EntryAbility: 开始阶段 2 初始化...</span><br><span class="line">AppInit: ========== 开始阶段 2：窗口相关初始化 ==========</span><br><span class="line">AppInit: 初始化颜色模式管理器...</span><br><span class="line">ColorModManager: applicationContext初始化成功</span><br><span class="line">ColorModManager: initColoModSetting 2: AppStorageV2colorModel = 2</span><br><span class="line">AppInit: ✓ 颜色模式管理器初始化成功</span><br><span class="line">AppInit: ========== 阶段 2 完成：窗口相关初始化成功 ==========</span><br><span class="line">EntryAbility: ✓ 阶段 2 初始化成功</span><br><span class="line">Succeeded <span class="keyword">in</span> loading the content.</span><br><span class="line">EntryAbility: 启动页加载成功</span><br><span class="line">EntryAbility: 开始阶段 3 初始化...</span><br><span class="line">AppInit: ========== 开始阶段 3：UI 依赖模块初始化 ==========</span><br><span class="line">AppInit: 初始化 Markdown 配置...</span><br><span class="line">AppInit: ✓ Markdown 配置成功，字体大小: 16</span><br><span class="line">AppInit: ✓ Markdown 配置初始化成功</span><br><span class="line">AppInit: ========== 阶段 3 完成：UI 依赖模块初始化成功 ==========</span><br><span class="line">EntryAbility: ✓ 阶段 3 初始化成功</span><br><span class="line">EntryAbility: 窗口宽度已存储到 AppStorageV2: 1320px</span><br></pre></td></tr></table></figure>
<p>在经过如此处理之后，输出结果的稳定性得到了大幅提升，经过20次的启动测试均未再出现异步函数执行顺序导致的初始化状态错误。</p>
<h4 id="异步任务管理的关键函数"><a href="#异步任务管理的关键函数" class="headerlink" title="异步任务管理的关键函数"></a>异步任务管理的关键函数</h4><p>在我们AppInit的异步函数控制中使用了大量的Promise类内置的静态方法，同时也使用了<code>async/await</code>的处理方式，接下来我们来着重解析一下这些方法的作用。</p>
<h5 id="async-await与Promise"><a href="#async-await与Promise" class="headerlink" title="async/await与Promise"></a><code>async/await</code>与Promise</h5><p>首先我们要明确<code>async/await</code>与Promise的关系，<code>async/await</code>是Promise的语法糖，它可以让我们在异步函数中使用同步的代码风格，而不需要使用回调函数或者<code>then</code>方法。</p>
<p>这里我们可以从函数的返回值类型来看。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化业务管理器</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 初始化各个业务模块的管理器</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">context</span> - UIAbility 上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> Promise&lt;boolean&gt; - 是否初始化成功</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment"> * 管理器列表：</span></span><br><span class="line"><span class="comment"> * - NewsManager：新闻数据管理</span></span><br><span class="line"><span class="comment"> * - 其他业务管理器...</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 注意：ColorModManager 依赖 ApplicationContext，在阶段 2 初始化</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">initManagers</span>(<span class="attr">context</span>: common.<span class="property">UIAbilityContext</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化新闻管理器</span></span><br><span class="line">    <span class="keyword">const</span> newsManagerInitSuccess = <span class="keyword">await</span> newsManager.<span class="title function_">init</span>(context)</span><br><span class="line">    <span class="keyword">if</span> (newsManagerInitSuccess) &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✓ 新闻管理器初始化成功`</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">managers</span> = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✗ 新闻管理器初始化失败 - 原因：无法获取 KV 数据库实例`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✗ 管理器初始化异常 - 原因：<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数中只包含了一个异步的耗时操作，同时我们的boolean类型的返回值表示的含义是初始化管理器是否成功，是强依赖于新闻管理器的初始化结果的，所以我们需要等待新闻管理器的初始化完成之后才能返回结果。对于这种单一的异步操作函数我们直接使用<code>async/await</code>的方式来处理，和使用<code>then</code>方法的方式没有区别，同时可以使代码风格更加简洁。</p>
<p>我们如果直接调用<code>initManagers</code>这个函数，获取到的是一个Promise对象，而并不是boolean类型的结果。只有等待其操作完成后，通过<code>await</code>或者<code>.then()</code>才能获取到真正的boolean值。</p>
<p>这里需要注意的是，当一个函数被标记为<code>async</code>时，它会自动返回一个Promise对象。这意味着调用者必须使用异步方式（<code>await</code>或<code>.then()</code>）来处理结果。这种设计虽然简化了异步代码的编写，但也意味着任何调用<code>async</code>函数的代码也都变成了异步的，形成了异步调用的链条效应。在复杂的初始化流程中，这种异步传播需要谨慎管理，以避免出现执行顺序不确定的问题。</p>
<p>接下来我们来更进一步的解析一下所谓的异步调用链效应。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化业务管理器</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 初始化各个业务模块的管理器</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">context</span> - UIAbility 上下文</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> Promise&lt;boolean&gt; - 是否初始化成功</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment"> * 管理器列表：</span></span><br><span class="line"><span class="comment"> * - NewsManager：新闻数据管理</span></span><br><span class="line"><span class="comment"> * - 其他业务管理器...</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 注意：ColorModManager 依赖 ApplicationContext，在阶段 2 初始化</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@private</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">initManagers</span>(<span class="attr">context</span>: common.<span class="property">UIAbilityContext</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化新闻管理器</span></span><br><span class="line">    <span class="keyword">const</span> newsManagerInitSuccess = <span class="keyword">await</span> newsManager.<span class="title function_">init</span>(context)</span><br><span class="line">    <span class="keyword">if</span> (newsManagerInitSuccess) &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✓ 新闻管理器初始化成功`</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">managers</span> = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✗ 新闻管理器初始化失败 - 原因：无法获取 KV 数据库实例`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>✗ 管理器初始化异常 - 原因：<span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化函数，获取当前应用的键值对数据库实例。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">context</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">init</span>(<span class="attr">context</span>: common.<span class="property">UIAbilityContext</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">  kvDatabase.<span class="title function_">init</span>(context)</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> kvDatabase.<span class="title function_">getKVStoreById</span>(<span class="variable constant_">APP_KV_DB_ID</span>)</span><br><span class="line">  <span class="keyword">if</span> (res) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">appKVDb</span> = res</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>init: 获取appKVDb成功`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>初始化失败`</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过 ID 获取数据库实例对象</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 根据指定的数据库 ID 获取或创建一个 KV 数据库实例</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">storeId</span> - 数据库实例的唯一标识符</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> Promise&lt;SingleKVStore | null&gt; - 数据库实例对象，失败时返回 null</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment"> * 前置条件：</span></span><br><span class="line"><span class="comment"> * - 必须先调用 init() 方法初始化 KVManager</span></span><br><span class="line"><span class="comment"> * - 如果 kvManager 未初始化，将直接返回 null</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 数据库配置：</span></span><br><span class="line"><span class="comment"> * - createIfMissing: true - 数据库不存在时自动创建</span></span><br><span class="line"><span class="comment"> * - securityLevel: S1 - 安全级别（S1 为最低级别，适合公开数据）</span></span><br><span class="line"><span class="comment"> * - kvStoreType: SINGLE_VERSION - 单版本数据库（不支持分布式同步）</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 监听机制：</span></span><br><span class="line"><span class="comment"> * - 自动监听数据库服务状态变化</span></span><br><span class="line"><span class="comment"> * - 当数据库服务异常时会记录警告日志</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 使用建议：</span></span><br><span class="line"><span class="comment"> * - 建议为不同类型的数据创建不同的数据库实例</span></span><br><span class="line"><span class="comment"> * - 本应用中使用 APP_KV_DB 常量作为统一的 storeId</span></span><br><span class="line"><span class="comment"> * - 数据库实例可以被缓存复用，无需每次都重新获取</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment"> * ```typescript</span></span><br><span class="line"><span class="comment"> * // 获取数据库实例</span></span><br><span class="line"><span class="comment"> * const store = await kvDatabase.getKVStoreById(APP_KV_DB)</span></span><br><span class="line"><span class="comment"> * if (store) &#123;</span></span><br><span class="line"><span class="comment"> *   // 存储数据</span></span><br><span class="line"><span class="comment"> *   await store.put(KV_DB_KEYS.NEWS_ARTICLE_LIST, JSON.stringify(newsList))</span></span><br><span class="line"><span class="comment"> *   </span></span><br><span class="line"><span class="comment"> *   // 读取数据</span></span><br><span class="line"><span class="comment"> *   const data = await store.get(KV_DB_KEYS.NEWS_ARTICLE_LIST)</span></span><br><span class="line"><span class="comment"> *   const articles = JSON.parse(data as string)</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * ```</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> 不会抛出异常，所有错误都会被捕获并记录日志</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">getKVStoreById</span>(<span class="attr">storeId</span>:<span class="built_in">string</span>):<span class="title class_">Promise</span>&lt;distributedKVStore.<span class="property">SingleKVStore</span>|<span class="literal">null</span>&gt;&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">kvManager</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">options</span>:distributedKVStore.<span class="property">Options</span> = &#123;</span><br><span class="line">        <span class="attr">createIfMissing</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">securityLevel</span>: distributedKVStore.<span class="property">SecurityLevel</span>.<span class="property">S1</span>,</span><br><span class="line">        <span class="attr">kvStoreType</span>:distributedKVStore.<span class="property">KVStoreType</span>.<span class="property">SINGLE_VERSION</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">kVStore</span>:distributedKVStore.<span class="property">SingleKVStore</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">kvManager</span>.<span class="title function_">getKVStore</span>(storeId,options)</span><br><span class="line">      <span class="keyword">if</span> (kVStore) &#123;</span><br><span class="line">        logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.KV_DATABASE&#125;</span>成功获取storeId:<span class="subst">$&#123;storeId&#125;</span>数据库实例对象`</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">kvManager</span>.<span class="title function_">on</span>(<span class="string">&#x27;distributedDataServiceDie&#x27;</span>,<span class="function">()=&gt;</span>&#123;</span><br><span class="line">          logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.KV_DATABASE&#125;</span>数据库服务订阅发生变更`</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> kVStore</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">catch</span> (e)&#123;</span><br><span class="line">      <span class="keyword">let</span> err = e <span class="keyword">as</span> <span class="title class_">BusinessError</span></span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.KV_DATABASE&#125;</span>获取KV数据库实例对象异常，异常信息: <span class="subst">$&#123;err.message&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates and obtains a KVStore database by specifying &#123;<span class="doctag">@code</span> Options&#125; and &#123;<span class="doctag">@code</span> storeId&#125;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type"> string </span>&#125; <span class="variable">storeId</span> - Identifies the KVStore database. The value of this parameter must be unique</span></span><br><span class="line"><span class="comment"> * for the same application, and different applications can share the same value. The storeId can consist</span></span><br><span class="line"><span class="comment"> * of only letters, digits, and underscores (_), and cannot exceed 128 characters.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &#123;<span class="type"> Options </span>&#125; <span class="variable">options</span> - Indicates the &#123;<span class="doctag">@code</span> Options&#125; object used for creating and</span></span><br><span class="line"><span class="comment"> * obtaining the KVStore database.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> &#123;<span class="type"> Promise&lt;T&gt; </span>&#125; &#123;<span class="type">T</span>&#125;: the &#123;<span class="doctag">@code</span> SingleKVStore&#125; or &#123;<span class="doctag">@code</span> DeviceKVStore&#125; instance.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> &#123;<span class="type"> BusinessError </span>&#125; 401 - Parameter error.Possible causes:1.Mandatory parameters are left unspecified;</span></span><br><span class="line"><span class="comment"> * &lt;br&gt;2.Incorrect parameters types;</span></span><br><span class="line"><span class="comment"> * &lt;br&gt;3.Parameter verification failed.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> &#123;<span class="type"> BusinessError </span>&#125; 15100002 - Open existed database with changed options.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> &#123;<span class="type"> BusinessError </span>&#125; 15100003 - Database corrupted.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@syscap</span> SystemCapability.DistributedDataManager.KVStore.Core</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 9</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">getKVStore&lt;T&gt;(<span class="attr">storeId</span>: <span class="built_in">string</span>, <span class="attr">options</span>: <span class="title class_">Options</span>): <span class="title class_">Promise</span>&lt;T&gt;;</span><br></pre></td></tr></table></figure>
<p>我将整个调用链条所涉及到的全部函数都列出来了，其实可以看出整个异步调用链条的根源是来自<code>getKVStore</code>函数，这是我们作为应用开发者所能接触到的最底层的一个系统接口，更深层的实现就与开发者无关了，就如同计算机网络中下层协议对上层透明一样。为了方便应用的数据管理我们封装了<code>KVDatabase</code>类、<code>NewsManager</code>类、<code>AppInit</code>类。</p>
<h5 id="层层封装的结构分析"><a href="#层层封装的结构分析" class="headerlink" title="层层封装的结构分析"></a>层层封装的结构分析</h5><p>让我们先梳理一下整个调用链条的层级关系：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">第1层(系统接口): kvManager.getKVStore() -&gt; Promise&lt;SingleKVStore&gt;</span><br><span class="line">              ↓</span><br><span class="line">第2层(数据库封装): kvDatabase.getKVStoreById() -&gt; Promise&lt;SingleKVStore | null&gt;</span><br><span class="line">              ↓</span><br><span class="line">第3层(业务管理器): newsManager.init() -&gt; Promise&lt;boolean&gt;</span><br><span class="line">              ↓</span><br><span class="line">第4层(初始化管理器): appInit.initManagers() -&gt; Promise&lt;boolean&gt;</span><br><span class="line">              ↓</span><br><span class="line">第5层(阶段初始化): appInit.initPhase1_BaseModules() -&gt; Promise&lt;boolean&gt;</span><br></pre></td></tr></table></figure>
<p>每一层封装都在原有功能的基础上添加了新的职责：</p>
<ul>
<li><strong>第2层 KVDatabase</strong>：添加了错误处理、日志记录、实例管理</li>
<li><strong>第3层 NewsManager</strong>：添加了业务逻辑封装、数据库实例缓存</li>
<li><strong>第4层 initManagers</strong>：添加了状态追踪、多管理器协调</li>
<li><strong>第5层 initPhase1</strong>：添加了阶段划分、步骤编排、进度报告</li>
</ul>
<h5 id="层层封装对应用架构的影响"><a href="#层层封装对应用架构的影响" class="headerlink" title="层层封装对应用架构的影响"></a>层层封装对应用架构的影响</h5><h6 id="正面影响"><a href="#正面影响" class="headerlink" title="正面影响"></a>正面影响</h6><p><strong>1. 职责分离与单一职责原则</strong></p>
<p>每一层封装都有其明确的职责边界，这种设计符合SOLID原则中的单一职责原则：</p>
<ul>
<li><code>KVDatabase</code>类：负责键值数据库的底层操作，屏蔽系统接口的复杂性</li>
<li><code>NewsManager</code>类：负责新闻数据的业务逻辑，不关心数据库的具体实现</li>
<li><code>AppInit</code>类：负责应用的初始化流程编排，不关心各模块的内部实现细节</li>
</ul>
<p>这种分层使得每个模块的代码更加内聚，修改某一层的实现不会影响其他层。比如我们后续如果要将键值数据库换成关系型数据库，只需要修改<code>KVDatabase</code>类的实现，而<code>NewsManager</code>和<code>AppInit</code>的代码无需改动。</p>
<p><strong>2. 代码复用性提升</strong></p>
<p>通过封装，我们避免了代码重复。比如<code>kvDatabase.getKVStoreById()</code>这个方法在项目中被多个Manager调用：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewsManager中使用</span></span><br><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> kvDatabase.<span class="title function_">getKVStoreById</span>(<span class="variable constant_">APP_KV_DB_ID</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 未来可能的UserManager中也会使用</span></span><br><span class="line"><span class="keyword">const</span> userStore = <span class="keyword">await</span> kvDatabase.<span class="title function_">getKVStoreById</span>(<span class="variable constant_">USER_KV_DB_ID</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ConfigManager中也会使用</span></span><br><span class="line"><span class="keyword">const</span> configStore = <span class="keyword">await</span> kvDatabase.<span class="title function_">getKVStoreById</span>(<span class="variable constant_">CONFIG_KV_DB_ID</span>)</span><br></pre></td></tr></table></figure>
<p>如果没有这层封装，每个Manager都需要重复编写获取数据库的逻辑、错误处理、日志记录等代码，这会导致大量的代码重复和维护困难。</p>
<p><strong>3. 错误处理的层次化</strong></p>
<p>每一层都可以根据自己的职责添加适当的错误处理策略：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第2层: KVDatabase - 捕获系统异常,返回null</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">getKVStoreById</span>(<span class="attr">storeId</span>:<span class="built_in">string</span>):<span class="title class_">Promise</span>&lt;distributedKVStore.<span class="property">SingleKVStore</span>|<span class="literal">null</span>&gt;&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> kVStore = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">kvManager</span>.<span class="title function_">getKVStore</span>(storeId,options)</span><br><span class="line">    <span class="keyword">return</span> kVStore</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    logger.<span class="title function_">error</span>(<span class="string">`获取KV数据库实例对象异常`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>  <span class="comment">// 转换异常为null值</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第3层: NewsManager - 检查null,返回boolean</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">init</span>(<span class="attr">context</span>: common.<span class="property">UIAbilityContext</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> kvDatabase.<span class="title function_">getKVStoreById</span>(<span class="variable constant_">APP_KV_DB_ID</span>)</span><br><span class="line">  <span class="keyword">if</span> (res) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">appKVDb</span> = res</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>  <span class="comment">// 将null转换为失败状态</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第4层: AppInit - 记录详细状态,影响整体初始化</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">initManagers</span>(<span class="attr">context</span>: common.<span class="property">UIAbilityContext</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> newsManagerInitSuccess = <span class="keyword">await</span> newsManager.<span class="title function_">init</span>(context)</span><br><span class="line">  <span class="keyword">if</span> (newsManagerInitSuccess) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">managers</span> = <span class="literal">true</span>  <span class="comment">// 记录到状态追踪</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    logger.<span class="title function_">error</span>(<span class="string">`新闻管理器初始化失败`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> newsManagerInitSuccess</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种层次化的错误处理使得异常可以在最合适的层级被处理，上层代码不需要关心底层的具体异常类型，只需要关心操作是否成功。</p>
<h6 id="负面影响"><a href="#负面影响" class="headerlink" title="负面影响"></a>负面影响</h6><p><strong>1. 性能开销</strong></p>
<p>每一层的封装都会带来一定的性能开销，主要体现在：</p>
<ul>
<li><strong>函数调用栈的增加</strong>：从<code>getKVStore</code>到最终的<code>initPhase1</code>，需要经过5层函数调用</li>
<li><strong>Promise链条的延长</strong>：每一层都是一个Promise，意味着至少5次的Promise状态转换</li>
<li><strong>错误处理的重复</strong>：每一层都可能有try-catch，增加了错误检查的次数</li>
</ul>
<p>不过在应用初始化这种非高频场景中，这些性能开销是可以接受的。如果是在高频调用的场景（比如滚动列表的渲染），就需要仔细权衡封装层次。</p>
<p><strong>2. 调试复杂度增加</strong></p>
<p>当出现问题时，需要逐层排查才能定位问题根源。比如当新闻管理器初始化失败时，可能的原因有：</p>
<ul>
<li>系统层：<code>kvManager.getKVStore()</code>调用失败</li>
<li>封装层：<code>KVDatabase</code>初始化失败，kvManager为null</li>
<li>业务层：storeId配置错误</li>
<li>调用层：context传递错误</li>
</ul>
<p>需要通过日志输出才能快速定位问题所在的层级，这就是为什么我们在每一层都添加了详细的日志记录。</p>
<p><strong>3. 异步链条的传播效应</strong></p>
<p>这是最重要也是最容易被忽视的影响。一旦底层函数是异步的，整个调用链条都会变成异步：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 底层是异步的</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">getKVStore</span>() -&gt; <span class="title class_">Promise</span>&lt;T&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导致所有上层都必须是异步的</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">getKVStoreById</span>() -&gt; <span class="title class_">Promise</span>&lt;<span class="title class_">SingleKVStore</span>|<span class="literal">null</span>&gt;</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">init</span>() -&gt; <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt;</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">initManagers</span>() -&gt; <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt;</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">initPhase1_BaseModules</span>() -&gt; <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 甚至影响到调用方</span></span><br><span class="line"><span class="title function_">onCreate</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 必须使用异步方式调用</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">phase1Promise</span> = appInit.<span class="title function_">initPhase1_BaseModules</span>(<span class="variable language_">this</span>.<span class="property">context</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种”异步传染”是不可避免的，一旦某个底层函数返回Promise，所有依赖它的上层函数都必须处理这个异步性。</p>
<h5 id="层层封装对异步管理的影响"><a href="#层层封装对异步管理的影响" class="headerlink" title="层层封装对异步管理的影响"></a>层层封装对异步管理的影响</h5><h6 id="1-异步操作的串行化"><a href="#1-异步操作的串行化" class="headerlink" title="1. 异步操作的串行化"></a>1. 异步操作的串行化</h6><p>由于每一层都依赖于下一层的执行结果，这些异步操作必然是串行执行的：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">initPhase1_BaseModules</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 步骤1: 初始化数据库 (异步)</span></span><br><span class="line">  <span class="keyword">const</span> dbInitSuccess = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">initDatabases</span>(uiAbilityContext)</span><br><span class="line">  <span class="keyword">if</span> (!dbInitSuccess) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 步骤2: 加载用户配置 (同步,但依赖步骤1)</span></span><br><span class="line">  <span class="keyword">const</span> configInitSuccess = <span class="variable language_">this</span>.<span class="title function_">initUserConfig</span>(uiAbilityContext)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 步骤3: 初始化管理器 (异步,依赖步骤1)</span></span><br><span class="line">  <span class="keyword">const</span> managersInitSuccess = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">initManagers</span>(uiAbilityContext)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 步骤4: 预加载数据 (异步,依赖步骤3)</span></span><br><span class="line">  <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">preloadData</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>虽然我们使用了<code>await</code>来等待异步操作完成，但这种串行化也意味着总耗时是所有步骤耗时的总和。如果某个步骤耗时较长，会直接影响整体的初始化速度。</p>
<h6 id="2-异步操作的并行优化"><a href="#2-异步操作的并行优化" class="headerlink" title="2. 异步操作的并行优化"></a>2. 异步操作的并行优化</h6><p>在层层封装的架构下，我们仍然可以在合适的层级引入并行优化。比如在<code>preloadData()</code>中：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">preloadData</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 使用Promise.all实现并行加载</span></span><br><span class="line">    <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">      newsManager.<span class="title function_">updateNewsListToDB</span>(),</span><br><span class="line">      newsManager.<span class="title function_">updateNewsSwiperToDB</span>()</span><br><span class="line">    ]).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`数据预加载完成`</span>)</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">error</span>: <span class="title class_">Error</span></span>) =&gt;</span> &#123;</span><br><span class="line">      logger.<span class="title function_">warn</span>(<span class="string">`数据预加载失败: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    logger.<span class="title function_">warn</span>(<span class="string">`数据预加载异常: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们使用<code>Promise.all()</code>让新闻列表和轮播图的加载并行进行，而不是串行等待。这种优化可以在不破坏封装结构的前提下提升性能。</p>
<p>这里我们额外添加一些针对于<code>Promise.all()</code>的原理解析：</p>
<p><strong>Promise.all()的工作机制</strong></p>
<p><code>Promise.all()</code>是JavaScript/TypeScript中用于处理多个异步操作的静态方法，它的核心特点是：</p>
<ol>
<li><strong>并行启动</strong>：接收一个Promise数组，会立即启动所有Promise，而不是等待前一个完成</li>
<li><strong>全部等待</strong>：等待数组中所有Promise都resolve后才返回结果</li>
<li><strong>快速失败</strong>：只要有一个Promise reject，整个Promise.all()就会立即reject</li>
</ol>
<p>让我们通过代码对比来理解串行与并行的区别：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 串行执行：总耗时 = 耗时1 + 耗时2</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">serialLoad</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> startTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 第一个请求：假设耗时2秒</span></span><br><span class="line">  <span class="keyword">const</span> newsList = <span class="keyword">await</span> newsManager.<span class="title function_">updateNewsListToDB</span>()  </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`新闻列表加载完成: <span class="subst">$&#123;<span class="built_in">Date</span>.now() - startTime&#125;</span>ms`</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 第二个请求：假设耗时1.5秒</span></span><br><span class="line">  <span class="keyword">const</span> swiper = <span class="keyword">await</span> newsManager.<span class="title function_">updateNewsSwiperToDB</span>()   </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`轮播图加载完成: <span class="subst">$&#123;<span class="built_in">Date</span>.now() - startTime&#125;</span>ms`</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 总耗时约：2000ms + 1500ms = 3500ms</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`串行总耗时: <span class="subst">$&#123;<span class="built_in">Date</span>.now() - startTime&#125;</span>ms`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 并行执行：总耗时 = max(耗时1, 耗时2)</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">parallelLoad</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> startTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 两个请求同时发起</span></span><br><span class="line">  <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    newsManager.<span class="title function_">updateNewsListToDB</span>(),    <span class="comment">// 耗时2秒</span></span><br><span class="line">    newsManager.<span class="title function_">updateNewsSwiperToDB</span>()   <span class="comment">// 耗时1.5秒</span></span><br><span class="line">  ])</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 总耗时约：max(2000ms, 1500ms) = 2000ms</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`并行总耗时: <span class="subst">$&#123;<span class="built_in">Date</span>.now() - startTime&#125;</span>ms`</span>)</span><br><span class="line">  <span class="comment">// 性能提升：(3500-2000)/3500 = 42.8%</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在我们的实际场景中，如果新闻列表加载需要800ms，轮播图加载需要600ms：</p>
<ul>
<li><strong>串行执行</strong>：总耗时 = 800ms + 600ms = 1400ms</li>
<li><strong>并行执行</strong>：总耗时 = max(800ms, 600ms) = 800ms</li>
<li><strong>性能提升</strong>：约43%的启动速度提升</li>
</ul>
<p><strong>Promise.all()的内部执行流程</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Promise.all()的简化实现原理</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">promiseAll</span>(<span class="params"><span class="attr">promises</span>: <span class="title class_">Promise</span>&lt;<span class="built_in">any</span>&gt;[]</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">any</span>[]&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">results</span>: <span class="built_in">any</span>[] = []</span><br><span class="line">    <span class="keyword">let</span> completedCount = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 关键：立即启动所有Promise</span></span><br><span class="line">    promises.<span class="title function_">forEach</span>(<span class="function">(<span class="params">promise, index</span>) =&gt;</span> &#123;</span><br><span class="line">      promise</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">          results[index] = value  <span class="comment">// 保持结果顺序</span></span><br><span class="line">          completedCount++</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 所有Promise都完成时，resolve整体结果</span></span><br><span class="line">          <span class="keyword">if</span> (completedCount === promises.<span class="property">length</span>) &#123;</span><br><span class="line">            <span class="title function_">resolve</span>(results)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 任何一个Promise失败，立即reject</span></span><br><span class="line">          <span class="title function_">reject</span>(error)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从这个实现可以看出几个关键点：</p>
<ol>
<li><strong>立即执行</strong>：<code>forEach</code>会立即遍历所有Promise，触发它们的执行，而不是等待前一个完成</li>
<li><strong>结果顺序</strong>：通过<code>results[index]</code>保证返回结果的顺序与输入顺序一致，即使某个Promise先完成</li>
<li><strong>计数机制</strong>：通过<code>completedCount</code>追踪已完成的Promise数量</li>
<li><strong>快速失败</strong>：任何一个Promise的reject都会导致整体reject，不会等待其他Promise</li>
</ol>
<p><strong>在我们项目中的实际应用</strong></p>
<p>回到我们的<code>preloadData()</code>方法：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">preloadData</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">      newsManager.<span class="title function_">updateNewsListToDB</span>(),</span><br><span class="line">      newsManager.<span class="title function_">updateNewsSwiperToDB</span>()</span><br><span class="line">    ]).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`数据预加载完成`</span>)</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">error</span>: <span class="title class_">Error</span></span>) =&gt;</span> &#123;</span><br><span class="line">      logger.<span class="title function_">warn</span>(<span class="string">`数据预加载失败: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    logger.<span class="title function_">warn</span>(<span class="string">`数据预加载异常: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里有一个值得注意的设计细节：我们<strong>没有使用await</strong>来等待<code>Promise.all()</code>：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当前实现：不阻塞主流程</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([...]).<span class="title function_">then</span>(...)  <span class="comment">// 异步执行，立即返回</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果使用await：会阻塞主流程</span></span><br><span class="line"><span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([...])  <span class="comment">// 必须等待完成才能继续</span></span><br></pre></td></tr></table></figure>
<p>这样做的原因是：</p>
<ul>
<li>数据预加载属于<strong>非关键路径</strong>，失败不应该阻止应用启动</li>
<li>用户可以先看到界面，数据稍后加载完成后再显示</li>
<li>如果网络较慢，不会让用户等待过长时间才看到界面</li>
</ul>
<p><strong>Promise.all()的风险与替代方案</strong></p>
<p>虽然<code>Promise.all()</code>很强大，但也有其局限性：</p>
<p><strong>风险1：一个失败导致全部失败</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果新闻列表加载失败，轮播图即使成功也会被忽略</span></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">  newsManager.<span class="title function_">updateNewsListToDB</span>(),  <span class="comment">// 失败</span></span><br><span class="line">  newsManager.<span class="title function_">updateNewsSwiperToDB</span>() <span class="comment">// 成功但被忽略</span></span><br><span class="line">]).<span class="title function_">catch</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 整体失败，无法获取轮播图数据</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>解决方案：使用Promise.allSettled()</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Promise.allSettled()会等待所有Promise完成，不管成功还是失败</span></span><br><span class="line"><span class="keyword">const</span> results = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">allSettled</span>([</span><br><span class="line">  newsManager.<span class="title function_">updateNewsListToDB</span>(),</span><br><span class="line">  newsManager.<span class="title function_">updateNewsSwiperToDB</span>()</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">results.<span class="title function_">forEach</span>(<span class="function">(<span class="params">result, index</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (result.<span class="property">status</span> === <span class="string">&#x27;fulfilled&#x27;</span>) &#123;</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`任务<span class="subst">$&#123;index&#125;</span>成功: <span class="subst">$&#123;result.value&#125;</span>`</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    logger.<span class="title function_">warn</span>(<span class="string">`任务<span class="subst">$&#123;index&#125;</span>失败: <span class="subst">$&#123;result.reason&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>这种方式更加健壮，即使某个数据源失败，其他数据仍然可以正常显示。</p>
<p><strong>风险2：并发请求过多导致资源竞争</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不好的做法：同时发起100个请求</span></span><br><span class="line"><span class="keyword">const</span> promises = []</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">  promises.<span class="title function_">push</span>(<span class="title function_">fetchData</span>(i))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(promises)  <span class="comment">// 可能导致浏览器/服务器崩溃</span></span><br></pre></td></tr></table></figure>
<p><strong>解决方案：分批执行</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 好的做法：每次最多5个并发</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">batchLoad</span>(<span class="params"><span class="attr">tasks</span>: <span class="title class_">Function</span>[], <span class="attr">concurrency</span>: <span class="built_in">number</span> = <span class="number">5</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">results</span>: <span class="built_in">any</span>[] = []</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; tasks.<span class="property">length</span>; i += concurrency) &#123;</span><br><span class="line">    <span class="keyword">const</span> batch = tasks.<span class="title function_">slice</span>(i, i + concurrency)</span><br><span class="line">    <span class="keyword">const</span> batchResults = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(batch.<span class="title function_">map</span>(<span class="function"><span class="params">task</span> =&gt;</span> <span class="title function_">task</span>()))</span><br><span class="line">    results.<span class="title function_">push</span>(...batchResults)</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`完成批次 <span class="subst">$&#123;i / concurrency + <span class="number">1</span>&#125;</span>，已加载 <span class="subst">$&#123;results.length&#125;</span>/<span class="subst">$&#123;tasks.length&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> results</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>性能监控与调优</strong></p>
<p>在实际开发中，我们可以添加性能监控来验证并行优化的效果：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">async</span> <span class="title function_">preloadData</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> startTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> promises = [</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">measureTime</span>(<span class="string">&#x27;新闻列表&#x27;</span>, newsManager.<span class="title function_">updateNewsListToDB</span>()),</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">measureTime</span>(<span class="string">&#x27;轮播图&#x27;</span>, newsManager.<span class="title function_">updateNewsSwiperToDB</span>())</span><br><span class="line">    ]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>(promises)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> totalTime = <span class="title class_">Date</span>.<span class="title function_">now</span>() - startTime</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>数据预加载完成，总耗时: <span class="subst">$&#123;totalTime&#125;</span>ms`</span>)</span><br><span class="line">    </span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>数据预加载失败: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 辅助方法：测量单个任务的执行时间</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">async</span> measureTime&lt;T&gt;(<span class="attr">taskName</span>: <span class="built_in">string</span>, <span class="attr">promise</span>: <span class="title class_">Promise</span>&lt;T&gt;): <span class="title class_">Promise</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> start = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> promise</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span><span class="subst">$&#123;taskName&#125;</span> 完成，耗时: <span class="subst">$&#123;<span class="built_in">Date</span>.now() - start&#125;</span>ms`</span>)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span><span class="subst">$&#123;taskName&#125;</span> 失败，耗时: <span class="subst">$&#123;<span class="built_in">Date</span>.now() - start&#125;</span>ms`</span>)</span><br><span class="line">    <span class="keyword">throw</span> error</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过这样的监控，我们可以在开发阶段就发现性能瓶颈，并针对性地进行优化。</p>
<p><strong>小结</strong></p>
<p><code>Promise.all()</code>是异步编程中非常重要的工具，它让我们能够在保持代码清晰度的同时显著提升性能。关键要点：</p>
<ol>
<li><strong>适用场景</strong>：多个独立的异步操作，彼此之间没有依赖关系</li>
<li><strong>性能收益</strong>：总耗时从所有任务之和降低到最慢任务的耗时</li>
<li><strong>错误处理</strong>：需要考虑部分失败的情况，必要时使用<code>Promise.allSettled()</code></li>
<li><strong>并发控制</strong>：大量并发请求时要考虑分批执行，避免资源耗尽</li>
<li><strong>监控调优</strong>：添加性能监控，用数据驱动优化决策</li>
</ol>
<p>关键点在于识别哪些操作是可以并行的：</p>
<ul>
<li><strong>数据库初始化和用户配置加载</strong>：不能并行，因为配置加载依赖数据库</li>
<li><strong>新闻列表和轮播图加载</strong>：可以并行，它们之间没有依赖关系</li>
</ul>
<p>这也是我之前所提到的拓扑学，我们需要理清楚各个模块之间的依赖关系，才能设计出合理的并行策略。</p>
<h6 id="3-异步状态的管理复杂度"><a href="#3-异步状态的管理复杂度" class="headerlink" title="3. 异步状态的管理复杂度"></a>3. 异步状态的管理复杂度</h6><p>在多层异步调用中，状态管理变得更加复杂。我们需要追踪每一层的执行状态：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="attr">initStatus</span>: <span class="title class_">InitStatus</span> = &#123;</span><br><span class="line">  <span class="attr">databases</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">userConfig</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">managers</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">appStorageV2</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">markdown</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个状态对象需要在合适的时机更新，但由于异步操作的存在，更新时机很容易出错：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误示例: 在异步操作完成前就标记为成功</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">initManagers</span>(<span class="params"></span>) &#123;</span><br><span class="line">  newsManager.<span class="title function_">init</span>(context)  <span class="comment">// 忘记await</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">managers</span> = <span class="literal">true</span>  <span class="comment">// 错误!此时init可能还未完成</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确示例: 等待异步操作完成后再更新状态</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">initManagers</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> success = <span class="keyword">await</span> newsManager.<span class="title function_">init</span>(context)  <span class="comment">// 正确使用await</span></span><br><span class="line">  <span class="keyword">if</span> (success) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">managers</span> = <span class="literal">true</span>  <span class="comment">// 此时可以确保init已完成</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> success</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-异步链条中的错误传播"><a href="#4-异步链条中的错误传播" class="headerlink" title="4. 异步链条中的错误传播"></a>4. 异步链条中的错误传播</h6><p>在层层封装的异步调用中，错误的传播路径需要精心设计：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 底层抛出异常</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">getKVStore</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Database connection failed&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 中间层捕获并转换</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">getKVStoreById</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">kvManager</span>.<span class="title function_">getKVStore</span>(storeId, options)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    logger.<span class="title function_">error</span>(<span class="string">`获取KV数据库异常`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>  <span class="comment">// 转换为null,不继续向上抛异常</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上层检查null值</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">init</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> kvDatabase.<span class="title function_">getKVStoreById</span>(<span class="variable constant_">APP_KV_DB_ID</span>)</span><br><span class="line">  <span class="keyword">if</span> (res) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>  <span class="comment">// 将null转换为false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最上层处理false值</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">initPhase1</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> dbInitSuccess = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">initDatabases</span>(context)</span><br><span class="line">  <span class="keyword">if</span> (!dbInitSuccess) &#123;</span><br><span class="line">    logger.<span class="title function_">error</span>(<span class="string">`数据库初始化失败,终止初始化流程`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>  <span class="comment">// 向调用者返回失败状态</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种设计模式将异常转换为返回值，使得错误处理更加可控，避免了未捕获异常导致的应用崩溃。但代价是需要在每一层都进行状态检查。</p>
<h4 id="实践经验总结"><a href="#实践经验总结" class="headerlink" title="实践经验总结"></a>实践经验总结</h4><p>通过这次AppInit的重构和异步管理的实践，我总结出以下几点经验：</p>
<p><strong>1. 封装层次要适度</strong></p>
<p>不是封装层次越多越好，也不是越少越好。关键是每一层都要有其存在的价值：</p>
<ul>
<li>如果某一层只是简单的转发调用，没有添加任何额外逻辑，那这一层可能是多余的</li>
<li>如果某一层承担了过多的职责，那可能需要进一步拆分</li>
</ul>
<p><strong>2. 异步操作要明确标注</strong></p>
<p>在ts和ArkTS中，一定要明确标注函数的返回类型：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 好的做法: 明确标注返回Promise&lt;boolean&gt;</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">init</span>(<span class="attr">context</span>: common.<span class="property">UIAbilityContext</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 不好的做法: 依赖类型推断</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">init</span>(<span class="attr">context</span>: common.<span class="property">UIAbilityContext</span>)  <span class="comment">// 返回类型不明确</span></span><br></pre></td></tr></table></figure>
<p>明确的类型标注可以帮助IDE提供更好的代码补全，也能让其他开发者一眼看出这是一个异步函数。</p>
<p><strong>3. 日志记录要分层详细</strong></p>
<p>每一层都应该有自己的日志记录，且要包含足够的上下文信息：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.APP_INIT&#125;</span>步骤 1/4: 初始化数据库模块...`</span>)</span><br><span class="line">logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.KV_DATABASE&#125;</span>成功获取storeId:<span class="subst">$&#123;storeId&#125;</span>数据库实例对象`</span>)</span><br><span class="line">logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>init: 获取appKVDb成功`</span>)</span><br></pre></td></tr></table></figure>
<p>通过不同的LOG_TAG和详细的描述，可以快速定位问题所在的层级。</p>
<p><strong>4. 状态管理要及时准确</strong></p>
<p>在异步操作完成后立即更新状态，不要延迟，这也包含了数据库中所学的原子化操作的思想，我们虽然不可能在异步操作执行成功的“时刻”进行分秒不差的同步状态更新，但我们可以将操作完成到状态更新之间的操作尽可能的缩小，压缩到所有操作产生的延时都可以小到忽略不计，将任务对象与其状态标识符进行“强绑定”：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> newsManagerInitSuccess = <span class="keyword">await</span> newsManager.<span class="title function_">init</span>(context)</span><br><span class="line"><span class="keyword">if</span> (newsManagerInitSuccess) &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">initStatus</span>.<span class="property">managers</span> = <span class="literal">true</span>  <span class="comment">// 立即更新状态</span></span><br><span class="line">  logger.<span class="title function_">info</span>(<span class="string">`新闻管理器初始化成功`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>5. 要为异步操作预留缓冲时间</strong></p>
<p>如同我们在<code>printFinalInitStatus()</code>中使用<code>setTimeout</code>一样，要考虑到异步操作的不确定性：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">printFinalInitStatus</span>()</span><br><span class="line">&#125;, <span class="number">100</span>) <span class="comment">// 给异步操作留出完成时间</span></span><br></pre></td></tr></table></figure>
<p>这种设计虽然看起来不够优雅，但在复杂的异步场景中是必要的容错机制。</p>
<h5 id="对于AI辅助开发的思考"><a href="#对于AI辅助开发的思考" class="headerlink" title="对于AI辅助开发的思考"></a>对于AI辅助开发的思考</h5><p>在这次重构中，Claude提供的代码质量确实很高，但也暴露了一些AI的局限性：</p>
<ol>
<li><strong>AI对异步执行顺序的理解有限</strong>：最初的版本没有考虑到异步操作可能晚于状态打印执行的问题，需要人工发现并修复</li>
<li><strong>AI倾向于过度工程化</strong>：生成的代码注释非常详细，封装层次也很完整，但可能对小型项目来说过于复杂</li>
<li><strong>AI缺乏实际运行环境的感知</strong>：只有在真实设备上运行才能发现日志顺序的问题</li>
</ol>
<p>因此，AI辅助开发的最佳实践应该是：<strong>AI负责生成规范化的代码框架，人类负责根据实际运行情况进行调优</strong>。就像这次重构，Claude提供了优秀的架构设计和详细的注释，而我通过实际测试发现并修复了异步执行顺序的问题，两者结合才能产出高质量的代码。</p>
<hr>
<h3 id="对于加载数据流的改造"><a href="#对于加载数据流的改造" class="headerlink" title="对于加载数据流的改造"></a>对于加载数据流的改造</h3><h4 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h4><p>当下我面临的另一个严峻的问题就在于数据源的加载速度过慢。这一方面是我的服务器仅仅是暂时共享了我的博客服务器，属于是最基础的一档服务器，带宽很小，另外一方面是在于我当下使用的是<code>/api/news/?all=true</code>这样一个最基本的接口，他会默认的将全部的数据不加分类不加分页的一口气全部发送过来，这就导致数十M的数据在我服务器本就局限的带宽上跑的愈发缓慢了，我绝对不能放开带宽限制，要不然单词更新就会将我服务器的下行带宽完全堵死。不过后面完成后部署到中软那边的服务器应该就不会出现这个问题了。</p>
<p>但在当前环境下，我的单次刷新会长达20秒左右的加载时间，对于首次启动会是一个比较致命的问题，毕竟启动页的延时是远远不够加载全部数据的，在首次渲染时注定是没有数据的。首先这个接口并不是流式输出接口，我们必须等待这个接口的单次响应被完整的接收后才会开始去进行数据库数据的更新以及渲染数据的更新。</p>
<p>为了解决这个问题，我首先想到的是进行分页处理，对于数据进行分页获取处理，通过<code>page_size</code>和<code>page</code>，两个参数来去进行数据的分页，在单次响应中会包含有<code>&quot;has_next&quot;&quot;has_prev&quot;</code>这样两个参数来为客户端的数据流提供结束标识符。对于最后一页的数据可能会出现page_size的大小比剩余的数据量大的情况，这种情况在我的后端中是会自动的去处理的并不会出现越界的异常，所以我们前端的分页数据流仅需要停止在当<code>&quot;has_next&quot;</code>为false时去终止即可。</p>
<p>对于这种方式因为中间会加入很多的确认是否完整获取，以及当前数据处于整段数据流中的什么位置的流程，这都是为了保证在更新数据库数据时能够正确的按照后端排好的日期顺序去进行存入，所以整体的获取时间会被拉长，但是在前台也就是用户能感知的到的流程上来看是可以被压缩到一秒到两秒之内就完成的，因为我们可以将当前显示的数据的前20条更新为最新后就结束<code>Refresh</code>组件的<code>onRefreshing</code>流程，随后我们就会在后台去进行完整的数据获取流程，将这个流程统一的压缩至一个函数中进行控制，仅需要修改一个<code>Refresh</code>组件的标识符就可以完成用户感知层面的提速。</p>
<p>接下来我们来看一下这个关键函数的实现吧。</p>
<h4 id="核心函数解析"><a href="#核心函数解析" class="headerlink" title="核心函数解析"></a>核心函数解析</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 两阶段刷新 - 第一阶段：快速加载各分栏前20条最新数据</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 使用 Promise.all 并发加载所有已开发栏目的前20条数据，快速响应用户</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> Promise&lt;&#123; success: boolean, loadedCount: number &#125;&gt; - 加载结果和成功加载的栏目数</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 刷新策略：</span></span><br><span class="line"><span class="comment">   * - 仅加载已开发的栏目（isDeveloped === true）</span></span><br><span class="line"><span class="comment">   * - 每个栏目获取最新 20 条数据</span></span><br><span class="line"><span class="comment">   * - 使用 Promise.all 并发请求，最大化速度</span></span><br><span class="line"><span class="comment">   * - 单个栏目失败不影响其他栏目</span></span><br><span class="line"><span class="comment">   * - 同时刷新轮播图数据</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 适用场景：</span></span><br><span class="line"><span class="comment">   * - 用户下拉刷新时的第一阶段</span></span><br><span class="line"><span class="comment">   * - 需要快速看到最新内容</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment">   * ```typescript</span></span><br><span class="line"><span class="comment">   * const result = await newsManager.quickRefreshCategories()</span></span><br><span class="line"><span class="comment">   * if (result.success) &#123;</span></span><br><span class="line"><span class="comment">   *   console.log(`快速刷新完成，加载了 $&#123;result.loadedCount&#125; 个栏目`)</span></span><br><span class="line"><span class="comment">   * &#125;</span></span><br><span class="line"><span class="comment">   * ```</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">quickRefreshCategories</span>(): <span class="title class_">Promise</span>&lt;<span class="title class_">QuickRefreshResult</span>&gt; &#123;</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] 开始第一阶段：并发加载各分栏前20条数据`</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!(<span class="keyword">await</span> <span class="title class_">ServerHealthAPI</span>.<span class="title function_">isServerReady</span>())) &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] 服务端未就绪`</span>)</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">QuickRefreshResult</span> = &#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">loadedCount</span>: <span class="number">0</span> &#125;</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">appKVDb</span>) &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] 数据库未初始化`</span>)</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">QuickRefreshResult</span> = &#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">loadedCount</span>: <span class="number">0</span> &#125;</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> startTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 筛选出已开发的栏目</span></span><br><span class="line">      <span class="keyword">const</span> developedCategories = <span class="variable constant_">NEWS_CATEGORIES</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">cat</span> =&gt;</span> cat.<span class="property">isDeveloped</span>)</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] 需要刷新 <span class="subst">$&#123;developedCategories.length&#125;</span> 个栏目`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 创建并发加载任务数组</span></span><br><span class="line">      <span class="keyword">const</span> loadTasks = developedCategories.<span class="title function_">map</span>(<span class="title function_">async</span> (<span class="attr">category</span>: <span class="title class_">NewsCategoryInfo</span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          logger.<span class="title function_">debug</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] 开始加载【<span class="subst">$&#123;category.displayName&#125;</span>】前20条`</span>)</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 调用分类 API 获取前20条数据</span></span><br><span class="line">          <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title class_">NewsListAPI</span>.<span class="title function_">getNewsByCategory</span>(category.<span class="property">apiCategory</span>, <span class="number">1</span>, <span class="number">20</span>)</span><br><span class="line">          </span><br><span class="line">          <span class="keyword">if</span> (response &amp;&amp; response.<span class="property">articles</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 读取现有数据</span></span><br><span class="line">            <span class="keyword">let</span> <span class="attr">existingArticles</span>: <span class="title class_">NewsArticle</span>[] = []</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">const</span> existingData = (<span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">appKVDb</span>!.<span class="title function_">get</span>(category.<span class="property">dbKey</span>)) <span class="keyword">as</span> <span class="built_in">string</span></span><br><span class="line">              existingArticles = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(existingData) <span class="keyword">as</span> <span class="title class_">NewsArticle</span>[]</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">              existingArticles = []</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 合并去重（新数据优先）</span></span><br><span class="line">            <span class="keyword">const</span> articleMap = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">NewsArticle</span>&gt;()</span><br><span class="line">            existingArticles.<span class="title function_">forEach</span>(<span class="function"><span class="params">article</span> =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (article.<span class="property">id</span>) articleMap.<span class="title function_">set</span>(article.<span class="property">id</span>, article)</span><br><span class="line">            &#125;)</span><br><span class="line">            response.<span class="property">articles</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">article</span> =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (article.<span class="property">id</span>) articleMap.<span class="title function_">set</span>(article.<span class="property">id</span>, article)</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 按日期倒序排序</span></span><br><span class="line">            <span class="keyword">const</span> mergedArticles = <span class="title class_">Array</span>.<span class="title function_">from</span>(articleMap.<span class="title function_">values</span>())</span><br><span class="line">              .<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> b.<span class="property">date</span>.<span class="title function_">localeCompare</span>(a.<span class="property">date</span>))</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 写入数据库</span></span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">appKVDb</span>!.<span class="title function_">put</span>(category.<span class="property">dbKey</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(mergedArticles))</span><br><span class="line">            </span><br><span class="line">            logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] ✓ 【<span class="subst">$&#123;category.displayName&#125;</span>】加载成功: <span class="subst">$&#123;response.articles.length&#125;</span>条`</span>)</span><br><span class="line">            <span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">CategoryLoadResult</span> = &#123; <span class="attr">category</span>: category.<span class="property">displayName</span>, <span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">count</span>: response.<span class="property">articles</span>.<span class="property">length</span> &#125;</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] 【<span class="subst">$&#123;category.displayName&#125;</span>】无数据`</span>)</span><br><span class="line">            <span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">CategoryLoadResult</span> = &#123; <span class="attr">category</span>: category.<span class="property">displayName</span>, <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">count</span>: <span class="number">0</span> &#125;</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">          logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] 【<span class="subst">$&#123;category.displayName&#125;</span>】加载失败: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">          <span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">CategoryLoadResult</span> = &#123; <span class="attr">category</span>: category.<span class="property">displayName</span>, <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">count</span>: <span class="number">0</span> &#125;</span><br><span class="line">          <span class="keyword">return</span> result</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 同时加载轮播图数据</span></span><br><span class="line">      <span class="keyword">const</span> swiperTask = <span class="variable language_">this</span>.<span class="title function_">updateNewsSwiperToDB</span>()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 并发执行所有任务</span></span><br><span class="line">      <span class="keyword">const</span> results = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([...loadTasks, swiperTask])</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 统计结果（最后一个是轮播图任务）</span></span><br><span class="line">      <span class="keyword">const</span> categoryResults = results.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>) <span class="keyword">as</span> <span class="title class_">CategoryLoadResult</span>[]</span><br><span class="line">      <span class="keyword">const</span> swiperSuccess = results[results.<span class="property">length</span> - <span class="number">1</span>] <span class="keyword">as</span> <span class="built_in">boolean</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">const</span> successCount = categoryResults.<span class="title function_">filter</span>(<span class="function"><span class="params">r</span> =&gt;</span> r.<span class="property">success</span>).<span class="property">length</span></span><br><span class="line">      <span class="keyword">const</span> totalArticles = categoryResults.<span class="title function_">reduce</span>(<span class="function">(<span class="params">sum, r</span>) =&gt;</span> sum + r.<span class="property">count</span>, <span class="number">0</span>)</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">const</span> endTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">      <span class="keyword">const</span> duration = endTime - startTime</span><br><span class="line"></span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] ✓ 第一阶段完成: <span class="subst">$&#123;successCount&#125;</span>/<span class="subst">$&#123;developedCategories.length&#125;</span> 个栏目成功, 共<span class="subst">$&#123;totalArticles&#125;</span>条数据, 耗时<span class="subst">$&#123;duration&#125;</span>ms`</span>)</span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] 轮播图刷新: <span class="subst">$&#123;swiperSuccess ? <span class="string">&#x27;成功&#x27;</span> : <span class="string">&#x27;失败&#x27;</span>&#125;</span>`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> <span class="attr">finalResult</span>: <span class="title class_">QuickRefreshResult</span> = &#123; </span><br><span class="line">        <span class="attr">success</span>: successCount &gt; <span class="number">0</span>, </span><br><span class="line">        <span class="attr">loadedCount</span>: successCount </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> finalResult</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="keyword">let</span> err = error <span class="keyword">as</span> <span class="title class_">BusinessError</span></span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] 异常: <span class="subst">$&#123;err.message&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">QuickRefreshResult</span> = &#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">loadedCount</span>: <span class="number">0</span> &#125;</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 两阶段刷新 - 第二阶段：后台完整加载所有分栏数据</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 在后台逐个加载各栏目的全部数据，并提供进度回调实时更新 UI</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">onProgress</span> - 进度回调函数，参数为 &#123; category: 栏目名, current: 当前进度, total: 总数 &#125;</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> Promise&lt;&#123; success: boolean, updatedCount: number &#125;&gt; - 加载结果和成功更新的栏目数</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment">   * 刷新策略：</span></span><br><span class="line"><span class="comment">   * - 后台逐个加载已开发栏目的全部数据</span></span><br><span class="line"><span class="comment">   * - 每个栏目完成后立即回调，通知 UI 更新</span></span><br><span class="line"><span class="comment">   * - 单个栏目失败不影响其他栏目</span></span><br><span class="line"><span class="comment">   * - 按日期倒序排序后存储</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 适用场景：</span></span><br><span class="line"><span class="comment">   * - 快速刷新完成后的后台任务</span></span><br><span class="line"><span class="comment">   * - 确保数据完整性和最新性</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment">   * ```typescript</span></span><br><span class="line"><span class="comment">   * newsManager.fullRefreshCategories((progress) =&gt; &#123;</span></span><br><span class="line"><span class="comment">   *   console.log(`$&#123;progress.category&#125;: $&#123;progress.current&#125;/$&#123;progress.total&#125;`)</span></span><br><span class="line"><span class="comment">   * &#125;).then(result =&gt; &#123;</span></span><br><span class="line"><span class="comment">   *   console.log(`完整刷新完成，更新了 $&#123;result.updatedCount&#125; 个栏目`)</span></span><br><span class="line"><span class="comment">   * &#125;)</span></span><br><span class="line"><span class="comment">   * ```</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">fullRefreshCategories</span>(</span><br><span class="line">    <span class="attr">onProgress</span>?: <span class="function">(<span class="params"><span class="attr">progress</span>: <span class="title class_">RefreshProgress</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">  ): <span class="title class_">Promise</span>&lt;<span class="title class_">FullRefreshResult</span>&gt; &#123;</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[完整刷新] 开始第二阶段：后台加载全部分栏数据`</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(<span class="keyword">await</span> <span class="title class_">ServerHealthAPI</span>.<span class="title function_">isServerReady</span>())) &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[完整刷新] 服务端未就绪`</span>)</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">FullRefreshResult</span> = &#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">updatedCount</span>: <span class="number">0</span> &#125;</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">appKVDb</span>) &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[完整刷新] 数据库未初始化`</span>)</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">FullRefreshResult</span> = &#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">updatedCount</span>: <span class="number">0</span> &#125;</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> startTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">      <span class="keyword">const</span> developedCategories = <span class="variable constant_">NEWS_CATEGORIES</span>.<span class="title function_">filter</span>(<span class="function"><span class="params">cat</span> =&gt;</span> cat.<span class="property">isDeveloped</span>)</span><br><span class="line">      <span class="keyword">const</span> totalCategories = developedCategories.<span class="property">length</span></span><br><span class="line">      <span class="keyword">let</span> updatedCount = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 逐个加载栏目（避免并发过多导致服务器压力）</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; developedCategories.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> category = developedCategories[i]</span><br><span class="line">        <span class="keyword">const</span> current = i + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[完整刷新] [<span class="subst">$&#123;current&#125;</span>/<span class="subst">$&#123;totalCategories&#125;</span>] 加载【<span class="subst">$&#123;category.displayName&#125;</span>】全部数据`</span>)</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 获取该分类的所有数据</span></span><br><span class="line">          <span class="keyword">const</span> allNews = <span class="keyword">await</span> <span class="title class_">NewsListAPI</span>.<span class="title function_">getAllNewsByCategory</span>(category.<span class="property">apiCategory</span>)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (allNews &amp;&amp; allNews.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 按日期倒序排序</span></span><br><span class="line">            <span class="keyword">const</span> sortedNews = allNews.<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> b.<span class="property">date</span>.<span class="title function_">localeCompare</span>(a.<span class="property">date</span>))</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 直接覆盖存储（已经是最新完整数据）</span></span><br><span class="line">            <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">appKVDb</span>.<span class="title function_">put</span>(category.<span class="property">dbKey</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(sortedNews))</span><br><span class="line">            </span><br><span class="line">            updatedCount++</span><br><span class="line">            logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[完整刷新] ✓ [<span class="subst">$&#123;current&#125;</span>/<span class="subst">$&#123;totalCategories&#125;</span>] 【<span class="subst">$&#123;category.displayName&#125;</span>】完成: <span class="subst">$&#123;sortedNews.length&#125;</span>条`</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 回调进度更新</span></span><br><span class="line">            <span class="keyword">if</span> (onProgress) &#123;</span><br><span class="line">              <span class="keyword">const</span> <span class="attr">progress</span>: <span class="title class_">RefreshProgress</span> = &#123;</span><br><span class="line">                <span class="attr">category</span>: category.<span class="property">displayName</span>,</span><br><span class="line">                <span class="attr">current</span>: current,</span><br><span class="line">                <span class="attr">total</span>: totalCategories</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="title function_">onProgress</span>(progress)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[完整刷新] [<span class="subst">$&#123;current&#125;</span>/<span class="subst">$&#123;totalCategories&#125;</span>] 【<span class="subst">$&#123;category.displayName&#125;</span>】无数据`</span>)</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">          logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[完整刷新] [<span class="subst">$&#123;current&#125;</span>/<span class="subst">$&#123;totalCategories&#125;</span>] 【<span class="subst">$&#123;category.displayName&#125;</span>】失败: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> endTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line">      <span class="keyword">const</span> duration = endTime - startTime</span><br><span class="line"></span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[完整刷新] ✓ 第二阶段完成: <span class="subst">$&#123;updatedCount&#125;</span>/<span class="subst">$&#123;totalCategories&#125;</span> 个栏目成功, 耗时<span class="subst">$&#123;duration&#125;</span>ms`</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> <span class="attr">finalResult</span>: <span class="title class_">FullRefreshResult</span> = &#123;</span><br><span class="line">        <span class="attr">success</span>: updatedCount &gt; <span class="number">0</span>,</span><br><span class="line">        <span class="attr">updatedCount</span>: updatedCount</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> finalResult</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="keyword">let</span> err = error <span class="keyword">as</span> <span class="title class_">BusinessError</span></span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[完整刷新] 异常: <span class="subst">$&#123;err.message&#125;</span>`</span>)</span><br><span class="line">      <span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">FullRefreshResult</span> = &#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">updatedCount</span>: <span class="number">0</span> &#125;</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 两阶段刷新数据</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 第一阶段：快速加载各分栏前20条 + 轮播图，立即结束刷新动画</span></span><br><span class="line"><span class="comment"> * 第二阶段：后台完整加载全部数据，实时更新 UI</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> Promise&lt;boolean&gt; - 第一阶段是否成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">reloadAllData</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">  logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] 开始刷新`</span>)</span><br><span class="line">  promptAction.<span class="title function_">openToast</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;正在快速刷新最新数据...&#x27;</span>, <span class="attr">duration</span>: <span class="number">1500</span> &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ========== 第一阶段：快速刷新（并发加载前20条） ==========</span></span><br><span class="line">    <span class="keyword">const</span> quickResult = <span class="keyword">await</span> newsManager.<span class="title function_">quickRefreshCategories</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (quickResult.<span class="property">success</span>) &#123;</span><br><span class="line">      <span class="comment">// 刷新成功，重新加载轮播图数据</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">newsSwiperData</span> = <span class="keyword">await</span> newsManager.<span class="title function_">getNewsSwiperDataFromDB</span>()</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 触发 NewsList 组件重新加载分类数据</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">refreshTrigger</span>++</span><br><span class="line">      </span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] ✓ 第一阶段完成: <span class="subst">$&#123;quickResult.loadedCount&#125;</span>个栏目`</span>)</span><br><span class="line">      promptAction.<span class="title function_">openToast</span>(&#123; </span><br><span class="line">        <span class="attr">message</span>: <span class="string">`刷新成功，已更新<span class="subst">$&#123;quickResult.loadedCount&#125;</span>个栏目`</span>, </span><br><span class="line">        <span class="attr">duration</span>: <span class="number">2000</span> </span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ========== 第二阶段：后台完整刷新（逐个加载全部数据） ==========</span></span><br><span class="line">      <span class="comment">// 不阻塞 UI，在后台执行</span></span><br><span class="line">      newsManager.<span class="title function_">fullRefreshCategories</span>(<span class="function">(<span class="params">progress</span>) =&gt;</span> &#123;</span><br><span class="line">        logger.<span class="title function_">debug</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] [<span class="subst">$&#123;progress.current&#125;</span>/<span class="subst">$&#123;progress.total&#125;</span>] 【<span class="subst">$&#123;progress.category&#125;</span>】完成`</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 每个栏目完成后触发 UI 更新</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">refreshTrigger</span>++</span><br><span class="line">        </span><br><span class="line">      &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">fullResult</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fullResult.<span class="property">success</span>) &#123;</span><br><span class="line">          logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] ✓ 第二阶段完成: <span class="subst">$&#123;fullResult.updatedCount&#125;</span>个栏目`</span>)</span><br><span class="line">          promptAction.<span class="title function_">openToast</span>(&#123; </span><br><span class="line">            <span class="attr">message</span>: <span class="string">`后台更新完成，所有数据已是最新`</span>, </span><br><span class="line">            <span class="attr">duration</span>: <span class="number">2000</span> </span><br><span class="line">          &#125;)</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 最后一次触发更新</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">refreshTrigger</span>++</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] 第二阶段部分失败`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">error</span>: <span class="title class_">Error</span></span>) =&gt;</span> &#123;</span><br><span class="line">        logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] 第二阶段异常: <span class="subst">$&#123;error.message&#125;</span>`</span>)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] 第一阶段失败`</span>)</span><br><span class="line">      promptAction.<span class="title function_">openToast</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;刷新失败，请检查网络连接&#x27;</span>, <span class="attr">duration</span>: <span class="number">2000</span> &#125;)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] 异常: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">    promptAction.<span class="title function_">openToast</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;刷新失败，请稍后再试&#x27;</span>, <span class="attr">duration</span>: <span class="number">2000</span> &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来我们将通过几个方面去继续解析。</p>
<h5 id="数据结构层面"><a href="#数据结构层面" class="headerlink" title="数据结构层面"></a>数据结构层面</h5><p>首先无论是在快速刷新方法中，还是完整更新方法中，我们是直接将对网络请求以及对数据库的更新读写操作都要封装进了内部，最终返回的仅仅是结果。在我过去的编码习惯中仅仅是返回一个布尔值，用最简单的方式去标明是否成功，然后将所有的异常信息都通过弹窗或者是日志去展示。但这样对于调用本函数的上层函数来说只能看到更新是否成功，但是并不知道具体更新成功的条数以及具体的更新过程进度如何。</p>
<p>我们在设计软件时最重要的一点就是考虑用户的体验，而影响用户体验最重要的因素就是是否存在“莫名其妙的卡顿”和“长时间的忙等”对于开发者来说通过日志可以看出软件的运行情况，但是对于用户来说没有信息的等待时没有任何破解方法的，是最败坏用户体验的。</p>
<p>而从工程的角度来说我们的逻辑管理模块要尽可能的和UI控件解耦，弹窗这种API已经经历了数次大改，使用更加稳定的语言基本语法糖而不依赖于会随版本变化的API去进行功能解耦对于后续应用的升级维护肯定是更有利的，所以我们决定用一个对象包裹原本的成功标识符以及新增的成功条数字段。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 栏目加载结果接口</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 用于记录单个栏目的加载结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">CategoryLoadResult</span> &#123;</span><br><span class="line">  <span class="comment">/** 栏目名称 */</span></span><br><span class="line">  <span class="attr">category</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="comment">/** 是否成功 */</span></span><br><span class="line">  <span class="attr">success</span>: <span class="built_in">boolean</span></span><br><span class="line">  <span class="comment">/** 加载的新闻条数 */</span></span><br><span class="line">  <span class="attr">count</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将信息传递出去，在产品定制层去进行用户UI上的提示肯定是更好的选择。上面的<strong>单个栏目加载结果</strong>就是对基础能力层提供的网络接口的进一步封装，可以做到为下一步处理提供更详细的信息以及定制化的处理。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] ✓ 【<span class="subst">$&#123;category.displayName&#125;</span>】加载成功: <span class="subst">$&#123;response.articles.length&#125;</span>条`</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">CategoryLoadResult</span> = &#123; <span class="attr">category</span>: category.<span class="property">displayName</span>, <span class="attr">success</span>: <span class="literal">true</span>, <span class="attr">count</span>: response.<span class="property">articles</span>.<span class="property">length</span> &#125;</span><br><span class="line"><span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] 【<span class="subst">$&#123;category.displayName&#125;</span>】无数据`</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">CategoryLoadResult</span> = &#123; <span class="attr">category</span>: category.<span class="property">displayName</span>, <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">count</span>: <span class="number">0</span> &#125;</span><br><span class="line"><span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] 【<span class="subst">$&#123;category.displayName&#125;</span>】加载失败: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">CategoryLoadResult</span> = &#123; <span class="attr">category</span>: category.<span class="property">displayName</span>, <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">count</span>: <span class="number">0</span> &#125;</span><br><span class="line"><span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
<p>可以做到向上面这样的定制化日志和返回值。</p>
<p>同样的思路，我们对于快速数据更新接口以及完整数据更新接口也做了类似的设计。并利用<strong>单个栏目加载结果</strong>对象传递出来的信息去进行进一步的日志打印以及返回值数据的处理。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 快速刷新结果接口</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 用于两阶段刷新的第一阶段返回结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">QuickRefreshResult</span> &#123;</span><br><span class="line">  <span class="comment">/** 是否成功 */</span></span><br><span class="line">  <span class="attr">success</span>: <span class="built_in">boolean</span></span><br><span class="line">  <span class="comment">/** 成功加载的栏目数量 */</span></span><br><span class="line">  <span class="attr">loadedCount</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 完整刷新结果接口</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 用于两阶段刷新的第二阶段返回结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">FullRefreshResult</span> &#123;</span><br><span class="line">  <span class="comment">/** 是否成功 */</span></span><br><span class="line">  <span class="attr">success</span>: <span class="built_in">boolean</span></span><br><span class="line">  <span class="comment">/** 成功更新的栏目数量 */</span></span><br><span class="line">  <span class="attr">updatedCount</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!(<span class="keyword">await</span> <span class="title class_">ServerHealthAPI</span>.<span class="title function_">isServerReady</span>())) &#123;</span><br><span class="line">  logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] 服务端未就绪`</span>)</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">QuickRefreshResult</span> = &#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">loadedCount</span>: <span class="number">0</span> &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">appKVDb</span>) &#123;</span><br><span class="line">  logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] 数据库未初始化`</span>)</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">QuickRefreshResult</span> = &#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">loadedCount</span>: <span class="number">0</span> &#125;</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 统计结果（最后一个是轮播图任务）</span></span><br><span class="line"><span class="keyword">const</span> categoryResults = results.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>) <span class="keyword">as</span> <span class="title class_">CategoryLoadResult</span>[]</span><br><span class="line"><span class="keyword">const</span> swiperSuccess = results[results.<span class="property">length</span> - <span class="number">1</span>] <span class="keyword">as</span> <span class="built_in">boolean</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> successCount = categoryResults.<span class="title function_">filter</span>((<span class="attr">r</span>: <span class="title class_">CategoryLoadResult</span>): <span class="function"><span class="params">boolean</span> =&gt;</span> r.<span class="property">success</span>).<span class="property">length</span></span><br><span class="line"><span class="keyword">const</span> totalArticles = categoryResults.<span class="title function_">reduce</span>((<span class="attr">sum</span>: <span class="built_in">number</span>, <span class="attr">r</span>: <span class="title class_">CategoryLoadResult</span>): <span class="function"><span class="params">number</span> =&gt;</span> sum + r.<span class="property">count</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> endTime = <span class="title class_">Date</span>.<span class="title function_">now</span>()</span><br><span class="line"><span class="keyword">const</span> duration = endTime - startTime</span><br><span class="line">logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] ✓ 第一阶段完成: <span class="subst">$&#123;successCount&#125;</span>/<span class="subst">$&#123;developedCategories.length&#125;</span> 个栏目成功, 共<span class="subst">$&#123;totalArticles&#125;</span>条数据, 耗时<span class="subst">$&#123;duration&#125;</span>ms`</span>)</span><br><span class="line">logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[快速刷新] 轮播图刷新: <span class="subst">$&#123;swiperSuccess ? <span class="string">&#x27;成功&#x27;</span> : <span class="string">&#x27;失败&#x27;</span>&#125;</span>`</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="attr">finalResult</span>: <span class="title class_">QuickRefreshResult</span> = &#123; </span><br><span class="line">  <span class="attr">success</span>: successCount &gt; <span class="number">0</span>, </span><br><span class="line">  <span class="attr">loadedCount</span>: successCount </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> finalResult</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> duration = endTime - startTime</span><br><span class="line">logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[完整刷新] ✓ 第二阶段完成: <span class="subst">$&#123;updatedCount&#125;</span>/<span class="subst">$&#123;totalCategories&#125;</span> 个栏目成功, 耗时<span class="subst">$&#123;duration&#125;</span>ms`</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="attr">finalResult</span>: <span class="title class_">FullRefreshResult</span> = &#123;</span><br><span class="line">  <span class="attr">success</span>: updatedCount &gt; <span class="number">0</span>,</span><br><span class="line">  <span class="attr">updatedCount</span>: updatedCount</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> finalResult</span><br></pre></td></tr></table></figure>
<p>就像上面的例子一样，利用上一步暴露出来的信息进一步封装这一步的返回值，最终就会将所有处理过符合要求的数据暴露给产品定制层，不会出现在数据管理器中还需要调用UI接口的情况。</p>
<h5 id="并发控制层面"><a href="#并发控制层面" class="headerlink" title="并发控制层面"></a>并发控制层面</h5><p>对于当前新闻更新需求，我们将更新流程拆分为了快速更新和全量加载，对于全量加载模式，每一个栏目的数据量都很大，我们不能并发加载否则会对服务器造成过大的压力，但是对于快速更新来说，每个栏目仅需要更新20条新数据，总量很小，同时要求的就是快速更新，所以说我们需要使用并发控制函数来去继续加载。</p>
<p>首先我们先通过数组的内置map函数去创建好待执行的任务列表</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> loadTasks = developedCategories.<span class="title function_">map</span>(<span class="title function_">async</span> (<span class="attr">category</span>: <span class="title class_">NewsCategoryInfo</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">CategoryLoadResult</span>&gt; =&gt; &#123;&#125;)</span><br></pre></td></tr></table></figure>
<p>随后单独创建一个轮播图的更新任务Promise对象。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> swiperTask = <span class="variable language_">this</span>.<span class="title function_">updateNewsSwiperToDB</span>()</span><br></pre></td></tr></table></figure>
<p>随后利用<code>Promise.all</code>去并发执行全部快速加载任务来实现快速更新。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 并发执行所有任务</span></span><br><span class="line"><span class="keyword">const</span> results = <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([...loadTasks, swiperTask])</span><br></pre></td></tr></table></figure>
<p>results是接收了全部任务执行结果的结果列表。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">results</span>: [...(<span class="built_in">boolean</span> | <span class="title class_">CategoryLoadResult</span>)[], <span class="built_in">boolean</span> | <span class="title class_">CategoryLoadResult</span>]</span><br></pre></td></tr></table></figure>
<p><code>loadTasks</code>和<code>swiperTask</code>两者的返回结果不一致，这导致了<code>results</code>的类型是联合类型。</p>
<p>联合类型数组我们无法直接通过遍历进行处理，所以我们需要先进行截取操作，将最后一位的轮播图任务结果单独提取出来。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 统计结果（最后一个是轮播图任务）</span></span><br><span class="line"><span class="keyword">const</span> categoryResults = results.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>) <span class="keyword">as</span> <span class="title class_">CategoryLoadResult</span>[]</span><br><span class="line"><span class="keyword">const</span> swiperSuccess = results[results.<span class="property">length</span> - <span class="number">1</span>] <span class="keyword">as</span> <span class="built_in">boolean</span></span><br></pre></td></tr></table></figure>
<p>当最后一位被截取出来后，我们就可以将两组更新结果进行类型的声明了。</p>
<p>这里针对于slice函数的用法去进行一下进一步的解析。读了我每日算法栏目的人应该会知道我在处理数组问题时习惯于利用<code>slice</code>、<code>splice</code>这些内置函数去进行数组操作无论是其本义的截取还是插入，删除，替换……毕竟这些函数在不针对数组元素内部的操作，仅对于数组元素层面的操作确实很万金油。</p>
<p>这两者的作用和用法甚至是拼写都很相似，”有个p的区别”，所以这里要展开说一下两者的区别。</p>
<p><strong>slice和splice的区别</strong>！</p>
<p>核心区别在于 是否修改原数组 以及 功能定位（截取 vs 增删改）</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">特性</th>
<th style="text-align:left">slice</th>
<th style="text-align:left">splice</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>是否修改原数组</strong></td>
<td style="text-align:left">否（返回新数组）</td>
<td style="text-align:left">是（直接修改原数组）</td>
</tr>
<tr>
<td style="text-align:left"><strong>功能</strong></td>
<td style="text-align:left">截取数组片段（只读）</td>
<td style="text-align:left">增/删/改数组元素（写操作）</td>
</tr>
<tr>
<td style="text-align:left"><strong>返回值</strong></td>
<td style="text-align:left">截取的新数组</td>
<td style="text-align:left">被删除的元素组成的数组（无删除则返回空数组）</td>
</tr>
<tr>
<td style="text-align:left"><strong>参数</strong></td>
<td style="text-align:left">(start, end)</td>
<td style="text-align:left">(start, deleteCount, item1, item2, …)</td>
</tr>
<tr>
<td style="text-align:left"><strong>参数特性</strong></td>
<td style="text-align:left">end 不包含、支持负数</td>
<td style="text-align:left">deleteCount 为 0 时仅新增、支持负数索引</td>
</tr>
</tbody>
</table>
</div>
<p>slice 用于从数组中<strong>截取部分片段</strong>，返回新数组，<strong>原数组保持不变</strong>。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array.<span class="title function_">slice</span>(start[, end])</span><br></pre></td></tr></table></figure>
<p>start：截取起始索引（必填）</p>
<ul>
<li>正数：从数组开头计数（0 为第一个元素）</li>
<li>负数：从数组末尾计数（-1 为最后一个元素）</li>
<li>省略 / 超出数组长度：默认从 0 开始</li>
</ul>
<p>end：截取结束索引（可选）</p>
<ul>
<li>正数：截取到该索引 前一位（不包含 end 本身）</li>
<li>负数：从末尾计数到该索引前一位</li>
<li>省略 / 超出数组长度：默认截取到数组末尾</li>
</ul>
<p>根据以上规则我们可以推断出，我们截取新闻更新接口结果对象列表的数据处理代码也可以编写成如下形式：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源代码</span></span><br><span class="line"><span class="keyword">const</span> categoryResults = results.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>) <span class="keyword">as</span> <span class="title class_">CategoryLoadResult</span>[]</span><br><span class="line"><span class="keyword">const</span> swiperSuccess = results[results.<span class="property">length</span> - <span class="number">1</span>] <span class="keyword">as</span> <span class="built_in">boolean</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 等效代码</span></span><br><span class="line"><span class="keyword">const</span> categoryResults = results.<span class="title function_">slice</span>(<span class="number">0</span>, results.<span class="property">length</span> - <span class="number">1</span>) <span class="keyword">as</span> <span class="title class_">CategoryLoadResult</span>[]</span><br><span class="line"><span class="keyword">const</span> swiperSuccess = results.<span class="title function_">slice</span>(-<span class="number">1</span>)[<span class="number">0</span>] <span class="keyword">as</span> <span class="built_in">boolean</span></span><br></pre></td></tr></table></figure>
<p>两者实现的效果是完全一致的。</p>
<p>当然我们在开发中还经常会遇到深浅拷贝问题，就是是我在做算法题时创建了一个新的数组存储结果，最后仅仅将新数组的引用赋值给了结果变量导致结果异常。我们可以利用<code>slice</code>函数截取原数组后会生成一个新数组返回的特点来去对原数组进行深拷贝。</p>
<div class="note danger flat"><p>以上提到的<strong>深拷贝</strong>仅仅是针对于数组这一层的深拷贝！！！如果数组中存放的是number、boolean、string（JS、TS、ArkTS中！！！）等基本类型的值，那么我们在进行深拷贝时，拷贝的就是实际的值，不是引用。但是如果是<strong>数组对象等引用类型</strong>的值，那么我们在进行<code>slice</code>时，拷贝的就是引用，而不是实际的值！！！对于对象数组还是需要对每个对象进行手动的深拷贝的！！！</p>
<p>重要特性：</p>
<ul>
<li>基本类型的值是 按值传递 的</li>
<li>基本类型变量存储的就是实际的值</li>
<li>对基本类型进行拷贝时，拷贝的是实际的值，不是引用</li>
</ul>
<p>TypeScript中的基本类型包括：</p>
<ol>
<li>number - 数值类型</li>
<li>string - 字符串类型</li>
<li>boolean - 布尔类型</li>
<li>bigint - 大整数类型</li>
<li>symbol - 符号类型</li>
<li>undefined - 未定义类型</li>
<li>null - 空值类型</li>
</ol>
<p>在<strong>C语言中，string不是基本类型</strong>！这与JavaScript/TypeScript/ArkTS完全不同。</p>
<p><strong>C语言的基本类型包括：</strong></p>
<ul>
<li><strong>char</strong> - 字符类型（1字节）</li>
<li><strong>int</strong> - 整型</li>
<li><strong>short</strong> - 短整型  </li>
<li><strong>long</strong> - 长整型</li>
<li><strong>float</strong> - 单精度浮点型</li>
<li><strong>double</strong> - 双精度浮点型</li>
</ul>
<p><strong>C语言中的字符串处理：</strong></p>
<ol>
<li><p><strong>字符串本质是字符数组</strong></p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式一：字符数组</span></span><br><span class="line"><span class="type">char</span> str1[] = <span class="string">&quot;Hello&quot;</span>;  <span class="comment">// 自动添加&#x27;\0&#x27;结尾</span></span><br><span class="line"><span class="type">char</span> str2[<span class="number">6</span>] = &#123;<span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式二：字符指针</span></span><br><span class="line"><span class="type">char</span>* str3 = <span class="string">&quot;Hello&quot;</span>;   <span class="comment">// 字符串字面量，通常存放在只读数据段</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>没有内建的字符串操作</strong></p>
<p> C语言标准库提供了<code>&lt;string.h&gt;</code>头文件中的函数：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符串长度</span></span><br><span class="line"><span class="type">size_t</span> len = <span class="built_in">strlen</span>(str);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符串复制</span></span><br><span class="line"><span class="built_in">strcpy</span>(dest, src);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符串连接  </span></span><br><span class="line"><span class="built_in">strcat</span>(dest, src);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字符串比较</span></span><br><span class="line"><span class="type">int</span> result = <span class="built_in">strcmp</span>(str1, str2);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>字符串以’\0’结尾</strong></p>
<p> 这是C字符串的重要特征：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> str[] = &#123;<span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;\0&#x27;</span>&#125;;  <span class="comment">// 正确</span></span><br><span class="line"><span class="type">char</span> str2[] = &#123;<span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;o&#x27;</span>&#125;;       <span class="comment">// 错误！没有结尾符</span></span><br></pre></td></tr></table></figure>
<p> | 特性 | JavaScript/TS/ArkTS | C语言 |<br> |———|—————————-|———-|<br> | string类型 | ✅ 基本类型 | ❌ 不存在 |<br> | 字符串表示 | 直接使用string | char数组或char指针 |<br> | 内存管理 | 自动垃圾回收 | 手动管理（malloc/free） |<br> | 操作符支持 | + 连接、== 比较 | 需要函数调用 |<br> | 内存安全 | 有边界检查 | 无边界检查（缓冲区溢出风险） |</p>
</li>
</ol>
</div>
<p>而对于<code>splice</code>函数，我们则需要注意其会直接修改原数组，所以在使用时需要注意不要误操作导致数据丢失。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array.<span class="title function_">splice</span>(start[, deleteCount[, item1[, item2[, ...]]]])</span><br></pre></td></tr></table></figure>
<p>start：操作起始索引（必填）</p>
<ul>
<li>正数：从开头计数</li>
<li>负数：从末尾计数（-1 为最后一个元素）</li>
<li>超出数组长度：默认从数组末尾开始</li>
</ul>
<p>deleteCount：要删除的元素个数（可选）</p>
<ul>
<li>0：不删除元素（仅用于插入）</li>
<li>正数：删除对应个数的元素（超出剩余元素则删除到末尾）</li>
<li>省略 / 负数：删除从 start 到数组末尾的所有元素</li>
<li>超出数组长度：默认删除到数组末尾</li>
</ul>
<p>item1, item2…：要插入 / 替换的元素（可选）<br>在 start 索引位置插入这些元素（删除后插入，或直接插入）</p>
<p>由此我们可以推出如果我们对原数组进行切分处理的话代码也可以写成以下形式：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 源代码</span></span><br><span class="line"><span class="keyword">const</span> categoryResults = results.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>) <span class="keyword">as</span> <span class="title class_">CategoryLoadResult</span>[]</span><br><span class="line"><span class="keyword">const</span> swiperSuccess = results[results.<span class="property">length</span> - <span class="number">1</span>] <span class="keyword">as</span> <span class="built_in">boolean</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 等效代码</span></span><br><span class="line"><span class="keyword">const</span> categoryResults = results.<span class="title function_">splice</span>(<span class="number">0</span>, results.<span class="property">length</span> - <span class="number">1</span>) <span class="keyword">as</span> <span class="title class_">CategoryLoadResult</span>[]</span><br><span class="line"><span class="keyword">const</span> swiperSuccess = results[<span class="number">0</span>] <span class="keyword">as</span> <span class="built_in">boolean</span></span><br></pre></td></tr></table></figure>
<p>当然由于<code>splice</code>函数会直接修改原数组，所以这种等效一般来说是不推荐的，只有满足以下两个条件时，用 splice 才不会有问题：</p>
<ul>
<li>原数组 results 后续 完全不再使用（不需要复用原数据）</li>
<li>明确需要 “清理原数组”（比如释放内存，避免大数据占用）</li>
</ul>
<p>但这种场景在实际开发中很少见，大多数情况下，我们更倾向于 “不修改原数据”（immutable 编程思想），避免副作用（比如函数调用后意外改变入参），而 slice 正是符合这种思想的安全方法。</p>
<h5 id="总体流程控制层面"><a href="#总体流程控制层面" class="headerlink" title="总体流程控制层面"></a>总体流程控制层面</h5><p>对于刷新数据的总体流程控制函数是在<code>product/default/src/main/ets/pages/tab_contents/NewsListTabContent.ets</code>中的<code>reloadAllData</code>中去进行的。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 两阶段刷新数据</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 第一阶段：快速加载各分栏前20条 + 轮播图，立即结束刷新动画</span></span><br><span class="line"><span class="comment"> * 第二阶段：后台完整加载全部数据，实时更新 UI</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> Promise&lt;boolean&gt; - 第一阶段是否成功</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">reloadAllData</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">boolean</span>&gt; &#123;</span><br><span class="line">  logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] 开始刷新`</span>)</span><br><span class="line">  promptAction.<span class="title function_">openToast</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;正在快速刷新最新数据...&#x27;</span>, <span class="attr">duration</span>: <span class="number">1500</span> &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ========== 第一阶段：快速刷新（并发加载前20条） ==========</span></span><br><span class="line">    <span class="keyword">const</span> quickResult = <span class="keyword">await</span> newsManager.<span class="title function_">quickRefreshCategories</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (quickResult.<span class="property">success</span>) &#123;</span><br><span class="line">      <span class="comment">// 刷新成功，重新加载轮播图数据</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">newsSwiperData</span> = <span class="keyword">await</span> newsManager.<span class="title function_">getNewsSwiperDataFromDB</span>()</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 触发 NewsList 组件重新加载分类数据</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">refreshTrigger</span>++</span><br><span class="line">      </span><br><span class="line">      logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] ✓ 第一阶段完成: <span class="subst">$&#123;quickResult.loadedCount&#125;</span>个栏目`</span>)</span><br><span class="line">      promptAction.<span class="title function_">openToast</span>(&#123; </span><br><span class="line">        <span class="attr">message</span>: <span class="string">`刷新成功，已更新<span class="subst">$&#123;quickResult.loadedCount&#125;</span>个栏目`</span>, </span><br><span class="line">        <span class="attr">duration</span>: <span class="number">2000</span> </span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ========== 第二阶段：后台完整刷新（逐个加载全部数据） ==========</span></span><br><span class="line">      <span class="comment">// 不阻塞 UI，在后台执行</span></span><br><span class="line">      newsManager.<span class="title function_">fullRefreshCategories</span>(<span class="function">(<span class="params">progress</span>) =&gt;</span> &#123;</span><br><span class="line">        logger.<span class="title function_">debug</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] [<span class="subst">$&#123;progress.current&#125;</span>/<span class="subst">$&#123;progress.total&#125;</span>] 【<span class="subst">$&#123;progress.category&#125;</span>】完成`</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 每个栏目完成后触发 UI 更新</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">refreshTrigger</span>++</span><br><span class="line">        </span><br><span class="line">      &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">fullResult</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (fullResult.<span class="property">success</span>) &#123;</span><br><span class="line">          logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] ✓ 第二阶段完成: <span class="subst">$&#123;fullResult.updatedCount&#125;</span>个栏目`</span>)</span><br><span class="line">          promptAction.<span class="title function_">openToast</span>(&#123; </span><br><span class="line">            <span class="attr">message</span>: <span class="string">`后台更新完成，所有数据已是最新`</span>, </span><br><span class="line">            <span class="attr">duration</span>: <span class="number">2000</span> </span><br><span class="line">          &#125;)</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 最后一次触发更新</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">refreshTrigger</span>++</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] 第二阶段部分失败`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params"><span class="attr">error</span>: <span class="title class_">Error</span></span>) =&gt;</span> &#123;</span><br><span class="line">        logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] 第二阶段异常: <span class="subst">$&#123;error.message&#125;</span>`</span>)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] 第一阶段失败`</span>)</span><br><span class="line">      promptAction.<span class="title function_">openToast</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;刷新失败，请检查网络连接&#x27;</span>, <span class="attr">duration</span>: <span class="number">2000</span> &#125;)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] 异常: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">    promptAction.<span class="title function_">openToast</span>(&#123; <span class="attr">message</span>: <span class="string">&#x27;刷新失败，请稍后再试&#x27;</span>, <span class="attr">duration</span>: <span class="number">2000</span> &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们从以下三点来进行解析：</p>
<ol>
<li>两阶段刷新确保速度和完整性</li>
<li>进度回调函数</li>
<li>UI扳机机制</li>
</ol>
<p>首先对于两阶段刷新，我们此前的痛点就是在于我们每一次刷新都要等后端发回全部的数据，这就会导致我们的等待时间大大增加，无提示无变化的“忙等”会极大的降低用户的体验。</p>
<p>这里我们在第一阶段完成后立即触发 UI 更新，用户可以立即看到刷新结果，而不需要等待所有数据加载完成。这里的UI更新指的并不是将<code>Refresh(&#123; refreshing: $$this.isLoading &#125;)</code>组件所包含的刷新动画结束，而是指将<code>NewsList</code>组件所包含的分类数据刷新。也就是让用户先看到新数据，并用上方仍在旋转的刷新动画来提示用户数据正在后台刷新。这样既不用徒增用户的等待时间也能正确的告知用户当前的刷新进度。</p>
<p>同时在这里我们也可以回顾一下对于快速刷新阶段的函数实现与全量加载的函数实现之间的区别。对于快速加载阶段我们使用的是<code>Promise.all</code>函数去进行并行加载的，因为单次请求的加载数据量小，同时核心目标是快。反之，对于全量加载阶段的函数来说，单次请求的数据量大，而且核心目标是要降低对服务器的低负荷，所以使用的是循环遍历待执行的<code>Promise</code>对象，这样一来同一时间的数据流量会被降低，同时整体的加载过程也变成了单一的线性过程，为我们下一项要说的进度回调函数打下了基础。</p>
<p>但是两种截然不同的加载方式被包装成了结构极其相似，均为一个成功标识符和一个成功条数的对象，这就是封装的意义，去屏蔽复杂的内部逻辑，高内聚低耦合。</p>
<p>对于第二点进度回调函数，其实之前我就有在好奇各种各样的回调箭头函数究竟是如何定义的，它又为什么能在指定的时期得到对应的参数并执行外部传入的逻辑的，这一次我得到了答案。</p>
<p>让我们直接就着具体代码来说吧。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">newsManager.<span class="title function_">fullRefreshCategories</span>(<span class="function">(<span class="params">progress</span>) =&gt;</span> &#123;</span><br><span class="line">  logger.<span class="title function_">debug</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>[两阶段刷新] [<span class="subst">$&#123;progress.current&#125;</span>/<span class="subst">$&#123;progress.total&#125;</span>] 【<span class="subst">$&#123;progress.category&#125;</span>】完成`</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 每个栏目完成后触发 UI 更新</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">refreshTrigger</span>++</span><br><span class="line">  </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">fullRefreshCategories</span>(</span><br><span class="line">  <span class="attr">onProgress</span>?: <span class="function">(<span class="params"><span class="attr">progress</span>: <span class="title class_">RefreshProgress</span></span>) =&gt;</span> <span class="built_in">void</span></span><br><span class="line">): <span class="title class_">Promise</span>&lt;<span class="title class_">FullRefreshResult</span>&gt; &#123;</span><br><span class="line">  ......</span><br><span class="line">    <span class="comment">// 逐个加载栏目（避免并发过多导致服务器压力）</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; developedCategories.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> category = developedCategories[i]</span><br><span class="line">      <span class="keyword">const</span> current = i + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[完整刷新] [<span class="subst">$&#123;current&#125;</span>/<span class="subst">$&#123;totalCategories&#125;</span>] 加载【<span class="subst">$&#123;category.displayName&#125;</span>】全部数据`</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取该分类的所有数据</span></span><br><span class="line">        <span class="keyword">const</span> allNews = <span class="keyword">await</span> <span class="title class_">NewsListAPI</span>.<span class="title function_">getAllNewsByCategory</span>(category.<span class="property">apiCategory</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (allNews &amp;&amp; allNews.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// 按日期倒序排序</span></span><br><span class="line">          <span class="keyword">const</span> sortedNews = allNews.<span class="title function_">sort</span>((<span class="attr">a</span>: <span class="title class_">NewsArticle</span>, <span class="attr">b</span>: <span class="title class_">NewsArticle</span>): <span class="function"><span class="params">number</span> =&gt;</span> b.<span class="property">date</span>.<span class="title function_">localeCompare</span>(a.<span class="property">date</span>))</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// 直接覆盖存储（已经是最新完整数据）</span></span><br><span class="line">          <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">appKVDb</span>.<span class="title function_">put</span>(category.<span class="property">dbKey</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(sortedNews))</span><br><span class="line">          </span><br><span class="line">          updatedCount++</span><br><span class="line">          logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[完整刷新] ✓ [<span class="subst">$&#123;current&#125;</span>/<span class="subst">$&#123;totalCategories&#125;</span>] 【<span class="subst">$&#123;category.displayName&#125;</span>】完成: <span class="subst">$&#123;sortedNews.length&#125;</span>条`</span>)</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 回调进度更新</span></span><br><span class="line">          <span class="keyword">if</span> (onProgress) &#123;</span><br><span class="line">            <span class="keyword">const</span> <span class="attr">progress</span>: <span class="title class_">RefreshProgress</span> = &#123;</span><br><span class="line">              <span class="attr">category</span>: category.<span class="property">displayName</span>,</span><br><span class="line">              <span class="attr">current</span>: current,</span><br><span class="line">              <span class="attr">total</span>: totalCategories</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="title function_">onProgress</span>(progress)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          logger.<span class="title function_">warn</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[完整刷新] [<span class="subst">$&#123;current&#125;</span>/<span class="subst">$&#123;totalCategories&#125;</span>] 【<span class="subst">$&#123;category.displayName&#125;</span>】无数据`</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_MANAGER&#125;</span>[完整刷新] [<span class="subst">$&#123;current&#125;</span>/<span class="subst">$&#123;totalCategories&#125;</span>] 【<span class="subst">$&#123;category.displayName&#125;</span>】失败: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(error)&#125;</span>`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的两段代码并非完整代码，我仅仅截取了重要的部分。</p>
<p>首先我们看<code>fullRefreshCategories</code>这个函数，在声明形参的时候直接声明一个箭头函数类型的形参<code>onProgress?: (progress: RefreshProgress) =&gt; void</code>。这里可以注意到一个细节，就是这个参数的声明是一个可选参数而不是一个必选参数，这就提升了这个函数的灵活性，因为这个回调函数的作用仅仅是对当前的刷新进程进行进度通知，并不是功能性上的强制要求。</p>
<p>在加载的过程中通过向形参函数传参就可以实现将内部数据向外部暴露的除返回值以外的另一种方式。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">progress</span>: <span class="title class_">RefreshProgress</span> = &#123;</span><br><span class="line">  <span class="attr">category</span>: category.<span class="property">displayName</span>,</span><br><span class="line">  <span class="attr">current</span>: current,</span><br><span class="line">  <span class="attr">total</span>: totalCategories</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">onProgress</span>(progress)</span><br></pre></td></tr></table></figure>
<p>最后，UI扳机机制。</p>
<p>虽然说官方的的确确提供了一些监听器还有双向绑定之类的API但是此前我已经多次因为这个深浅拷贝，监听属性的深度问题等等等而浪费太多时间去调试了，所以这一次就简简单单的去监听一个基本类型的number变量就好了。</p>
<p>通过<code>this.refreshTrigger++</code>来触发更新，监听侧仅需要设置一个监听器以及回调函数就好。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Monitor</span>(<span class="string">&#x27;refreshTrigger&#x27;</span>)</span><br><span class="line"><span class="title function_">onRefreshTriggered</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">refreshTrigger</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.NEWS_LIST&#125;</span>捕获到刷新触发器变化: <span class="subst">$&#123;<span class="variable language_">this</span>.refreshTrigger&#125;</span>，重新加载当前栏目数据`</span>)</span><br><span class="line">    <span class="comment">// 重新加载当前选中栏目的数据</span></span><br><span class="line">    <span class="keyword">const</span> currentCategoryInfo = <span class="variable constant_">NEWS_CATEGORIES</span>.<span class="title function_">find</span>(<span class="function"><span class="params">cat</span> =&gt;</span> cat.<span class="property">id</span> === <span class="variable language_">this</span>.<span class="property">currentCategory</span>)</span><br><span class="line">    <span class="keyword">if</span> (currentCategoryInfo &amp;&amp; currentCategoryInfo.<span class="property">isDeveloped</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">reloadCurrentCategoryData</span>(currentCategoryInfo)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就还是挺爽的一个方案。</p>
<hr>
<h2 id="新功能实现"><a href="#新功能实现" class="headerlink" title="新功能实现"></a>新功能实现</h2><p>这一部分我会着重将一些对于新功能的开发记录一下实现的思路、具体方式以及相关的一些细节，这也是整个开发过程中我感觉最有意思的一部分了。</p>
<h3 id="热力日历图"><a href="#热力日历图" class="headerlink" title="热力日历图"></a>热力日历图</h3><p>既然是为了鼓励用户的阅读习惯培养的话，我们就需要充足的正反馈来鼓励用户的阅读，让用户感到成就感，虽然一开始可能是有些功利，但是后续的话用户就会感受到阅读带来的好处，从而形成良性循环。</p>
<p>而作为一个程序员来讲我第一个想到的最具备正反馈的记录形式就是GitHub上的热力日历图了。一页的绿点真的很骄傲。</p>
<p><img src="/2025/11/18/HongYiXun/1.webp" alt="1"></p>
<p><img src="/2025/11/18/HongYiXun/2.webp" alt="2"></p>
<p><img src="/2025/11/18/HongYiXun/3.webp" alt="3"></p>
<p>当然类似的设计其实在很多网站都有在使用，像是gitee，gitcode这类开源代码托管平台，直接就是和Github同款的这就不说了。还有更多的软件在刚进入的时候就会弹出一个签到日历，你只要签到了就会将你签到当日的日历格子给标记成一个特殊的颜色或是画个框对吧，这一招确确实实是会激起不少人的“强迫症”的。这种例子太多了我就不放图了，其实就是一种布尔值版本的简化热力日历。</p>
<p>我在ohpm的三方库中心仓搜索了一下发现其实并没有有现成的热力日历图，但是有现成的日历图，所以我本来像要不直接用常规日历图做得了，但是实际用下来发现三方库的日历一方面是没办法很好的去设置不同阅读量的颜色划分，另一方面是没办法很好的设置更多的可设置项。无论选哪个SDK改起来都感觉差点什么，所以我决定自己丰衣足食，搓一个GitHub热力日历图放在应用里。</p>
<p>当然与此同时我也考虑到GitHub模式的热力日历有一个更加严峻的问题就是在于日期的难以辨认，这对于任何人来说都不可能直接在GitHub的热力日历图上随手指出一个指定的日期，所以我们还需要做另一版的常规日历图，这样我们就可以兼顾GitHub热力日历的强成就感渲染模式，同时可以更详细具体的按照常规月份日历的日期进行查看和数据的渲染。为此我想的方案是在展开的页面中去放入一个常规日历图，与此同时要使用共享元素转场来去符合鸿蒙的丝滑UI体验。</p>
<div class="note success flat"><p>这个功能的实现肯定是大部分的Vibe Coding实现啦，借助我们 Claude Opus 4，时至今日我们早就无需纠结于你能不能“纯手搓”出来这个功能了，Vibe Coding能力的进化只会越来越夸张，所以大胆的放手，扩大视野到功能、用户体验、架构设计才是我们更应做的。</p>
</div>
<h4 id="成品效果图"><a href="#成品效果图" class="headerlink" title="成品效果图"></a>成品效果图</h4><p><img src="/2025/11/18/HongYiXun/4.webp" alt="4"></p>
<p><img src="/2025/11/18/HongYiXun/5.webp" alt="5"></p>
<p><img src="/2025/11/18/HongYiXun/6.webp" alt="6"></p>
<p><img src="/2025/11/18/HongYiXun/7.webp" alt="7"></p>
<p>看起来还是挺简洁美观的。</p>
<hr>
<h4 id="文件架构"><a href="#文件架构" class="headerlink" title="文件架构"></a>文件架构</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">commons/common/src/main/ets/</span><br><span class="line">├── modules/</span><br><span class="line">│   ├── models/</span><br><span class="line">│   │   └── DailyReadingStats.ets    # 每日阅读统计数据模型</span><br><span class="line">│   ├── config/</span><br><span class="line">│   │   └── UserConfigViewModel.ets  # 用户配置（含热力日历配置）</span><br><span class="line">│   └── enums.ets                    # 枚举定义（含热力日历相关枚举）</span><br><span class="line"></span><br><span class="line">features/feature/src/main/ets/</span><br><span class="line">├── managers/</span><br><span class="line">│   ├── HistoryManager.ets           # 历史记录管理器（含每日统计功能）</span><br><span class="line">│   └── UserConfigManager.ets        # 用户配置管理器（含配置持久化）</span><br><span class="line"></span><br><span class="line">product/default/src/main/ets/</span><br><span class="line">├── pages/</span><br><span class="line">│   ├── tab_contents/</span><br><span class="line">│   │   └── CalenderTabContent.ets   # 热力日历主页面</span><br><span class="line">│   └── nav_pages/</span><br><span class="line">│       ├── HeatmapSettingsPage.ets  # 热力日历设置页面</span><br><span class="line">│       ├── DateHistoryPage.ets      # 按日期查看历史记录页面</span><br><span class="line">│       └── SettingsPage.ets         # 设置页面（含清理数据功能）</span><br><span class="line">└── resources/rawfile/</span><br><span class="line">    └── calendar_icon.svg            # 日历图标</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="核心渲染算法"><a href="#核心渲染算法" class="headerlink" title="核心渲染算法"></a>核心渲染算法</h4><p>我们这里着重关注一下核心算法的实现。在Vibe Coding时代常规的代码已经没有去读的必要了，我们只用关心核心算法以及对于算法的优化就好了。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2025 XBXyftx</span></span><br><span class="line"><span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></span><br><span class="line"><span class="comment"> * you may not use this file except in compliance with the License.</span></span><br><span class="line"><span class="comment"> * You may obtain a copy of the License at</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *     http://www.apache.org/licenses/LICENSE-2.0</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></span><br><span class="line"><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></span><br><span class="line"><span class="comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="comment"> * See the License for the specific language governing permissions and</span></span><br><span class="line"><span class="comment"> * limitations under the License.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="variable constant_">DEVICE_TYPES</span>,</span><br><span class="line">  <span class="variable constant_">NAV_DESTS</span>,</span><br><span class="line">  <span class="variable constant_">APP_STORAGE_KEYS</span>,</span><br><span class="line">  <span class="title class_">UserConfigViewModel</span>,</span><br><span class="line">  <span class="title class_">DailyReadingStats</span>,</span><br><span class="line">  <span class="title class_">HeatmapColorScheme</span>,</span><br><span class="line">  <span class="title class_">HistoryUpdateTrigger</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&quot;common&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; deviceInfo &#125; <span class="keyword">from</span> <span class="string">&quot;@kit.BasicServicesKit&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; historyManager &#125; <span class="keyword">from</span> <span class="string">&quot;feature&quot;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppStorageV2</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@kit.ArkUI&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 共享元素转场ID</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">HEATMAP_SHARED_ID</span> = <span class="string">&#x27;heatmap_shared_element&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 热力日历单元格数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">HeatmapCell</span> &#123;</span><br><span class="line">  <span class="attr">dateStr</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">count</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="attr">color</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">dayOfWeek</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="attr">dayOfMonth</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="attr">month</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 月历日期单元格</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">CalendarDayCell</span> &#123;</span><br><span class="line">  <span class="attr">day</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="attr">dateStr</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">count</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="attr">color</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">isCurrentMonth</span>: <span class="built_in">boolean</span></span><br><span class="line">  <span class="attr">isToday</span>: <span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ComponentV2</span></span><br><span class="line"><span class="keyword">export</span> struct <span class="title class_">CalenderTabContent</span> &#123;</span><br><span class="line">  <span class="meta">@Local</span> <span class="attr">deviceType</span>: <span class="variable constant_">DEVICE_TYPES</span> =</span><br><span class="line">    deviceInfo.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> : <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">TABLET</span></span><br><span class="line">  <span class="meta">@Local</span> <span class="attr">navPathStuck</span>: <span class="title class_">NavPathStack</span> =</span><br><span class="line">    <span class="title class_">AppStorageV2</span>.<span class="title function_">connect</span>(<span class="title class_">NavPathStack</span>, <span class="variable constant_">APP_STORAGE_KEYS</span>.<span class="property">NAV_PATH_STUCK</span>, <span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">NavPathStack</span>())!</span><br><span class="line">  <span class="meta">@Local</span> <span class="attr">userConfig</span>: <span class="title class_">UserConfigViewModel</span> =</span><br><span class="line">    <span class="title class_">AppStorageV2</span>.<span class="title function_">connect</span>(<span class="title class_">UserConfigViewModel</span>, <span class="variable constant_">APP_STORAGE_KEYS</span>.<span class="property">USER_CONFIG</span>, <span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">UserConfigViewModel</span>())!</span><br><span class="line">  <span class="meta">@Local</span> <span class="attr">historyUpdateTrigger</span>: <span class="title class_">HistoryUpdateTrigger</span> =</span><br><span class="line">    <span class="title class_">AppStorageV2</span>.<span class="title function_">connect</span>(<span class="title class_">HistoryUpdateTrigger</span>, <span class="variable constant_">APP_STORAGE_KEYS</span>.<span class="property">HISTORY_UPDATE_TRIGGER</span>, <span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">HistoryUpdateTrigger</span>())!</span><br><span class="line">  <span class="meta">@Local</span> <span class="attr">dailyStats</span>: <span class="title class_">DailyReadingStats</span>[] = []</span><br><span class="line">  <span class="meta">@Local</span> <span class="attr">heatmapCells</span>: <span class="title class_">HeatmapCell</span>[] = []</span><br><span class="line">  <span class="meta">@Local</span> <span class="attr">isLoading</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span><br><span class="line">  <span class="meta">@Local</span> <span class="attr">totalReadCount</span>: <span class="built_in">number</span> = <span class="number">0</span></span><br><span class="line">  <span class="comment">// 全屏模态控制</span></span><br><span class="line">  <span class="meta">@Local</span> <span class="attr">isFullscreenShow</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span><br><span class="line">  <span class="meta">@Local</span> <span class="attr">cardAlpha</span>: <span class="built_in">number</span> = <span class="number">1</span></span><br><span class="line">  <span class="comment">// 月历相关</span></span><br><span class="line">  <span class="meta">@Local</span> <span class="attr">currentYear</span>: <span class="built_in">number</span> = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getFullYear</span>()</span><br><span class="line">  <span class="meta">@Local</span> <span class="attr">currentMonth</span>: <span class="built_in">number</span> = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getMonth</span>() + <span class="number">1</span></span><br><span class="line">  <span class="meta">@Local</span> <span class="attr">calendarDays</span>: <span class="title class_">CalendarDayCell</span>[] = []</span><br><span class="line">  <span class="meta">@Local</span> <span class="attr">statsMap</span>: <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="built_in">number</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">aboutToAppear</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">loadDailyStats</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generateCalendarDays</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 下拉刷新空内容Builder</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Builder</span></span><br><span class="line">  <span class="title function_">refreshingBuilder</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Stack</span>() &#123;</span><br><span class="line">    &#125;.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Monitor</span>(<span class="string">&#x27;historyUpdateTrigger.trigger&#x27;</span>)</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">onHistoryUpdate</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">loadDailyStats</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generateCalendarDays</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Monitor</span>(<span class="string">&#x27;userConfig.heatmapTimeRange&#x27;</span>)</span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">onTimeRangeChange</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">loadDailyStats</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Monitor</span>(<span class="string">&#x27;userConfig.heatmapColorRange&#x27;</span>)</span><br><span class="line">  <span class="title function_">onColorRangeChange</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generateHeatmapCells</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generateCalendarDays</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Monitor</span>(<span class="string">&#x27;userConfig.heatmapColorScheme&#x27;</span>)</span><br><span class="line">  <span class="title function_">onColorSchemeChange</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generateHeatmapCells</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generateCalendarDays</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Monitor</span>(<span class="string">&#x27;currentMonth&#x27;</span>)</span><br><span class="line">  <span class="title function_">onMonthChange</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generateCalendarDays</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Monitor</span>(<span class="string">&#x27;currentYear&#x27;</span>)</span><br><span class="line">  <span class="title function_">onYearChange</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generateCalendarDays</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadDailyStats</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 加载365天的数据用于月历显示</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dailyStats</span> = <span class="keyword">await</span> historyManager.<span class="title function_">getDailyStatsInRange</span>(<span class="number">365</span>)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">clear</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dailyStats</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">stat</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (stat.<span class="property">count</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">set</span>(stat.<span class="property">dateStr</span>, stat.<span class="property">count</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">generateHeatmapCells</span>()</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">totalReadCount</span> = <span class="variable language_">this</span>.<span class="property">dailyStats</span></span><br><span class="line">        .<span class="title function_">filter</span>(<span class="function"><span class="params">stat</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(stat.<span class="property">dateStr</span>)</span><br><span class="line">          <span class="keyword">const</span> today = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">          <span class="keyword">const</span> diffDays = <span class="title class_">Math</span>.<span class="title function_">floor</span>((today.<span class="title function_">getTime</span>() - date.<span class="title function_">getTime</span>()) / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>))</span><br><span class="line">          <span class="keyword">return</span> diffDays &lt; <span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">heatmapTimeRange</span></span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">reduce</span>(<span class="function">(<span class="params">sum, stat</span>) =&gt;</span> sum + stat.<span class="property">count</span>, <span class="number">0</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;加载每日统计失败:&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(error))</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">generateHeatmapCells</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">newCells</span>: <span class="title class_">HeatmapCell</span>[] = []</span><br><span class="line">    <span class="keyword">const</span> today = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">    <span class="keyword">const</span> timeRange = <span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">heatmapTimeRange</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = timeRange - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">      <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(today)</span><br><span class="line">      date.<span class="title function_">setDate</span>(today.<span class="title function_">getDate</span>() - i)</span><br><span class="line">      <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(date)</span><br><span class="line">      <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr) || <span class="number">0</span></span><br><span class="line"></span><br><span class="line">      newCells.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">dateStr</span>: dateStr,</span><br><span class="line">        <span class="attr">count</span>: count,</span><br><span class="line">        <span class="attr">color</span>: <span class="variable language_">this</span>.<span class="title function_">getColorForCount</span>(count),</span><br><span class="line">        <span class="attr">dayOfWeek</span>: date.<span class="title function_">getDay</span>(),</span><br><span class="line">        <span class="attr">dayOfMonth</span>: date.<span class="title function_">getDate</span>(),</span><br><span class="line">        <span class="attr">month</span>: date.<span class="title function_">getMonth</span>() + <span class="number">1</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">heatmapCells</span> = newCells</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">generateCalendarDays</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">days</span>: <span class="title class_">CalendarDayCell</span>[] = []</span><br><span class="line">    <span class="keyword">const</span> today = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">    <span class="keyword">const</span> todayStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(today)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> firstDay = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span> - <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">const</span> lastDay = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> firstDayOfWeek = firstDay.<span class="title function_">getDay</span>()</span><br><span class="line">    <span class="keyword">const</span> daysInMonth = lastDay.<span class="title function_">getDate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> prevMonthLastDay = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span> - <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">const</span> prevMonthDays = prevMonthLastDay.<span class="title function_">getDate</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 填充上个月的日期</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = firstDayOfWeek - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">      <span class="keyword">const</span> day = prevMonthDays - i</span><br><span class="line">      <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span> - <span class="number">2</span>, day)</span><br><span class="line">      <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(date)</span><br><span class="line">      <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr) || <span class="number">0</span></span><br><span class="line">      days.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">day</span>: day,</span><br><span class="line">        <span class="attr">dateStr</span>: dateStr,</span><br><span class="line">        <span class="attr">count</span>: count,</span><br><span class="line">        <span class="attr">color</span>: <span class="variable language_">this</span>.<span class="title function_">getColorForCount</span>(count),</span><br><span class="line">        <span class="attr">isCurrentMonth</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">isToday</span>: dateStr === todayStr</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 填充当月日期</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> day = <span class="number">1</span>; day &lt;= daysInMonth; day++) &#123;</span><br><span class="line">      <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span> - <span class="number">1</span>, day)</span><br><span class="line">      <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(date)</span><br><span class="line">      <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr) || <span class="number">0</span></span><br><span class="line">      days.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">day</span>: day,</span><br><span class="line">        <span class="attr">dateStr</span>: dateStr,</span><br><span class="line">        <span class="attr">count</span>: count,</span><br><span class="line">        <span class="attr">color</span>: <span class="variable language_">this</span>.<span class="title function_">getColorForCount</span>(count),</span><br><span class="line">        <span class="attr">isCurrentMonth</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">isToday</span>: dateStr === todayStr</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 填充下个月的日期</span></span><br><span class="line">    <span class="keyword">const</span> remainingDays = <span class="number">42</span> - days.<span class="property">length</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> day = <span class="number">1</span>; day &lt;= remainingDays; day++) &#123;</span><br><span class="line">      <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span>, day)</span><br><span class="line">      <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(date)</span><br><span class="line">      <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr) || <span class="number">0</span></span><br><span class="line">      days.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">day</span>: day,</span><br><span class="line">        <span class="attr">dateStr</span>: dateStr,</span><br><span class="line">        <span class="attr">count</span>: count,</span><br><span class="line">        <span class="attr">color</span>: <span class="variable language_">this</span>.<span class="title function_">getColorForCount</span>(count),</span><br><span class="line">        <span class="attr">isCurrentMonth</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">isToday</span>: dateStr === todayStr</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">calendarDays</span> = days</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">formatDate</span>(<span class="attr">date</span>: <span class="title class_">Date</span>): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> year = date.<span class="title function_">getFullYear</span>()</span><br><span class="line">    <span class="keyword">const</span> month = <span class="title class_">String</span>(date.<span class="title function_">getMonth</span>() + <span class="number">1</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> day = <span class="title class_">String</span>(date.<span class="title function_">getDate</span>()).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;year&#125;</span>-<span class="subst">$&#123;month&#125;</span>-<span class="subst">$&#123;day&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getColorForCount</span>(<span class="attr">count</span>: <span class="built_in">number</span>): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> maxRange = <span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">heatmapColorRange</span></span><br><span class="line">    <span class="keyword">const</span> ratio = <span class="title class_">Math</span>.<span class="title function_">min</span>(count / maxRange, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">const</span> scheme = <span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">heatmapColorScheme</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (scheme === <span class="title class_">HeatmapColorScheme</span>.<span class="property">BLUE</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> blueColors = [<span class="string">&#x27;#2d333b&#x27;</span>, <span class="string">&#x27;#1e3a5f&#x27;</span>, <span class="string">&#x27;#2563eb&#x27;</span>, <span class="string">&#x27;#60a5fa&#x27;</span>, <span class="string">&#x27;#93c5fd&#x27;</span>]</span><br><span class="line">      <span class="keyword">if</span> (count === <span class="number">0</span>) <span class="keyword">return</span> blueColors[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">if</span> (ratio &lt;= <span class="number">0.25</span>) <span class="keyword">return</span> blueColors[<span class="number">1</span>]</span><br><span class="line">      <span class="keyword">if</span> (ratio &lt;= <span class="number">0.5</span>) <span class="keyword">return</span> blueColors[<span class="number">2</span>]</span><br><span class="line">      <span class="keyword">if</span> (ratio &lt;= <span class="number">0.75</span>) <span class="keyword">return</span> blueColors[<span class="number">3</span>]</span><br><span class="line">      <span class="keyword">return</span> blueColors[<span class="number">4</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="attr">colorSchemes</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; = &#123;</span><br><span class="line">      [<span class="title class_">HeatmapColorScheme</span>.<span class="property">GREEN</span>]: [<span class="string">&#x27;#2d333b&#x27;</span>, <span class="string">&#x27;#0e4429&#x27;</span>, <span class="string">&#x27;#006d32&#x27;</span>, <span class="string">&#x27;#26a641&#x27;</span>, <span class="string">&#x27;#39d353&#x27;</span>],</span><br><span class="line">      [<span class="title class_">HeatmapColorScheme</span>.<span class="property">RED</span>]: [<span class="string">&#x27;#2d333b&#x27;</span>, <span class="string">&#x27;#5c2121&#x27;</span>, <span class="string">&#x27;#8b3d3d&#x27;</span>, <span class="string">&#x27;#d35f5f&#x27;</span>, <span class="string">&#x27;#ff8080&#x27;</span>],</span><br><span class="line">      [<span class="title class_">HeatmapColorScheme</span>.<span class="property">GRAY</span>]: [<span class="string">&#x27;#2d333b&#x27;</span>, <span class="string">&#x27;#404040&#x27;</span>, <span class="string">&#x27;#606060&#x27;</span>, <span class="string">&#x27;#909090&#x27;</span>, <span class="string">&#x27;#c0c0c0&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> colors = colorSchemes[scheme] || colorSchemes[<span class="title class_">HeatmapColorScheme</span>.<span class="property">GREEN</span>]</span><br><span class="line">    <span class="keyword">if</span> (count === <span class="number">0</span>) <span class="keyword">return</span> colors[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (ratio &lt;= <span class="number">0.25</span>) <span class="keyword">return</span> colors[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> (ratio &lt;= <span class="number">0.5</span>) <span class="keyword">return</span> colors[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">if</span> (ratio &lt;= <span class="number">0.75</span>) <span class="keyword">return</span> colors[<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">return</span> colors[<span class="number">4</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getLegendColors</span>(): <span class="built_in">string</span>[] &#123;</span><br><span class="line">    <span class="keyword">const</span> scheme = <span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">heatmapColorScheme</span></span><br><span class="line">    <span class="keyword">if</span> (scheme === <span class="title class_">HeatmapColorScheme</span>.<span class="property">BLUE</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> [<span class="string">&#x27;#2d333b&#x27;</span>, <span class="string">&#x27;#1e3a5f&#x27;</span>, <span class="string">&#x27;#2563eb&#x27;</span>, <span class="string">&#x27;#60a5fa&#x27;</span>, <span class="string">&#x27;#93c5fd&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">colorSchemes</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; = &#123;</span><br><span class="line">      [<span class="title class_">HeatmapColorScheme</span>.<span class="property">GREEN</span>]: [<span class="string">&#x27;#2d333b&#x27;</span>, <span class="string">&#x27;#0e4429&#x27;</span>, <span class="string">&#x27;#006d32&#x27;</span>, <span class="string">&#x27;#26a641&#x27;</span>, <span class="string">&#x27;#39d353&#x27;</span>],</span><br><span class="line">      [<span class="title class_">HeatmapColorScheme</span>.<span class="property">RED</span>]: [<span class="string">&#x27;#2d333b&#x27;</span>, <span class="string">&#x27;#5c2121&#x27;</span>, <span class="string">&#x27;#8b3d3d&#x27;</span>, <span class="string">&#x27;#d35f5f&#x27;</span>, <span class="string">&#x27;#ff8080&#x27;</span>],</span><br><span class="line">      [<span class="title class_">HeatmapColorScheme</span>.<span class="property">GRAY</span>]: [<span class="string">&#x27;#2d333b&#x27;</span>, <span class="string">&#x27;#404040&#x27;</span>, <span class="string">&#x27;#606060&#x27;</span>, <span class="string">&#x27;#909090&#x27;</span>, <span class="string">&#x27;#c0c0c0&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> colorSchemes[scheme] || colorSchemes[<span class="title class_">HeatmapColorScheme</span>.<span class="property">GREEN</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCellClick</span>(<span class="attr">cell</span>: <span class="title class_">HeatmapCell</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">heatmapClickToHistory</span> &amp;&amp; cell.<span class="property">count</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果全屏模态打开，先收起再导航</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isFullscreenShow</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onFullscreenBack</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">navPathStuck</span>.<span class="title function_">replacePath</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="variable constant_">NAV_DESTS</span>.<span class="property">DATE_HISTORY</span>,</span><br><span class="line">        <span class="attr">param</span>: cell.<span class="property">dateStr</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">onCalendarCellClick</span>(<span class="attr">dateStr</span>: <span class="built_in">string</span>, <span class="attr">count</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">heatmapClickToHistory</span> &amp;&amp; count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 如果全屏模态打开，先收起再导航</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isFullscreenShow</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">onFullscreenBack</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">navPathStuck</span>.<span class="title function_">replacePath</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="variable constant_">NAV_DESTS</span>.<span class="property">DATE_HISTORY</span>,</span><br><span class="line">        <span class="attr">param</span>: dateStr</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">getWeekColumns</span>(): <span class="title class_">HeatmapCell</span>[][] &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">weeks</span>: <span class="title class_">HeatmapCell</span>[][] = []</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">heatmapCells</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> weeks</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> firstDayOfWeek = <span class="variable language_">this</span>.<span class="property">heatmapCells</span>[<span class="number">0</span>].<span class="property">dayOfWeek</span></span><br><span class="line">    <span class="keyword">let</span> <span class="attr">currentWeek</span>: <span class="title class_">HeatmapCell</span>[] = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; firstDayOfWeek; i++) &#123;</span><br><span class="line">      currentWeek.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">dateStr</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line">        <span class="attr">dayOfWeek</span>: i,</span><br><span class="line">        <span class="attr">dayOfMonth</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">month</span>: <span class="number">0</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> cell <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">heatmapCells</span>) &#123;</span><br><span class="line">      currentWeek.<span class="title function_">push</span>(cell)</span><br><span class="line">      <span class="keyword">if</span> (currentWeek.<span class="property">length</span> === <span class="number">7</span>) &#123;</span><br><span class="line">        weeks.<span class="title function_">push</span>(currentWeek)</span><br><span class="line">        currentWeek = []</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentWeek.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">while</span> (currentWeek.<span class="property">length</span> &lt; <span class="number">7</span>) &#123;</span><br><span class="line">        currentWeek.<span class="title function_">push</span>(&#123;</span><br><span class="line">          <span class="attr">dateStr</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">          <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">color</span>: <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line">          <span class="attr">dayOfWeek</span>: currentWeek.<span class="property">length</span>,</span><br><span class="line">          <span class="attr">dayOfMonth</span>: <span class="number">0</span>,</span><br><span class="line">          <span class="attr">month</span>: <span class="number">0</span></span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">      weeks.<span class="title function_">push</span>(currentWeek)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> weeks</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">prevMonth</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentMonth</span> === <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentMonth</span> = <span class="number">12</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentYear</span>--</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentMonth</span>--</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">nextMonth</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">currentMonth</span> === <span class="number">12</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentMonth</span> = <span class="number">1</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentYear</span>++</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">currentMonth</span>++</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 点击展开全屏</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">onExpandClick</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getUIContext</span>()?.<span class="title function_">animateTo</span>(&#123;</span><br><span class="line">      <span class="attr">duration</span>: <span class="number">350</span>,</span><br><span class="line">      <span class="attr">curve</span>: <span class="title class_">Curve</span>.<span class="property">Friction</span></span><br><span class="line">    &#125;, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">isFullscreenShow</span> = <span class="literal">true</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">cardAlpha</span> = <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 从全屏返回</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">onFullscreenBack</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">getUIContext</span>()?.<span class="title function_">animateTo</span>(&#123;</span><br><span class="line">      <span class="attr">duration</span>: <span class="number">350</span>,</span><br><span class="line">      <span class="attr">curve</span>: <span class="title class_">Curve</span>.<span class="property">Friction</span></span><br><span class="line">    &#125;, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">isFullscreenShow</span> = <span class="literal">false</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">cardAlpha</span> = <span class="number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Builder</span></span><br><span class="line">  <span class="title class_">HeatmapCellBuilder</span>(<span class="attr">cell</span>: <span class="title class_">HeatmapCell</span>, <span class="attr">index</span>: <span class="built_in">number</span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">width</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">12</span> : <span class="number">16</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">12</span> : <span class="number">16</span>)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>(cell.<span class="property">color</span>)</span><br><span class="line">    .<span class="title function_">borderRadius</span>(<span class="number">2</span>)</span><br><span class="line">    .<span class="title function_">margin</span>(<span class="number">1</span>)</span><br><span class="line">    .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">onCellClick</span>(cell))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Builder</span></span><br><span class="line">  <span class="title class_">LegendBuilder</span>() &#123;</span><br><span class="line">    <span class="title class_">Row</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;少&#x27;</span>)</span><br><span class="line">        .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">10</span> : <span class="number">12</span>)</span><br><span class="line">        .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_secondary&#x27;</span>))</span><br><span class="line">        .<span class="title function_">margin</span>(&#123; <span class="attr">right</span>: <span class="number">4</span> &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="title function_">getLegendColors</span>(), <span class="function">(<span class="params"><span class="attr">color</span>: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title class_">Column</span>()</span><br><span class="line">          .<span class="title function_">width</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">12</span> : <span class="number">16</span>)</span><br><span class="line">          .<span class="title function_">height</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">12</span> : <span class="number">16</span>)</span><br><span class="line">          .<span class="title function_">backgroundColor</span>(color)</span><br><span class="line">          .<span class="title function_">borderRadius</span>(<span class="number">2</span>)</span><br><span class="line">          .<span class="title function_">margin</span>(&#123; <span class="attr">right</span>: <span class="number">2</span> &#125;)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">&#x27;多&#x27;</span>)</span><br><span class="line">        .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">10</span> : <span class="number">12</span>)</span><br><span class="line">        .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_secondary&#x27;</span>))</span><br><span class="line">        .<span class="title function_">margin</span>(&#123; <span class="attr">left</span>: <span class="number">4</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">Center</span>)</span><br><span class="line">    .<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="number">16</span> &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Builder</span></span><br><span class="line">  <span class="title class_">CalendarDayCellBuilder</span>(<span class="attr">cell</span>: <span class="title class_">CalendarDayCell</span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;cell.day&#125;</span>`</span>)</span><br><span class="line">        .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">14</span> : <span class="number">18</span>)</span><br><span class="line">        .<span class="title function_">fontWeight</span>(cell.<span class="property">isToday</span> ? <span class="title class_">FontWeight</span>.<span class="property">Bold</span> : <span class="title class_">FontWeight</span>.<span class="property">Normal</span>)</span><br><span class="line">        .<span class="title function_">fontColor</span>(cell.<span class="property">isCurrentMonth</span> ? $r(<span class="string">&#x27;app.color.text_primary&#x27;</span>) : $r(<span class="string">&#x27;app.color.text_secondary&#x27;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">aspectRatio</span>(<span class="number">1</span>)</span><br><span class="line">    .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">Center</span>)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>(cell.<span class="property">count</span> &gt; <span class="number">0</span> ? cell.<span class="property">color</span> : <span class="title class_">Color</span>.<span class="property">Transparent</span>)</span><br><span class="line">    .<span class="title function_">borderRadius</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">8</span> : <span class="number">12</span>)</span><br><span class="line">    .<span class="title function_">border</span>(&#123;</span><br><span class="line">      <span class="attr">width</span>: cell.<span class="property">isToday</span> ? <span class="number">2</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">color</span>: $r(<span class="string">&#x27;app.color.brand&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">onCalendarCellClick</span>(cell.<span class="property">dateStr</span>, cell.<span class="property">count</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 全屏模态页面内容Builder</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Builder</span></span><br><span class="line">  <span class="title function_">fullscreenContentBuilder</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">GridRow</span>(&#123; <span class="attr">columns</span>: &#123; <span class="attr">sm</span>: <span class="number">4</span>, <span class="attr">md</span>: <span class="number">8</span>, <span class="attr">lg</span>: <span class="number">12</span> &#125; &#125;) &#123;</span><br><span class="line">      <span class="title class_">GridCol</span>(&#123; <span class="attr">span</span>: &#123; <span class="attr">sm</span>: <span class="number">4</span>, <span class="attr">md</span>: <span class="number">6</span>, <span class="attr">lg</span>: <span class="number">6</span> &#125;, <span class="attr">offset</span>: &#123; <span class="attr">sm</span>: <span class="number">0</span>, <span class="attr">md</span>: <span class="number">1</span>, <span class="attr">lg</span>: <span class="number">3</span> &#125; &#125;) &#123;</span><br><span class="line">        <span class="title class_">Column</span>() &#123;</span><br><span class="line">          <span class="comment">// 标题栏</span></span><br><span class="line">          <span class="title class_">Row</span>() &#123;</span><br><span class="line">            <span class="title class_">Text</span>(<span class="string">&#x27;阅读热力日历&#x27;</span>)</span><br><span class="line">              .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">20</span> : <span class="number">26</span>)</span><br><span class="line">              .<span class="title function_">fontWeight</span>(<span class="title class_">FontWeight</span>.<span class="property">Bold</span>)</span><br><span class="line">              .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_primary&#x27;</span>))</span><br><span class="line">              .<span class="title function_">layoutWeight</span>(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 关闭按钮</span></span><br><span class="line">            <span class="title class_">SymbolGlyph</span>($r(<span class="string">&#x27;sys.symbol.arrow_down_right_and_arrow_up_left&#x27;</span>))</span><br><span class="line">              .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">24</span> : <span class="number">32</span>)</span><br><span class="line">              .<span class="title function_">fontColor</span>([$r(<span class="string">&#x27;app.color.text_primary&#x27;</span>)])</span><br><span class="line">              .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">onFullscreenBack</span>())</span><br><span class="line">          &#125;</span><br><span class="line">          .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">          .<span class="title function_">padding</span>(&#123;</span><br><span class="line">            <span class="attr">left</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span>,</span><br><span class="line">            <span class="attr">right</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span>,</span><br><span class="line">            <span class="attr">top</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">12</span> : <span class="number">16</span>,</span><br><span class="line">            <span class="attr">bottom</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">12</span> : <span class="number">16</span></span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="number">48</span> &#125;) <span class="comment">// 固定顶部边距，避开状态栏</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">// 使用Refresh组件实现下拉返回手势</span></span><br><span class="line">          <span class="title class_">Refresh</span>(&#123; <span class="attr">refreshing</span>: <span class="literal">false</span>, <span class="attr">builder</span>: <span class="variable language_">this</span>.<span class="property">refreshingBuilder</span>, <span class="attr">offset</span>: <span class="number">4</span> &#125;) &#123;</span><br><span class="line">            <span class="title class_">Scroll</span>() &#123;</span><br><span class="line">              <span class="title class_">Column</span>() &#123;</span><br><span class="line">                <span class="comment">// 统计信息卡片</span></span><br><span class="line">                <span class="title class_">Column</span>() &#123;</span><br><span class="line">                  <span class="title class_">Text</span>(<span class="string">`最近 <span class="subst">$&#123;<span class="variable language_">this</span>.userConfig.heatmapTimeRange&#125;</span> 天共阅读`</span>)</span><br><span class="line">                    .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">14</span> : <span class="number">18</span>)</span><br><span class="line">                    .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_secondary&#x27;</span>))</span><br><span class="line"></span><br><span class="line">                  <span class="title class_">Row</span>() &#123;</span><br><span class="line">                    <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.totalReadCount&#125;</span>`</span>)</span><br><span class="line">                      .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">36</span> : <span class="number">48</span>)</span><br><span class="line">                      .<span class="title function_">fontWeight</span>(<span class="title class_">FontWeight</span>.<span class="property">Bold</span>)</span><br><span class="line">                      .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.brand&#x27;</span>))</span><br><span class="line"></span><br><span class="line">                    <span class="title class_">Text</span>(<span class="string">&#x27; 篇文章&#x27;</span>)</span><br><span class="line">                      .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">20</span>)</span><br><span class="line">                      .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_primary&#x27;</span>))</span><br><span class="line">                      .<span class="title function_">margin</span>(&#123; <span class="attr">bottom</span>: <span class="number">4</span> &#125;)</span><br><span class="line">                  &#125;</span><br><span class="line">                  .<span class="title function_">alignItems</span>(<span class="title class_">VerticalAlign</span>.<span class="property">Bottom</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">                .<span class="title function_">padding</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">20</span> : <span class="number">28</span>)</span><br><span class="line">                .<span class="title function_">backgroundColor</span>($r(<span class="string">&#x27;app.color.news_list_item_bg&#x27;</span>))</span><br><span class="line">                .<span class="title function_">borderRadius</span>(<span class="number">16</span>)</span><br><span class="line">                .<span class="title function_">alignItems</span>(<span class="title class_">HorizontalAlign</span>.<span class="property">Start</span>)</span><br><span class="line">                .<span class="title function_">margin</span>(&#123;</span><br><span class="line">                  <span class="attr">left</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span>,</span><br><span class="line">                  <span class="attr">right</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span></span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 热力日历网格 - 共享元素</span></span><br><span class="line">                <span class="title class_">Column</span>() &#123;</span><br><span class="line">                  <span class="comment">// 热力格子</span></span><br><span class="line">                  <span class="title class_">Scroll</span>() &#123;</span><br><span class="line">                    <span class="title class_">Row</span>() &#123;</span><br><span class="line">                      <span class="comment">// 星期标签列</span></span><br><span class="line">                      <span class="title class_">Column</span>() &#123;</span><br><span class="line">                        <span class="title class_">ForEach</span>([<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;一&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;三&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;五&#x27;</span>, <span class="string">&#x27;&#x27;</span>], <span class="function">(<span class="params"><span class="attr">day</span>: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">                          <span class="title class_">Text</span>(day)</span><br><span class="line">                            .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">9</span> : <span class="number">11</span>)</span><br><span class="line">                            .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_secondary&#x27;</span>))</span><br><span class="line">                            .<span class="title function_">height</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">14</span> : <span class="number">18</span>)</span><br><span class="line">                            .<span class="title function_">width</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">20</span>)</span><br><span class="line">                            .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">End</span>)</span><br><span class="line">                            .<span class="title function_">margin</span>(&#123; <span class="attr">right</span>: <span class="number">4</span> &#125;)</span><br><span class="line">                        &#125;)</span><br><span class="line">                      &#125;</span><br><span class="line"></span><br><span class="line">                      <span class="comment">// 热力格子网格</span></span><br><span class="line">                      <span class="title class_">Scroll</span>() &#123;</span><br><span class="line">                        <span class="title class_">Row</span>() &#123;</span><br><span class="line">                          <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="title function_">getWeekColumns</span>(), <span class="function">(<span class="params"><span class="attr">weekCells</span>: <span class="title class_">HeatmapCell</span>[], <span class="attr">weekIndex</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">                            <span class="title class_">Column</span>() &#123;</span><br><span class="line">                              <span class="title class_">ForEach</span>(weekCells, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">HeatmapCell</span>, <span class="attr">dayIndex</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">                                <span class="variable language_">this</span>.<span class="title class_">HeatmapCellBuilder</span>(cell, weekIndex * <span class="number">7</span> + dayIndex)</span><br><span class="line">                              &#125;, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">HeatmapCell</span>, <span class="attr">dayIdx</span>: <span class="built_in">number</span></span>) =&gt;</span> <span class="string">`fs_<span class="subst">$&#123;cell.dateStr || <span class="string">&#x27;empty&#x27;</span>&#125;</span>_<span class="subst">$&#123;dayIdx&#125;</span>_<span class="subst">$&#123;cell.count&#125;</span>`</span>)</span><br><span class="line">                            &#125;</span><br><span class="line">                          &#125;, <span class="function">(<span class="params"><span class="attr">weekCells</span>: <span class="title class_">HeatmapCell</span>[], <span class="attr">idx</span>: <span class="built_in">number</span></span>) =&gt;</span> <span class="string">`fs_week_<span class="subst">$&#123;idx&#125;</span>`</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                      &#125;</span><br><span class="line">                      .<span class="title function_">scrollable</span>(<span class="title class_">ScrollDirection</span>.<span class="property">Horizontal</span>)</span><br><span class="line">                      .<span class="title function_">scrollBar</span>(<span class="title class_">BarState</span>.<span class="property">Off</span>)</span><br><span class="line">                      .<span class="title function_">layoutWeight</span>(<span class="number">1</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                  .<span class="title function_">scrollable</span>(<span class="title class_">ScrollDirection</span>.<span class="property">Horizontal</span>)</span><br><span class="line">                  .<span class="title function_">scrollBar</span>(<span class="title class_">BarState</span>.<span class="property">Off</span>)</span><br><span class="line">                  .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                  <span class="comment">// 图例</span></span><br><span class="line">                  <span class="variable language_">this</span>.<span class="title class_">LegendBuilder</span>()</span><br><span class="line"></span><br><span class="line">                  <span class="comment">// 范围说明</span></span><br><span class="line">                  <span class="title class_">Text</span>(<span class="string">`颜色范围: 0 - <span class="subst">$&#123;<span class="variable language_">this</span>.userConfig.heatmapColorRange&#125;</span> 篇`</span>)</span><br><span class="line">                    .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">10</span> : <span class="number">12</span>)</span><br><span class="line">                    .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_secondary&#x27;</span>))</span><br><span class="line">                    .<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="number">8</span> &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">                .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">                .<span class="title function_">padding</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span>)</span><br><span class="line">                .<span class="title function_">backgroundColor</span>($r(<span class="string">&#x27;app.color.news_list_item_bg&#x27;</span>))</span><br><span class="line">                .<span class="title function_">borderRadius</span>(<span class="number">16</span>)</span><br><span class="line">                .<span class="title function_">margin</span>(&#123;</span><br><span class="line">                  <span class="attr">top</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">12</span> : <span class="number">16</span>,</span><br><span class="line">                  <span class="attr">left</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span>,</span><br><span class="line">                  <span class="attr">right</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span></span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 共享元素转场 - 与卡片的id对应</span></span><br><span class="line">                .<span class="title function_">geometryTransition</span>(<span class="variable constant_">HEATMAP_SHARED_ID</span>)</span><br><span class="line">                .<span class="title function_">transition</span>(<span class="title class_">TransitionEffect</span>.<span class="property">OPACITY</span>.<span class="title function_">animation</span>(&#123; <span class="attr">duration</span>: <span class="number">350</span>, <span class="attr">curve</span>: <span class="title class_">Curve</span>.<span class="property">Friction</span> &#125;))</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 月历视图</span></span><br><span class="line">                <span class="title class_">Column</span>() &#123;</span><br><span class="line">                  <span class="comment">// 月份导航</span></span><br><span class="line">                  <span class="title class_">Row</span>() &#123;</span><br><span class="line">                    <span class="title class_">Image</span>($r(<span class="string">&#x27;sys.media.ohos_ic_public_arrow_left&#x27;</span>))</span><br><span class="line">                      .<span class="title function_">width</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">24</span> : <span class="number">32</span>)</span><br><span class="line">                      .<span class="title function_">height</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">24</span> : <span class="number">32</span>)</span><br><span class="line">                      .<span class="title function_">fillColor</span>($r(<span class="string">&#x27;app.color.text_primary&#x27;</span>))</span><br><span class="line">                      .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">prevMonth</span>())</span><br><span class="line"></span><br><span class="line">                    <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.currentYear&#125;</span>年<span class="subst">$&#123;<span class="variable language_">this</span>.currentMonth&#125;</span>月`</span>)</span><br><span class="line">                      .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">18</span> : <span class="number">24</span>)</span><br><span class="line">                      .<span class="title function_">fontWeight</span>(<span class="title class_">FontWeight</span>.<span class="property">Bold</span>)</span><br><span class="line">                      .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_primary&#x27;</span>))</span><br><span class="line">                      .<span class="title function_">layoutWeight</span>(<span class="number">1</span>)</span><br><span class="line">                      .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line"></span><br><span class="line">                    <span class="title class_">Image</span>($r(<span class="string">&#x27;sys.media.ohos_ic_public_arrow_right&#x27;</span>))</span><br><span class="line">                      .<span class="title function_">width</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">24</span> : <span class="number">32</span>)</span><br><span class="line">                      .<span class="title function_">height</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">24</span> : <span class="number">32</span>)</span><br><span class="line">                      .<span class="title function_">fillColor</span>($r(<span class="string">&#x27;app.color.text_primary&#x27;</span>))</span><br><span class="line">                      .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">nextMonth</span>())</span><br><span class="line">                  &#125;</span><br><span class="line">                  .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">                  .<span class="title function_">padding</span>(&#123; <span class="attr">bottom</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span> &#125;)</span><br><span class="line"></span><br><span class="line">                  <span class="comment">// 星期标题</span></span><br><span class="line">                  <span class="title class_">Row</span>() &#123;</span><br><span class="line">                    <span class="title class_">ForEach</span>([<span class="string">&#x27;日&#x27;</span>, <span class="string">&#x27;一&#x27;</span>, <span class="string">&#x27;二&#x27;</span>, <span class="string">&#x27;三&#x27;</span>, <span class="string">&#x27;四&#x27;</span>, <span class="string">&#x27;五&#x27;</span>, <span class="string">&#x27;六&#x27;</span>], <span class="function">(<span class="params"><span class="attr">day</span>: <span class="built_in">string</span></span>) =&gt;</span> &#123;</span><br><span class="line">                      <span class="title class_">Text</span>(day)</span><br><span class="line">                        .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">12</span> : <span class="number">14</span>)</span><br><span class="line">                        .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_secondary&#x27;</span>))</span><br><span class="line">                        .<span class="title function_">width</span>(<span class="string">&#x27;14.28%&#x27;</span>)</span><br><span class="line">                        .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">Center</span>)</span><br><span class="line">                    &#125;)</span><br><span class="line">                  &#125;</span><br><span class="line">                  .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">                  .<span class="title function_">padding</span>(&#123; <span class="attr">bottom</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">8</span> : <span class="number">12</span> &#125;)</span><br><span class="line"></span><br><span class="line">                  <span class="comment">// 日期网格</span></span><br><span class="line">                  <span class="title class_">Grid</span>() &#123;</span><br><span class="line">                    <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">calendarDays</span>, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">CalendarDayCell</span>, <span class="attr">index</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">                      <span class="title class_">GridItem</span>() &#123;</span><br><span class="line">                        <span class="variable language_">this</span>.<span class="title class_">CalendarDayCellBuilder</span>(cell)</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">CalendarDayCell</span>, <span class="attr">idx</span>: <span class="built_in">number</span></span>) =&gt;</span> <span class="string">`cal_<span class="subst">$&#123;cell.dateStr&#125;</span>_<span class="subst">$&#123;idx&#125;</span>`</span>)</span><br><span class="line">                  &#125;</span><br><span class="line">                  .<span class="title function_">columnsTemplate</span>(<span class="string">&#x27;1fr 1fr 1fr 1fr 1fr 1fr 1fr&#x27;</span>)</span><br><span class="line">                  .<span class="title function_">rowsGap</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">4</span> : <span class="number">8</span>)</span><br><span class="line">                  .<span class="title function_">columnsGap</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">4</span> : <span class="number">8</span>)</span><br><span class="line">                  .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">                .<span class="title function_">padding</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span>)</span><br><span class="line">                .<span class="title function_">backgroundColor</span>($r(<span class="string">&#x27;app.color.news_list_item_bg&#x27;</span>))</span><br><span class="line">                .<span class="title function_">borderRadius</span>(<span class="number">16</span>)</span><br><span class="line">                .<span class="title function_">margin</span>(&#123;</span><br><span class="line">                  <span class="attr">top</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">12</span> : <span class="number">16</span>,</span><br><span class="line">                  <span class="attr">left</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span>,</span><br><span class="line">                  <span class="attr">right</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span></span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 提示文字</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">heatmapClickToHistory</span>) &#123;</span><br><span class="line">                  <span class="title class_">Text</span>(<span class="string">&#x27;点击有阅读记录的日期可查看当天阅读的文章&#x27;</span>)</span><br><span class="line">                    .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">12</span> : <span class="number">14</span>)</span><br><span class="line">                    .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_secondary&#x27;</span>))</span><br><span class="line">                    .<span class="title function_">margin</span>(&#123;</span><br><span class="line">                      <span class="attr">top</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">12</span> : <span class="number">16</span>,</span><br><span class="line">                      <span class="attr">left</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span>,</span><br><span class="line">                      <span class="attr">right</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span>,</span><br><span class="line">                      <span class="attr">bottom</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">24</span> : <span class="number">32</span></span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            .<span class="title function_">scrollable</span>(<span class="title class_">ScrollDirection</span>.<span class="property">Vertical</span>)</span><br><span class="line">            .<span class="title function_">scrollBar</span>(<span class="title class_">BarState</span>.<span class="property">Off</span>)</span><br><span class="line">            .<span class="title function_">edgeEffect</span>(<span class="title class_">EdgeEffect</span>.<span class="property">None</span>)</span><br><span class="line">            .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">            .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          .<span class="title function_">onRefreshing</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// 下拉刷新时触发返回</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">onFullscreenBack</span>()</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">        .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">backgroundColor</span>($r(<span class="string">&#x27;app.color.page_background&#x27;</span>))</span><br><span class="line">    <span class="comment">// 只扩展底部安全区域，顶部保持避开状态栏</span></span><br><span class="line">    .<span class="title function_">expandSafeArea</span>([<span class="title class_">SafeAreaType</span>.<span class="property">SYSTEM</span>], [<span class="title class_">SafeAreaEdge</span>.<span class="property">BOTTOM</span>])</span><br><span class="line">    .<span class="title function_">transition</span>(<span class="title class_">TransitionEffect</span>.<span class="title function_">asymmetric</span>(</span><br><span class="line">      <span class="title class_">TransitionEffect</span>.<span class="title function_">opacity</span>(<span class="number">1</span>),</span><br><span class="line">      <span class="title class_">TransitionEffect</span>.<span class="property">OPACITY</span></span><br><span class="line">    ))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="comment">// 标题栏</span></span><br><span class="line">      <span class="title class_">Row</span>() &#123;</span><br><span class="line">        <span class="title class_">Text</span>(<span class="string">&#x27;阅读热力日历&#x27;</span>)</span><br><span class="line">          .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">28</span> : <span class="number">34</span>)</span><br><span class="line">          .<span class="title function_">fontWeight</span>(<span class="number">700</span>)</span><br><span class="line">          .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_primary&#x27;</span>))</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">      .<span class="title function_">padding</span>(&#123;</span><br><span class="line">        <span class="attr">left</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span>,</span><br><span class="line">        <span class="attr">right</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span>,</span><br><span class="line">        <span class="attr">top</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">20</span> : <span class="number">28</span>,</span><br><span class="line">        <span class="attr">bottom</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">20</span></span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">isLoading</span>) &#123;</span><br><span class="line">        <span class="title class_">Column</span>() &#123;</span><br><span class="line">          <span class="title class_">LoadingProgress</span>()</span><br><span class="line">            .<span class="title function_">width</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">40</span> : <span class="number">50</span>)</span><br><span class="line">            .<span class="title function_">height</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">40</span> : <span class="number">50</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">        .<span class="title function_">layoutWeight</span>(<span class="number">1</span>)</span><br><span class="line">        .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">Center</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title class_">Scroll</span>() &#123;</span><br><span class="line">          <span class="title class_">Column</span>() &#123;</span><br><span class="line">            <span class="comment">// 统计信息卡片</span></span><br><span class="line">            <span class="title class_">Column</span>() &#123;</span><br><span class="line">              <span class="title class_">Text</span>(<span class="string">`最近 <span class="subst">$&#123;<span class="variable language_">this</span>.userConfig.heatmapTimeRange&#125;</span> 天共阅读`</span>)</span><br><span class="line">                .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">14</span> : <span class="number">18</span>)</span><br><span class="line">                .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_secondary&#x27;</span>))</span><br><span class="line"></span><br><span class="line">              <span class="title class_">Row</span>() &#123;</span><br><span class="line">                <span class="title class_">Text</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.totalReadCount&#125;</span>`</span>)</span><br><span class="line">                  .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">36</span> : <span class="number">48</span>)</span><br><span class="line">                  .<span class="title function_">fontWeight</span>(<span class="number">700</span>)</span><br><span class="line">                  .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.brand&#x27;</span>))</span><br><span class="line"></span><br><span class="line">                <span class="title class_">Text</span>(<span class="string">&#x27; 篇文章&#x27;</span>)</span><br><span class="line">                  .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">20</span>)</span><br><span class="line">                  .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_primary&#x27;</span>))</span><br><span class="line">                  .<span class="title function_">margin</span>(&#123; <span class="attr">bottom</span>: <span class="number">4</span> &#125;)</span><br><span class="line">              &#125;</span><br><span class="line">              .<span class="title function_">alignItems</span>(<span class="title class_">VerticalAlign</span>.<span class="property">Bottom</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">            .<span class="title function_">padding</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">20</span> : <span class="number">28</span>)</span><br><span class="line">            .<span class="title function_">backgroundColor</span>($r(<span class="string">&#x27;app.color.news_list_item_bg&#x27;</span>))</span><br><span class="line">            .<span class="title function_">borderRadius</span>(<span class="number">16</span>)</span><br><span class="line">            .<span class="title function_">alignItems</span>(<span class="title class_">HorizontalAlign</span>.<span class="property">Start</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 热力日历网格 - 添加共享元素转场</span></span><br><span class="line">            <span class="title class_">Stack</span>(&#123; <span class="attr">alignContent</span>: <span class="title class_">Alignment</span>.<span class="property">TopEnd</span> &#125;) &#123;</span><br><span class="line">              <span class="title class_">Column</span>() &#123;</span><br><span class="line">                <span class="comment">// 热力格子 - 使用Grid布局，每行7天</span></span><br><span class="line">                <span class="title class_">Scroll</span>() &#123;</span><br><span class="line">                  <span class="title class_">Row</span>() &#123;</span><br><span class="line">                    <span class="comment">// 星期标签列</span></span><br><span class="line">                    <span class="title class_">Column</span>() &#123;</span><br><span class="line">                      <span class="title class_">ForEach</span>([<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;一&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;三&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;五&#x27;</span>, <span class="string">&#x27;&#x27;</span>], <span class="function">(<span class="params"><span class="attr">day</span>: <span class="built_in">string</span>, <span class="attr">index</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="title class_">Text</span>(day)</span><br><span class="line">                          .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">9</span> : <span class="number">11</span>)</span><br><span class="line">                          .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_secondary&#x27;</span>))</span><br><span class="line">                          .<span class="title function_">height</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">14</span> : <span class="number">18</span>)</span><br><span class="line">                          .<span class="title function_">width</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">20</span>)</span><br><span class="line">                          .<span class="title function_">textAlign</span>(<span class="title class_">TextAlign</span>.<span class="property">End</span>)</span><br><span class="line">                          .<span class="title function_">margin</span>(&#123; <span class="attr">right</span>: <span class="number">4</span> &#125;)</span><br><span class="line">                      &#125;)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 热力格子网格</span></span><br><span class="line">                    <span class="title class_">Scroll</span>() &#123;</span><br><span class="line">                      <span class="title class_">Row</span>() &#123;</span><br><span class="line">                        <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="title function_">getWeekColumns</span>(), <span class="function">(<span class="params"><span class="attr">weekCells</span>: <span class="title class_">HeatmapCell</span>[], <span class="attr">weekIndex</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">                          <span class="title class_">Column</span>() &#123;</span><br><span class="line">                            <span class="title class_">ForEach</span>(weekCells, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">HeatmapCell</span>, <span class="attr">dayIndex</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">                              <span class="variable language_">this</span>.<span class="title class_">HeatmapCellBuilder</span>(cell, weekIndex * <span class="number">7</span> + dayIndex)</span><br><span class="line">                            &#125;, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">HeatmapCell</span>, <span class="attr">dayIdx</span>: <span class="built_in">number</span></span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.userConfig.heatmapTimeRange&#125;</span>_<span class="subst">$&#123;<span class="variable language_">this</span>.userConfig.heatmapColorRange&#125;</span>_<span class="subst">$&#123;<span class="variable language_">this</span>.userConfig.heatmapColorScheme&#125;</span>_<span class="subst">$&#123;cell.dateStr || <span class="string">&#x27;empty&#x27;</span>&#125;</span>_<span class="subst">$&#123;dayIdx&#125;</span>_<span class="subst">$&#123;cell.count&#125;</span>_<span class="subst">$&#123;cell.color&#125;</span>`</span>)</span><br><span class="line">                          &#125;</span><br><span class="line">                        &#125;, <span class="function">(<span class="params"><span class="attr">weekCells</span>: <span class="title class_">HeatmapCell</span>[], <span class="attr">idx</span>: <span class="built_in">number</span></span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.userConfig.heatmapTimeRange&#125;</span>_<span class="subst">$&#123;<span class="variable language_">this</span>.userConfig.heatmapColorRange&#125;</span>_<span class="subst">$&#123;<span class="variable language_">this</span>.userConfig.heatmapColorScheme&#125;</span>_week_<span class="subst">$&#123;idx&#125;</span>_<span class="subst">$&#123;weekCells.length&#125;</span>`</span>)</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    .<span class="title function_">scrollable</span>(<span class="title class_">ScrollDirection</span>.<span class="property">Horizontal</span>)</span><br><span class="line">                    .<span class="title function_">scrollBar</span>(<span class="title class_">BarState</span>.<span class="property">Off</span>)</span><br><span class="line">                    .<span class="title function_">layoutWeight</span>(<span class="number">1</span>)</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                .<span class="title function_">scrollable</span>(<span class="title class_">ScrollDirection</span>.<span class="property">Horizontal</span>)</span><br><span class="line">                .<span class="title function_">scrollBar</span>(<span class="title class_">BarState</span>.<span class="property">Off</span>)</span><br><span class="line">                .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 图例</span></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title class_">LegendBuilder</span>()</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 范围说明</span></span><br><span class="line">                <span class="title class_">Text</span>(<span class="string">`颜色范围: 0 - <span class="subst">$&#123;<span class="variable language_">this</span>.userConfig.heatmapColorRange&#125;</span> 篇`</span>)</span><br><span class="line">                  .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">10</span> : <span class="number">12</span>)</span><br><span class="line">                  .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_secondary&#x27;</span>))</span><br><span class="line">                  .<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="number">8</span> &#125;)</span><br><span class="line">              &#125;</span><br><span class="line">              .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">              .<span class="title function_">padding</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span>)</span><br><span class="line">              .<span class="title function_">padding</span>(&#123; <span class="attr">top</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">40</span> : <span class="number">48</span> &#125;)</span><br><span class="line"></span><br><span class="line">              <span class="comment">// 全屏按钮 - 右上角</span></span><br><span class="line">              <span class="title class_">Row</span>() &#123;</span><br><span class="line">                <span class="title class_">SymbolGlyph</span>($r(<span class="string">&#x27;sys.symbol.arrow_up_left_and_arrow_down_right&#x27;</span>))</span><br><span class="line">                  .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">18</span> : <span class="number">22</span>)</span><br><span class="line">                  .<span class="title function_">fontColor</span>([$r(<span class="string">&#x27;app.color.text_secondary&#x27;</span>)])</span><br><span class="line">              &#125;</span><br><span class="line">              .<span class="title function_">width</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">32</span> : <span class="number">40</span>)</span><br><span class="line">              .<span class="title function_">height</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">32</span> : <span class="number">40</span>)</span><br><span class="line">              .<span class="title function_">borderRadius</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">20</span>)</span><br><span class="line">              .<span class="title function_">backgroundColor</span>($r(<span class="string">&#x27;app.color.card_bg&#x27;</span>))</span><br><span class="line">              .<span class="title function_">justifyContent</span>(<span class="title class_">FlexAlign</span>.<span class="property">Center</span>)</span><br><span class="line">              .<span class="title function_">margin</span>(&#123;</span><br><span class="line">                <span class="attr">top</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">8</span> : <span class="number">12</span>,</span><br><span class="line">                <span class="attr">right</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">8</span> : <span class="number">12</span></span><br><span class="line">              &#125;)</span><br><span class="line">              .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">onExpandClick</span>())</span><br><span class="line">            &#125;</span><br><span class="line">            .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">            .<span class="title function_">backgroundColor</span>($r(<span class="string">&#x27;app.color.news_list_item_bg&#x27;</span>))</span><br><span class="line">            .<span class="title function_">borderRadius</span>(<span class="number">16</span>)</span><br><span class="line">            .<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">12</span> : <span class="number">16</span> &#125;)</span><br><span class="line">            .<span class="title function_">clip</span>(<span class="literal">true</span>)</span><br><span class="line">            <span class="comment">// 共享元素转场 - follow: true 表示跟随目标组件</span></span><br><span class="line">            .<span class="title function_">geometryTransition</span>(<span class="variable constant_">HEATMAP_SHARED_ID</span>, &#123; <span class="attr">follow</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">            .<span class="title function_">transition</span>(<span class="title class_">TransitionEffect</span>.<span class="property">OPACITY</span>.<span class="title function_">animation</span>(&#123; <span class="attr">duration</span>: <span class="number">350</span>, <span class="attr">curve</span>: <span class="title class_">Curve</span>.<span class="property">Friction</span> &#125;))</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 提示文字</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">heatmapClickToHistory</span>) &#123;</span><br><span class="line">              <span class="title class_">Text</span>(<span class="string">&#x27;点击有阅读记录的日期可查看当天阅读的文章&#x27;</span>)</span><br><span class="line">                .<span class="title function_">fontSize</span>(<span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">12</span> : <span class="number">14</span>)</span><br><span class="line">                .<span class="title function_">fontColor</span>($r(<span class="string">&#x27;app.color.text_secondary&#x27;</span>))</span><br><span class="line">                .<span class="title function_">margin</span>(&#123; <span class="attr">top</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">12</span> : <span class="number">16</span> &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          .<span class="title function_">padding</span>(&#123;</span><br><span class="line">            <span class="attr">left</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span>,</span><br><span class="line">            <span class="attr">right</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span>,</span><br><span class="line">            <span class="attr">bottom</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">16</span> : <span class="number">24</span></span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        .<span class="title function_">layoutWeight</span>(<span class="number">1</span>)</span><br><span class="line">        .<span class="title function_">scrollBar</span>(<span class="title class_">BarState</span>.<span class="property">Auto</span>)</span><br><span class="line">        .<span class="title function_">edgeEffect</span>(<span class="title class_">EdgeEffect</span>.<span class="property">Spring</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">    .<span class="title function_">expandSafeArea</span>()</span><br><span class="line">    .<span class="title function_">opacity</span>(<span class="variable language_">this</span>.<span class="property">cardAlpha</span>)</span><br><span class="line">    <span class="comment">// 绑定全屏模态页面</span></span><br><span class="line">    .<span class="title function_">bindContentCover</span>(</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">isFullscreenShow</span>,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">fullscreenContentBuilder</span>(),</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">modalTransition</span>: <span class="title class_">ModalTransition</span>.<span class="property">NONE</span>,</span><br><span class="line">        <span class="attr">onWillDisappear</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">isFullscreenShow</span> = <span class="literal">false</span></span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">cardAlpha</span> = <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面这是完整的代码接下来我们仅分析核心部分</p>
<p>整个热力日历的渲染核心可以拆分为三个关键算法：</p>
<ol>
<li><strong>GitHub风格热力图生成</strong> (<code>generateHeatmapCells</code>) - 按时间线性排列的热力格子</li>
<li><strong>月历视图生成</strong> (<code>generateCalendarDays</code>) - 传统月历布局的日期格子</li>
<li><strong>周列转换算法</strong> (<code>getWeekColumns</code>) - 将线性数据转换为按周分列的二维数组</li>
</ol>
<h5 id="1-GitHub风格热力图生成算法"><a href="#1-GitHub风格热力图生成算法" class="headerlink" title="1. GitHub风格热力图生成算法"></a>1. GitHub风格热力图生成算法</h5><p>这个算法的核心思路是<strong>从今天往前推N天，生成一个线性的日期数组</strong>，每个日期对应一个格子。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">generateHeatmapCells</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">newCells</span>: <span class="title class_">HeatmapCell</span>[] = []</span><br><span class="line">  <span class="keyword">const</span> today = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">  <span class="keyword">const</span> timeRange = <span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">heatmapTimeRange</span>  <span class="comment">// 用户配置的时间范围，如90天、180天、365天</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关键：倒序遍历，从 timeRange-1 天前到今天</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = timeRange - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(today)</span><br><span class="line">    date.<span class="title function_">setDate</span>(today.<span class="title function_">getDate</span>() - i)  <span class="comment">// 计算目标日期</span></span><br><span class="line">    <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(date)</span><br><span class="line">    <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr) || <span class="number">0</span>  <span class="comment">// 从统计数据Map中获取阅读量</span></span><br><span class="line"></span><br><span class="line">    newCells.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">dateStr</span>: dateStr,</span><br><span class="line">      <span class="attr">count</span>: count,</span><br><span class="line">      <span class="attr">color</span>: <span class="variable language_">this</span>.<span class="title function_">getColorForCount</span>(count),  <span class="comment">// 根据阅读量计算颜色</span></span><br><span class="line">      <span class="attr">dayOfWeek</span>: date.<span class="title function_">getDay</span>(),  <span class="comment">// 0-6，用于后续按周分列</span></span><br><span class="line">      <span class="attr">dayOfMonth</span>: date.<span class="title function_">getDate</span>(),</span><br><span class="line">      <span class="attr">month</span>: date.<span class="title function_">getMonth</span>() + <span class="number">1</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">heatmapCells</span> = newCells</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>算法亮点分析：</strong></p>
<p>这里有个很巧妙的设计，就是<strong>倒序遍历</strong>的方式。为什么要从<code>timeRange - 1</code>倒着数到0，而不是从0正着数到<code>timeRange - 1</code>呢？</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方案A：正序遍历（直觉写法）</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; timeRange; i++) &#123;</span><br><span class="line">  <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(today)</span><br><span class="line">  date.<span class="title function_">setDate</span>(today.<span class="title function_">getDate</span>() - (timeRange - <span class="number">1</span> - i))  <span class="comment">// 需要反向计算</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方案B：倒序遍历（实际采用）</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = timeRange - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">  <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(today)</span><br><span class="line">  date.<span class="title function_">setDate</span>(today.<span class="title function_">getDate</span>() - i)  <span class="comment">// 直接减去偏移量</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>倒序遍历的好处在于：</p>
<ul>
<li><strong>计算更直观</strong>：<code>today - i</code> 天就是目标日期，不需要额外的<code>timeRange - 1 - i</code>这种反向计算</li>
<li><strong>语义更清晰</strong>：i 的值直接代表”距离今天的天数”，比如 i=7 就是7天前</li>
<li><strong>调试更友好</strong>：打印 i 的值就能直接知道是哪一天</li>
</ul>
<p>同时这里使用了<code>statsMap</code>这个Map结构来存储每日统计数据，而不是数组：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据加载时构建Map</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">clear</span>()</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">dailyStats</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">stat</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (stat.<span class="property">count</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">set</span>(stat.<span class="property">dateStr</span>, stat.<span class="property">count</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询时O(1)复杂度</span></span><br><span class="line"><span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr) || <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>如果用数组存储，每次查询都需要遍历整个数组找到对应日期，时间复杂度是O(n)。而Map的查询是O(1)，在生成365天的热力图时，性能差异会非常明显：</p>
<ul>
<li><strong>数组方案</strong>：365次查询 × 平均遍历182次 = 约66,430次比较操作</li>
<li><strong>Map方案</strong>：365次查询 × 1次哈希查找 = 365次操作</li>
</ul>
<p>性能提升了约180倍！</p>
<h5 id="2-月历视图生成算法"><a href="#2-月历视图生成算法" class="headerlink" title="2. 月历视图生成算法"></a>2. 月历视图生成算法</h5><p>月历视图的难点在于<strong>需要填充上月和下月的日期</strong>，让日历始终保持完整的6行×7列（42个格子）布局。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">generateCalendarDays</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">days</span>: <span class="title class_">CalendarDayCell</span>[] = []</span><br><span class="line">  <span class="keyword">const</span> today = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">  <span class="keyword">const</span> todayStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(today)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算当月的关键日期</span></span><br><span class="line">  <span class="keyword">const</span> firstDay = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span> - <span class="number">1</span>, <span class="number">1</span>)  <span class="comment">// 当月第一天</span></span><br><span class="line">  <span class="keyword">const</span> lastDay = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span>, <span class="number">0</span>)       <span class="comment">// 当月最后一天</span></span><br><span class="line">  <span class="keyword">const</span> firstDayOfWeek = firstDay.<span class="title function_">getDay</span>()  <span class="comment">// 第一天是星期几（0-6）</span></span><br><span class="line">  <span class="keyword">const</span> daysInMonth = lastDay.<span class="title function_">getDate</span>()     <span class="comment">// 当月有多少天</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算上个月的最后一天</span></span><br><span class="line">  <span class="keyword">const</span> prevMonthLastDay = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span> - <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> prevMonthDays = prevMonthLastDay.<span class="title function_">getDate</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 阶段1：填充上个月的日期（填充第一行的空白）</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = firstDayOfWeek - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> day = prevMonthDays - i  <span class="comment">// 倒推上月日期</span></span><br><span class="line">    <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span> - <span class="number">2</span>, day)</span><br><span class="line">    <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(date)</span><br><span class="line">    <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr) || <span class="number">0</span></span><br><span class="line">    days.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">day</span>: day,</span><br><span class="line">      <span class="attr">dateStr</span>: dateStr,</span><br><span class="line">      <span class="attr">count</span>: count,</span><br><span class="line">      <span class="attr">color</span>: <span class="variable language_">this</span>.<span class="title function_">getColorForCount</span>(count),</span><br><span class="line">      <span class="attr">isCurrentMonth</span>: <span class="literal">false</span>,  <span class="comment">// 标记为非当月</span></span><br><span class="line">      <span class="attr">isToday</span>: dateStr === todayStr</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 阶段2：填充当月日期</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> day = <span class="number">1</span>; day &lt;= daysInMonth; day++) &#123;</span><br><span class="line">    <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span> - <span class="number">1</span>, day)</span><br><span class="line">    <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(date)</span><br><span class="line">    <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr) || <span class="number">0</span></span><br><span class="line">    days.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">day</span>: day,</span><br><span class="line">      <span class="attr">dateStr</span>: dateStr,</span><br><span class="line">      <span class="attr">count</span>: count,</span><br><span class="line">      <span class="attr">color</span>: <span class="variable language_">this</span>.<span class="title function_">getColorForCount</span>(count),</span><br><span class="line">      <span class="attr">isCurrentMonth</span>: <span class="literal">true</span>,  <span class="comment">// 标记为当月</span></span><br><span class="line">      <span class="attr">isToday</span>: dateStr === todayStr</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 阶段3：填充下个月的日期（补齐到42个格子）</span></span><br><span class="line">  <span class="keyword">const</span> remainingDays = <span class="number">42</span> - days.<span class="property">length</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> day = <span class="number">1</span>; day &lt;= remainingDays; day++) &#123;</span><br><span class="line">    <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span>, day)</span><br><span class="line">    <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(date)</span><br><span class="line">    <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr) || <span class="number">0</span></span><br><span class="line">    days.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">day</span>: day,</span><br><span class="line">      <span class="attr">dateStr</span>: dateStr,</span><br><span class="line">      <span class="attr">count</span>: count,</span><br><span class="line">      <span class="attr">color</span>: <span class="variable language_">this</span>.<span class="title function_">getColorForCount</span>(count),</span><br><span class="line">      <span class="attr">isCurrentMonth</span>: <span class="literal">false</span>,  <span class="comment">// 标记为非当月</span></span><br><span class="line">      <span class="attr">isToday</span>: dateStr === todayStr</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">calendarDays</span> = days</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note primary flat"><p>这里着重解释一下JS、TS、ArkTS中的Date对象的参数用法。</p>
<p>在JavaScript/TypeScript/ArkTS中，<code>Date</code>对象的构造函数有一个非常巧妙的特性，理解它对于日期计算至关重要。</p>
<p><strong>Date构造函数的基本语法：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(year, monthIndex, day, hours, minutes, seconds, milliseconds)</span><br></pre></td></tr></table></figure>
<p>关键点：</p>
<ul>
<li><code>year</code>：四位数年份（如 2025）</li>
<li><code>monthIndex</code>：<strong>月份索引，从0开始</strong>（0=1月，1=2月，…，11=12月）</li>
<li><code>day</code>：日期（1-31）</li>
</ul>
<p><strong>核心特性：自动溢出处理</strong></p>
<p>Date对象会自动处理参数溢出，这是它最强大的特性：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例1：月份溢出</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">12</span>, <span class="number">1</span>)  <span class="comment">// 月份12溢出 → 2026年1月1日</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, -<span class="number">1</span>, <span class="number">1</span>)  <span class="comment">// 月份-1溢出 → 2024年12月1日</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例2：日期溢出</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">1</span>, <span class="number">0</span>)   <span class="comment">// 2月的第0天 → 2025年1月31日（上月最后一天）</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">1</span>, -<span class="number">1</span>)  <span class="comment">// 2月的第-1天 → 2025年1月30日</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">1</span>, <span class="number">32</span>)  <span class="comment">// 2月的第32天 → 2025年3月4日（2月只有28天）</span></span><br></pre></td></tr></table></figure>
<p><strong>在月历算法中的应用：</strong></p>
<p>在日历组件中，我们需要频繁计算月份的边界日期。以下三个表达式是核心：</p>
<p><strong>表达式1：<code>new Date(this.currentYear, this.currentMonth - 1, 1)</code></strong></p>
<p>这个表达式用于获取<strong>当前月份的第一天</strong>。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设当前是2025年3月</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">currentYear</span> = <span class="number">2025</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">currentMonth</span> = <span class="number">3</span>  <span class="comment">// 注意：这里的3表示3月（人类习惯的1-12）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造过程：</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">3</span> - <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">→ <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">2</span>, <span class="number">1</span>)  <span class="comment">// monthIndex=2表示3月（计算机的0-11）</span></span><br><span class="line">→ <span class="number">2025</span>年<span class="number">3</span>月<span class="number">1</span>日 星期六</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用途：确定日历网格的起始日期</span></span><br><span class="line"><span class="comment">// 通过 firstDay.getDay() 可以知道这个月1号是星期几</span></span><br><span class="line"><span class="comment">// 从而计算出需要补充多少个上月的日期</span></span><br></pre></td></tr></table></figure>
<p><strong>表达式2：<code>new Date(this.currentYear, this.currentMonth, 0)</code></strong></p>
<p>这个表达式用于获取<strong>当前月份的最后一天</strong>（利用日期溢出特性）。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设当前是2025年3月</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">currentYear</span> = <span class="number">2025</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">currentMonth</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造过程：</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">3</span>, <span class="number">0</span>)</span><br><span class="line">→ <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">3</span>, <span class="number">0</span>)  <span class="comment">// monthIndex=3表示4月，但day=0</span></span><br><span class="line">→ <span class="number">4</span>月的第<span class="number">0</span>天 = <span class="number">3</span>月的最后一天</span><br><span class="line">→ <span class="number">2025</span>年<span class="number">3</span>月<span class="number">31</span>日 星期一</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关键理解：</span></span><br><span class="line"><span class="comment">// - monthIndex=3 指向4月</span></span><br><span class="line"><span class="comment">// - day=0 表示&quot;4月的前一天&quot;</span></span><br><span class="line"><span class="comment">// - 结果就是3月的最后一天</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用途：</span></span><br><span class="line"><span class="comment">// 1. 通过 lastDay.getDate() 获取当月天数（31天）</span></span><br><span class="line"><span class="comment">// 2. 确定日历网格中当月部分的结束位置</span></span><br></pre></td></tr></table></figure>
<p><strong>表达式3：<code>new Date(this.currentYear, this.currentMonth - 1, 0)</code></strong></p>
<p>这个表达式用于获取<strong>上个月的最后一天</strong>。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设当前是2025年3月</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">currentYear</span> = <span class="number">2025</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">currentMonth</span> = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 构造过程：</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">3</span> - <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">→ <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">2</span>, <span class="number">0</span>)  <span class="comment">// monthIndex=2表示3月，但day=0</span></span><br><span class="line">→ <span class="number">3</span>月的第<span class="number">0</span>天 = <span class="number">2</span>月的最后一天</span><br><span class="line">→ <span class="number">2025</span>年<span class="number">2</span>月<span class="number">28</span>日 星期五</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关键理解：</span></span><br><span class="line"><span class="comment">// - monthIndex=2 指向3月</span></span><br><span class="line"><span class="comment">// - day=0 表示&quot;3月的前一天&quot;</span></span><br><span class="line"><span class="comment">// - 结果就是2月的最后一天</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用途：</span></span><br><span class="line"><span class="comment">// 1. 通过 prevLastDay.getDate() 获取上月天数（28天）</span></span><br><span class="line"><span class="comment">// 2. 计算日历网格中需要填充的上月日期</span></span><br><span class="line"><span class="comment">//    例如：如果3月1日是星期六（getDay()=6），</span></span><br><span class="line"><span class="comment">//         需要填充上月的最后6天：23,24,25,26,27,28</span></span><br></pre></td></tr></table></figure>
<p><strong>三个表达式的对比总结：</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>表达式</th>
<th>monthIndex</th>
<th>day</th>
<th>结果</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>new Date(year, month-1, 1)</code></td>
<td>当月</td>
<td>1</td>
<td>当月第一天</td>
<td>确定月份起始，计算星期几</td>
</tr>
<tr>
<td><code>new Date(year, month, 0)</code></td>
<td>下月</td>
<td>0</td>
<td>当月最后一天</td>
<td>获取当月天数</td>
</tr>
<tr>
<td><code>new Date(year, month-1, 0)</code></td>
<td>当月</td>
<td>0</td>
<td>上月最后一天</td>
<td>获取上月天数，填充日历前部</td>
</tr>
</tbody>
</table>
</div>
<p><strong>可视化理解：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2025年2月          2025年3月          2025年4月</span><br><span class="line">┌─────────┐      ┌─────────┐      ┌─────────┐</span><br><span class="line">│ ...     │      │         │      │         │</span><br><span class="line">│ 28 ←────┼──────┼─ 0      │      │         │</span><br><span class="line">└─────────┘      │  1 ←────┼──────┼─ 0      │</span><br><span class="line">                 │ ...     │      │  1      │</span><br><span class="line">                 │ 31 ←────┼──────┼─ 0      │</span><br><span class="line">                 └─────────┘      └─────────┘</span><br><span class="line">                 </span><br><span class="line">表达式3           表达式1           表达式2</span><br><span class="line">month-1, 0       month-1, 1       month, 0</span><br><span class="line">上月最后天        当月第一天        当月最后天</span><br></pre></td></tr></table></figure>
<p><strong>实际代码示例：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 完整的日历日期计算逻辑</span></span><br><span class="line"><span class="title function_">generateCalendar</span>(<span class="params"><span class="attr">year</span>: <span class="built_in">number</span>, <span class="attr">month</span>: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">  <span class="comment">// 1. 当月第一天（确定起始位置）</span></span><br><span class="line">  <span class="keyword">const</span> firstDay = <span class="keyword">new</span> <span class="title class_">Date</span>(year, month - <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">const</span> firstDayOfWeek = firstDay.<span class="title function_">getDay</span>()  <span class="comment">// 0-6，表示星期日到星期六</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 2. 当月最后一天（确定当月天数）</span></span><br><span class="line">  <span class="keyword">const</span> lastDay = <span class="keyword">new</span> <span class="title class_">Date</span>(year, month, <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> daysInMonth = lastDay.<span class="title function_">getDate</span>()  <span class="comment">// 28/29/30/31</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 3. 上月最后一天（填充前置日期）</span></span><br><span class="line">  <span class="keyword">const</span> prevLastDay = <span class="keyword">new</span> <span class="title class_">Date</span>(year, month - <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> prevDaysInMonth = prevLastDay.<span class="title function_">getDate</span>()</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 计算需要填充的上月日期数量</span></span><br><span class="line">  <span class="keyword">const</span> prevDaysToShow = firstDayOfWeek === <span class="number">0</span> ? <span class="number">6</span> : firstDayOfWeek - <span class="number">1</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 生成日历数组</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">calendar</span>: <span class="built_in">number</span>[] = []</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 填充上月日期</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = prevDaysToShow; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">    calendar.<span class="title function_">push</span>(prevDaysInMonth - i + <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 填充当月日期</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= daysInMonth; i++) &#123;</span><br><span class="line">    calendar.<span class="title function_">push</span>(i)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 填充下月日期（补齐到42格，6行×7列）</span></span><br><span class="line">  <span class="keyword">const</span> remainingDays = <span class="number">42</span> - calendar.<span class="property">length</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= remainingDays; i++) &#123;</span><br><span class="line">    calendar.<span class="title function_">push</span>(i)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> calendar</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例：2025年3月</span></span><br><span class="line"><span class="comment">// firstDayOfWeek = 6 (星期六)</span></span><br><span class="line"><span class="comment">// daysInMonth = 31</span></span><br><span class="line"><span class="comment">// prevDaysInMonth = 28</span></span><br><span class="line"><span class="comment">// prevDaysToShow = 5</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// 日历显示：</span></span><br><span class="line"><span class="comment">// 日 一 二 三 四 五 六</span></span><br><span class="line"><span class="comment">// 23 24 25 26 27 28  1  ← 23-28是2月，1是3月</span></span><br><span class="line"><span class="comment">//  2  3  4  5  6  7  8</span></span><br><span class="line"><span class="comment">//  9 10 11 12 13 14 15</span></span><br><span class="line"><span class="comment">// 16 17 18 19 20 21 22</span></span><br><span class="line"><span class="comment">// 23 24 25 26 27 28 29</span></span><br><span class="line"><span class="comment">// 30 31  1  2  3  4  5  ← 30-31是3月，1-5是4月</span></span><br></pre></td></tr></table></figure>
<p><strong>为什么这样设计？</strong></p>
<p>这种自动溢出处理极大简化了日期计算：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不使用溢出特性（复杂）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getLastDayOfMonth</span>(<span class="params"><span class="attr">year</span>: <span class="built_in">number</span>, <span class="attr">month</span>: <span class="built_in">number</span></span>): <span class="built_in">number</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (month === <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="comment">// 判断闰年</span></span><br><span class="line">    <span class="keyword">return</span> (year % <span class="number">4</span> === <span class="number">0</span> &amp;&amp; year % <span class="number">100</span> !== <span class="number">0</span>) || (year % <span class="number">400</span> === <span class="number">0</span>) ? <span class="number">29</span> : <span class="number">28</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="number">4</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">11</span>].<span class="title function_">includes</span>(month)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">30</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">31</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用溢出特性（简洁）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getLastDayOfMonth</span>(<span class="params"><span class="attr">year</span>: <span class="built_in">number</span>, <span class="attr">month</span>: <span class="built_in">number</span></span>): <span class="built_in">number</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(year, month, <span class="number">0</span>).<span class="title function_">getDate</span>()  <span class="comment">// 一行搞定！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>实战示例：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 场景：计算2025年2月有多少天</span></span><br><span class="line"><span class="keyword">const</span> daysInFeb2025 = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">2</span>, <span class="number">0</span>).<span class="title function_">getDate</span>()  <span class="comment">// 28天</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 场景：计算2024年2月有多少天（闰年）</span></span><br><span class="line"><span class="keyword">const</span> daysInFeb2024 = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2024</span>, <span class="number">2</span>, <span class="number">0</span>).<span class="title function_">getDate</span>()  <span class="comment">// 29天</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 场景：获取当前月份的最后一天是星期几</span></span><br><span class="line"><span class="keyword">const</span> lastDay = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">3</span>, <span class="number">0</span>)  <span class="comment">// 2025年3月31日</span></span><br><span class="line"><span class="keyword">const</span> dayOfWeek = lastDay.<span class="title function_">getDay</span>()    <span class="comment">// 1（星期一）</span></span><br></pre></td></tr></table></figure>
<p><strong>常见陷阱：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 陷阱1：忘记月份从0开始</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">3</span>, <span class="number">1</span>)   <span class="comment">// 不是3月1日，而是4月1日！</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">2</span>, <span class="number">1</span>)   <span class="comment">// 这才是3月1日</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 陷阱2：混淆monthIndex和month</span></span><br><span class="line"><span class="keyword">const</span> currentMonth = <span class="number">3</span>  <span class="comment">// 用户看到的3月</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, currentMonth, <span class="number">1</span>)      <span class="comment">// 错误：会得到4月1日</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, currentMonth - <span class="number">1</span>, <span class="number">1</span>)  <span class="comment">// 正确：得到3月1日</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 陷阱3：日期字符串解析的时区问题</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="string">&#x27;2025-03-01&#x27;</span>)           <span class="comment">// 可能是UTC时间</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">2</span>, <span class="number">1</span>)             <span class="comment">// 本地时间，更可靠</span></span><br></pre></td></tr></table></figure>
<p><strong>性能对比：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方案A：手动计算（容易出错）</span></span><br><span class="line"><span class="keyword">let</span> <span class="attr">lastDay</span>: <span class="built_in">number</span></span><br><span class="line"><span class="keyword">if</span> (month === <span class="number">2</span>) &#123;</span><br><span class="line">  lastDay = <span class="title function_">isLeapYear</span>(year) ? <span class="number">29</span> : <span class="number">28</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> ([<span class="number">4</span>,<span class="number">6</span>,<span class="number">9</span>,<span class="number">11</span>].<span class="title function_">includes</span>(month)) &#123;</span><br><span class="line">  lastDay = <span class="number">30</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  lastDay = <span class="number">31</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方案B：利用Date溢出（简洁可靠）</span></span><br><span class="line"><span class="keyword">const</span> lastDay = <span class="keyword">new</span> <span class="title class_">Date</span>(year, month, <span class="number">0</span>).<span class="title function_">getDate</span>()</span><br></pre></td></tr></table></figure>
<p>方案B不仅代码更简洁，而且由Date对象内部处理所有边界情况（闰年、大小月），完全不会出错。</p>
</div>
<p><strong>算法核心要点：</strong></p>
<ol>
<li><p><strong>为什么是42个格子？</strong></p>
<p>日历最多需要6行（某些月份第一天是周六，最后一天是周日的情况），每行7天，所以是6×7=42个格子。这样可以保证任何月份都能完整显示。</p>
</li>
<li><p><strong>上月日期的倒推计算</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = firstDayOfWeek - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">  <span class="keyword">const</span> day = prevMonthDays - i</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设当月1号是周三（firstDayOfWeek = 3），上月有31天：</p>
<ul>
<li>i = 2: day = 31 - 2 = 29（上月29号）</li>
<li>i = 1: day = 31 - 1 = 30（上月30号）</li>
<li>i = 0: day = 31 - 0 = 31（上月31号）</li>
</ul>
<p>这样就填充了周日、周一、周二三个格子。</p>
</li>
<li><p><strong>isCurrentMonth标记的妙用</strong></p>
<p>通过这个标记，我们可以在UI层对非当月日期做视觉弱化处理（比如降低透明度、改变字体颜色），让用户一眼就能区分当月和非当月的日期。</p>
</li>
</ol>
<h5 id="3-周列转换算法"><a href="#3-周列转换算法" class="headerlink" title="3. 周列转换算法"></a>3. 周列转换算法</h5><p>GitHub风格的热力图是<strong>按周分列</strong>显示的，每列代表一周（7天），而我们生成的<code>heatmapCells</code>是一个线性数组。这个算法负责将线性数组转换为二维数组。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getWeekColumns</span>(): <span class="title class_">HeatmapCell</span>[][] &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">weeks</span>: <span class="title class_">HeatmapCell</span>[][] = []</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">heatmapCells</span>.<span class="property">length</span> === <span class="number">0</span>) <span class="keyword">return</span> weeks</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> firstDayOfWeek = <span class="variable language_">this</span>.<span class="property">heatmapCells</span>[<span class="number">0</span>].<span class="property">dayOfWeek</span></span><br><span class="line">  <span class="keyword">let</span> <span class="attr">currentWeek</span>: <span class="title class_">HeatmapCell</span>[] = []</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 阶段1：填充第一周的前置空白</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; firstDayOfWeek; i++) &#123;</span><br><span class="line">    currentWeek.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">dateStr</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">      <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">color</span>: <span class="string">&#x27;transparent&#x27;</span>,  <span class="comment">// 透明色，不显示</span></span><br><span class="line">      <span class="attr">dayOfWeek</span>: i,</span><br><span class="line">      <span class="attr">dayOfMonth</span>: <span class="number">0</span>,</span><br><span class="line">      <span class="attr">month</span>: <span class="number">0</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 阶段2：遍历所有日期，按周分组</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> cell <span class="keyword">of</span> <span class="variable language_">this</span>.<span class="property">heatmapCells</span>) &#123;</span><br><span class="line">    currentWeek.<span class="title function_">push</span>(cell)</span><br><span class="line">    <span class="keyword">if</span> (currentWeek.<span class="property">length</span> === <span class="number">7</span>) &#123;  <span class="comment">// 一周满了</span></span><br><span class="line">      weeks.<span class="title function_">push</span>(currentWeek)</span><br><span class="line">      currentWeek = []  <span class="comment">// 开始新的一周</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 阶段3：填充最后一周的后置空白</span></span><br><span class="line">  <span class="keyword">if</span> (currentWeek.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">while</span> (currentWeek.<span class="property">length</span> &lt; <span class="number">7</span>) &#123;</span><br><span class="line">      currentWeek.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">dateStr</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;transparent&#x27;</span>,</span><br><span class="line">        <span class="attr">dayOfWeek</span>: currentWeek.<span class="property">length</span>,</span><br><span class="line">        <span class="attr">dayOfMonth</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">month</span>: <span class="number">0</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    weeks.<span class="title function_">push</span>(currentWeek)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> weeks</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>算法可视化示例：</strong></p>
<p>假设我们有10天的数据，第一天是周三（dayOfWeek = 3）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">输入（线性数组）：</span><br><span class="line">[Day1(周三), Day2(周四), Day3(周五), Day4(周六), Day5(周日), Day6(周一), ...]</span><br><span class="line"></span><br><span class="line">输出（二维数组）：</span><br><span class="line">Week1: [空, 空, 空, Day1, Day2, Day3, Day4]</span><br><span class="line">Week2: [Day5, Day6, Day7, Day8, Day9, Day10, 空]</span><br><span class="line">       周日  周一  周二  周三  周四  周五  周六</span><br></pre></td></tr></table></figure>
<p>这样在UI渲染时，我们只需要：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="title function_">getWeekColumns</span>(), <span class="function">(<span class="params"><span class="attr">weekCells</span>: <span class="title class_">HeatmapCell</span>[], <span class="attr">weekIndex</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">Column</span>() &#123;  <span class="comment">// 每一列代表一周</span></span><br><span class="line">    <span class="title class_">ForEach</span>(weekCells, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">HeatmapCell</span>, <span class="attr">dayIndex</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 渲染单个格子</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>就能自动形成GitHub风格的按周分列布局。</p>
<h5 id="4-颜色映射算法"><a href="#4-颜色映射算法" class="headerlink" title="4. 颜色映射算法"></a>4. 颜色映射算法</h5><p>颜色映射是热力图的灵魂，它决定了数据的视觉呈现效果。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getColorForCount</span>(<span class="attr">count</span>: <span class="built_in">number</span>): <span class="built_in">string</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> maxRange = <span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">heatmapColorRange</span>  <span class="comment">// 用户设置的最大值，如10篇</span></span><br><span class="line">  <span class="keyword">const</span> ratio = <span class="title class_">Math</span>.<span class="title function_">min</span>(count / maxRange, <span class="number">1</span>)  <span class="comment">// 计算比例，最大为1</span></span><br><span class="line">  <span class="keyword">const</span> scheme = <span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">heatmapColorScheme</span>  <span class="comment">// 颜色方案</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 蓝色方案的特殊处理</span></span><br><span class="line">  <span class="keyword">if</span> (scheme === <span class="title class_">HeatmapColorScheme</span>.<span class="property">BLUE</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> blueColors = [<span class="string">&#x27;#2d333b&#x27;</span>, <span class="string">&#x27;#1e3a5f&#x27;</span>, <span class="string">&#x27;#2563eb&#x27;</span>, <span class="string">&#x27;#60a5fa&#x27;</span>, <span class="string">&#x27;#93c5fd&#x27;</span>]</span><br><span class="line">    <span class="keyword">if</span> (count === <span class="number">0</span>) <span class="keyword">return</span> blueColors[<span class="number">0</span>]  <span class="comment">// 无数据：深灰色</span></span><br><span class="line">    <span class="keyword">if</span> (ratio &lt;= <span class="number">0.25</span>) <span class="keyword">return</span> blueColors[<span class="number">1</span>]  <span class="comment">// 0-25%：深蓝</span></span><br><span class="line">    <span class="keyword">if</span> (ratio &lt;= <span class="number">0.5</span>) <span class="keyword">return</span> blueColors[<span class="number">2</span>]   <span class="comment">// 25-50%：中蓝</span></span><br><span class="line">    <span class="keyword">if</span> (ratio &lt;= <span class="number">0.75</span>) <span class="keyword">return</span> blueColors[<span class="number">3</span>]  <span class="comment">// 50-75%：浅蓝</span></span><br><span class="line">    <span class="keyword">return</span> blueColors[<span class="number">4</span>]  <span class="comment">// 75-100%：亮蓝</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 其他颜色方案</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">colorSchemes</span>: <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">string</span>[]&gt; = &#123;</span><br><span class="line">    [<span class="title class_">HeatmapColorScheme</span>.<span class="property">GREEN</span>]: [<span class="string">&#x27;#2d333b&#x27;</span>, <span class="string">&#x27;#0e4429&#x27;</span>, <span class="string">&#x27;#006d32&#x27;</span>, <span class="string">&#x27;#26a641&#x27;</span>, <span class="string">&#x27;#39d353&#x27;</span>],</span><br><span class="line">    [<span class="title class_">HeatmapColorScheme</span>.<span class="property">RED</span>]: [<span class="string">&#x27;#2d333b&#x27;</span>, <span class="string">&#x27;#5c2121&#x27;</span>, <span class="string">&#x27;#8b3d3d&#x27;</span>, <span class="string">&#x27;#d35f5f&#x27;</span>, <span class="string">&#x27;#ff8080&#x27;</span>],</span><br><span class="line">    [<span class="title class_">HeatmapColorScheme</span>.<span class="property">GRAY</span>]: [<span class="string">&#x27;#2d333b&#x27;</span>, <span class="string">&#x27;#404040&#x27;</span>, <span class="string">&#x27;#606060&#x27;</span>, <span class="string">&#x27;#909090&#x27;</span>, <span class="string">&#x27;#c0c0c0&#x27;</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> colors = colorSchemes[scheme] || colorSchemes[<span class="title class_">HeatmapColorScheme</span>.<span class="property">GREEN</span>]</span><br><span class="line">  <span class="keyword">if</span> (count === <span class="number">0</span>) <span class="keyword">return</span> colors[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">if</span> (ratio &lt;= <span class="number">0.25</span>) <span class="keyword">return</span> colors[<span class="number">1</span>]</span><br><span class="line">  <span class="keyword">if</span> (ratio &lt;= <span class="number">0.5</span>) <span class="keyword">return</span> colors[<span class="number">2</span>]</span><br><span class="line">  <span class="keyword">if</span> (ratio &lt;= <span class="number">0.75</span>) <span class="keyword">return</span> colors[<span class="number">3</span>]</span><br><span class="line">  <span class="keyword">return</span> colors[<span class="number">4</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>颜色分级策略：</strong></p>
<p>这里采用了<strong>5级颜色分级</strong>，而不是线性渐变，原因有两个：</p>
<ol>
<li><strong>视觉区分度更高</strong>：离散的颜色级别比连续渐变更容易让用户快速识别数据差异</li>
<li><strong>性能更好</strong>：不需要实时计算RGB插值，直接返回预定义的颜色值</li>
</ol>
<p>颜色分级的阈值设计也很讲究：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0%        25%       50%       75%       100%</span><br><span class="line">├─────────┼─────────┼─────────┼─────────┤</span><br><span class="line">无数据    少量      中等      较多      很多</span><br></pre></td></tr></table></figure>
<p>这种<strong>非线性分级</strong>更符合人类的感知习惯。比如从0篇到2篇的差异，在视觉上应该比从8篇到10篇的差异更明显，因为前者代表了”从无到有”的质变。</p>
<h5 id="5-性能优化要点"><a href="#5-性能优化要点" class="headerlink" title="5. 性能优化要点"></a>5. 性能优化要点</h5><p>在实际使用中，我发现了几个性能瓶颈并进行了优化：</p>
<p><strong>优化1：使用Map代替数组查询</strong></p>
<p>在日历热力图的渲染过程中，我们需要频繁地根据日期字符串查询对应的统计数据。这个查询操作在渲染42个日历格子时会被调用42次，如果使用数组查询，性能会成为瓶颈。</p>
<p><strong>问题分析：数组查询的性能瓶颈</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 优化前：使用数组存储和查询</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CalendarViewModel</span> &#123;</span><br><span class="line">  <span class="comment">// 数据结构：数组</span></span><br><span class="line">  <span class="attr">dailyStats</span>: <span class="title class_">DailyStat</span>[] = []  <span class="comment">// 例如：365个元素（一年的数据）</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 查询方法：使用 Array.find()</span></span><br><span class="line">  <span class="title function_">getCountForDate</span>(<span class="attr">dateStr</span>: <span class="built_in">string</span>): <span class="built_in">number</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> stat = <span class="variable language_">this</span>.<span class="property">dailyStats</span>.<span class="title function_">find</span>(<span class="function"><span class="params">s</span> =&gt;</span> s.<span class="property">dateStr</span> === dateStr)</span><br><span class="line">    <span class="keyword">return</span> stat ? stat.<span class="property">count</span> : <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 渲染日历时的调用</span></span><br><span class="line">  <span class="title function_">generateCalendarDays</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">42</span>; i++) &#123;  <span class="comment">// 42个格子</span></span><br><span class="line">      <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(someDate)</span><br><span class="line">      <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="title function_">getCountForDate</span>(dateStr)  <span class="comment">// 每次都要遍历数组！</span></span><br><span class="line">      <span class="comment">// ... 渲染逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>性能问题：</strong></p>
<ol>
<li><p><strong>时间复杂度：O(n)</strong></p>
<ul>
<li><code>Array.find()</code> 需要遍历数组直到找到匹配项</li>
<li>最坏情况：遍历整个数组（365次比较）</li>
<li>平均情况：遍历一半数组（182次比较）</li>
</ul>
</li>
<li><p><strong>总体开销：O(m × n)</strong></p>
<ul>
<li>m = 日历格子数量（42个）</li>
<li>n = 统计数据数量（365个）</li>
<li>总比较次数：42 × 182 ≈ 7,644次</li>
</ul>
</li>
<li><p><strong>实际影响：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设每次比较耗时 0.001ms</span></span><br><span class="line"><span class="comment">// 渲染一次日历：7,644 × 0.001ms ≈ 7.6ms</span></span><br><span class="line"><span class="comment">// 如果用户频繁切换月份，会感觉到明显卡顿</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>解决方案：使用Map进行O(1)查询</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 优化后：使用Map存储和查询</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CalendarViewModel</span> &#123;</span><br><span class="line">  <span class="comment">// 数据结构1：数组（保留，用于遍历和排序）</span></span><br><span class="line">  <span class="attr">dailyStats</span>: <span class="title class_">DailyStat</span>[] = []</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 数据结构2：Map（新增，用于快速查询）</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">statsMap</span>: <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="built_in">number</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 数据加载时构建Map</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadDailyStats</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 从数据库加载数据到数组</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dailyStats</span> = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">fetchStatsFromDB</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 构建Map索引（一次性操作）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">clear</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dailyStats</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">stat</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">set</span>(stat.<span class="property">dateStr</span>, stat.<span class="property">count</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 时间复杂度：O(n)，但只执行一次</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 查询方法：使用 Map.get()</span></span><br><span class="line">  <span class="title function_">getCountForDate</span>(<span class="attr">dateStr</span>: <span class="built_in">string</span>): <span class="built_in">number</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr) || <span class="number">0</span>  <span class="comment">// O(1) 查询！</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 渲染日历时的调用</span></span><br><span class="line">  <span class="title function_">generateCalendarDays</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">42</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(someDate)</span><br><span class="line">      <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="title function_">getCountForDate</span>(dateStr)  <span class="comment">// 瞬间完成！</span></span><br><span class="line">      <span class="comment">// ... 渲染逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>性能提升：</strong></p>
<ol>
<li><p><strong>时间复杂度：O(1)</strong></p>
<ul>
<li>Map使用哈希表实现</li>
<li>查询时间与数据量无关</li>
<li>每次查询只需要1次哈希计算</li>
</ul>
</li>
<li><p><strong>总体开销：O(m)</strong></p>
<ul>
<li>m = 日历格子数量（42个）</li>
<li>总查询次数：42次（每次O(1)）</li>
<li>构建Map的成本：O(n) = 365次（只执行一次）</li>
</ul>
</li>
<li><p><strong>实际对比：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 优化前：</span></span><br><span class="line"><span class="comment">// 每次渲染：7,644次比较 ≈ 7.6ms</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 优化后：</span></span><br><span class="line"><span class="comment">// 构建Map：365次插入 ≈ 0.4ms（只在数据加载时执行一次）</span></span><br><span class="line"><span class="comment">// 每次渲染：42次查询 ≈ 0.04ms</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 性能提升：7.6ms → 0.04ms ≈ 190倍！</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>Map的工作原理：哈希表</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Map内部使用哈希表实现</span></span><br><span class="line"><span class="comment">// 简化示意（实际实现更复杂）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleMap</span>&lt;K, V&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">buckets</span>: <span class="title class_">Array</span>&lt;<span class="title class_">Array</span>&lt;[K, V]&gt;&gt; = []</span><br><span class="line">  <span class="keyword">private</span> size = <span class="number">16</span>  <span class="comment">// 初始桶数量</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 哈希函数：将key转换为数组索引</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">hash</span>(<span class="attr">key</span>: K): <span class="built_in">number</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> str = <span class="title class_">String</span>(key)</span><br><span class="line">    <span class="keyword">let</span> hash = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; str.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      hash = (hash &lt;&lt; <span class="number">5</span>) - hash + str.<span class="title function_">charCodeAt</span>(i)</span><br><span class="line">      hash = hash &amp; hash  <span class="comment">// 转换为32位整数</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">abs</span>(hash) % <span class="variable language_">this</span>.<span class="property">size</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 设置值：O(1)</span></span><br><span class="line">  <span class="title function_">set</span>(<span class="attr">key</span>: K, <span class="attr">value</span>: V): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="title function_">hash</span>(key)</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">buckets</span>[index]) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">buckets</span>[index] = []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 查找是否已存在</span></span><br><span class="line">    <span class="keyword">const</span> bucket = <span class="variable language_">this</span>.<span class="property">buckets</span>[index]</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; bucket.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (bucket[i][<span class="number">0</span>] === key) &#123;</span><br><span class="line">        bucket[i][<span class="number">1</span>] = value  <span class="comment">// 更新</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    bucket.<span class="title function_">push</span>([key, value])  <span class="comment">// 新增</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 获取值：O(1)</span></span><br><span class="line">  <span class="title function_">get</span>(<span class="attr">key</span>: K): V | <span class="literal">undefined</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="title function_">hash</span>(key)</span><br><span class="line">    <span class="keyword">const</span> bucket = <span class="variable language_">this</span>.<span class="property">buckets</span>[index]</span><br><span class="line">    <span class="keyword">if</span> (!bucket) <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; bucket.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (bucket[i][<span class="number">0</span>] === key) &#123;</span><br><span class="line">        <span class="keyword">return</span> bucket[i][<span class="number">1</span>]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用示例</span></span><br><span class="line"><span class="keyword">const</span> map = <span class="keyword">new</span> <span class="title class_">SimpleMap</span>&lt;<span class="built_in">string</span>, <span class="built_in">number</span>&gt;()</span><br><span class="line">map.<span class="title function_">set</span>(<span class="string">&#x27;2025-03-15&#x27;</span>, <span class="number">5</span>)  <span class="comment">// 计算哈希 → 存入对应桶</span></span><br><span class="line"><span class="keyword">const</span> count = map.<span class="title function_">get</span>(<span class="string">&#x27;2025-03-15&#x27;</span>)  <span class="comment">// 计算哈希 → 从对应桶取出</span></span><br></pre></td></tr></table></figure>
<p><strong>为什么Map查询是O(1)？</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查询过程分解</span></span><br><span class="line"><span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(<span class="string">&#x27;2025-03-15&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤1：计算哈希值（固定时间）</span></span><br><span class="line"><span class="keyword">const</span> hash = <span class="title function_">hashFunction</span>(<span class="string">&#x27;2025-03-15&#x27;</span>)  <span class="comment">// 例如：hash = 42</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤2：定位桶（数组索引，固定时间）</span></span><br><span class="line"><span class="keyword">const</span> bucket = buckets[hash % bucketSize]  <span class="comment">// buckets[42]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤3：在桶内查找（通常只有1个元素）</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> [key, value] <span class="keyword">of</span> bucket) &#123;</span><br><span class="line">  <span class="keyword">if</span> (key === <span class="string">&#x27;2025-03-15&#x27;</span>) <span class="keyword">return</span> value</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 总时间：O(1) + O(1) + O(1) = O(1)</span></span><br><span class="line"><span class="comment">// 注：理想情况下每个桶只有1个元素，即使有冲突也很少</span></span><br></pre></td></tr></table></figure>
<p><strong>完整的实现示例：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据结构定义</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">DailyStat</span> &#123;</span><br><span class="line">  <span class="attr">dateStr</span>: <span class="built_in">string</span>    <span class="comment">// &#x27;2025-03-15&#x27;</span></span><br><span class="line">  <span class="attr">count</span>: <span class="built_in">number</span>      <span class="comment">// 5</span></span><br><span class="line">  <span class="attr">color</span>?: <span class="built_in">string</span>     <span class="comment">// &#x27;#4caf50&#x27;（可选，预计算的颜色）</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CalendarViewModel</span> &#123;</span><br><span class="line">  <span class="comment">// 双数据结构策略</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">dailyStats</span>: <span class="title class_">DailyStat</span>[] = []           <span class="comment">// 用于遍历、排序</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">statsMap</span>: <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">DailyStat</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>()  <span class="comment">// 用于快速查询</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 加载统计数据</span></span><br><span class="line"><span class="comment">   * 时间复杂度：O(n)，但只在数据变化时执行</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">loadDailyStats</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// 1. 从数据库加载</span></span><br><span class="line">    <span class="keyword">const</span> stats = <span class="keyword">await</span> kvDatabase.<span class="property">get</span>&lt;<span class="title class_">DailyStat</span>[]&gt;(<span class="string">&#x27;daily_stats&#x27;</span>) || []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dailyStats</span> = stats</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 构建Map索引</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">clear</span>()</span><br><span class="line">    stats.<span class="title function_">forEach</span>(<span class="function"><span class="params">stat</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 存储完整对象，不只是count</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">set</span>(stat.<span class="property">dateStr</span>, stat)</span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`加载了 <span class="subst">$&#123;stats.length&#125;</span> 条统计数据，构建了 <span class="subst">$&#123;<span class="variable language_">this</span>.statsMap.size&#125;</span> 个索引`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查询指定日期的统计数据</span></span><br><span class="line"><span class="comment">   * 时间复杂度：O(1)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">getStatForDate</span>(<span class="attr">dateStr</span>: <span class="built_in">string</span>): <span class="title class_">DailyStat</span> | <span class="literal">null</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr) || <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查询指定日期的计数</span></span><br><span class="line"><span class="comment">   * 时间复杂度：O(1)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">getCountForDate</span>(<span class="attr">dateStr</span>: <span class="built_in">string</span>): <span class="built_in">number</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> stat = <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr)</span><br><span class="line">    <span class="keyword">return</span> stat ? stat.<span class="property">count</span> : <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 生成日历格子数据</span></span><br><span class="line"><span class="comment">   * 时间复杂度：O(42) = O(1)（常数时间）</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">generateCalendarDays</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="attr">days</span>: <span class="title class_">CalendarDay</span>[] = []</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算日历范围（省略具体逻辑）</span></span><br><span class="line">    <span class="keyword">const</span> startDate = <span class="variable language_">this</span>.<span class="title function_">getCalendarStartDate</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">42</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> currentDate = <span class="keyword">new</span> <span class="title class_">Date</span>(startDate)</span><br><span class="line">      currentDate.<span class="title function_">setDate</span>(startDate.<span class="title function_">getDate</span>() + i)</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(currentDate)</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 关键：O(1)查询！</span></span><br><span class="line">      <span class="keyword">const</span> stat = <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr)</span><br><span class="line">      <span class="keyword">const</span> count = stat ? stat.<span class="property">count</span> : <span class="number">0</span></span><br><span class="line">      <span class="keyword">const</span> color = stat?.<span class="property">color</span> || <span class="variable language_">this</span>.<span class="title function_">getDefaultColor</span>()</span><br><span class="line">      </span><br><span class="line">      days.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">date</span>: currentDate.<span class="title function_">getDate</span>(),</span><br><span class="line">        <span class="attr">dateStr</span>: dateStr,</span><br><span class="line">        <span class="attr">count</span>: count,</span><br><span class="line">        <span class="attr">color</span>: color,</span><br><span class="line">        <span class="attr">isCurrentMonth</span>: <span class="variable language_">this</span>.<span class="title function_">isCurrentMonth</span>(currentDate)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">calendarDays</span> = days</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 格式化日期为字符串</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">formatDate</span>(<span class="attr">date</span>: <span class="title class_">Date</span>): <span class="built_in">string</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> year = date.<span class="title function_">getFullYear</span>()</span><br><span class="line">    <span class="keyword">const</span> month = <span class="title class_">String</span>(date.<span class="title function_">getMonth</span>() + <span class="number">1</span>).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> day = <span class="title class_">String</span>(date.<span class="title function_">getDate</span>()).<span class="title function_">padStart</span>(<span class="number">2</span>, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;year&#125;</span>-<span class="subst">$&#123;month&#125;</span>-<span class="subst">$&#123;day&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>性能测试对比：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 性能测试代码</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">performanceTest</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 准备测试数据：365天的统计</span></span><br><span class="line">  <span class="keyword">const</span> <span class="attr">testData</span>: <span class="title class_">DailyStat</span>[] = []</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">365</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2025</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    date.<span class="title function_">setDate</span>(date.<span class="title function_">getDate</span>() + i)</span><br><span class="line">    testData.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">dateStr</span>: <span class="title function_">formatDate</span>(date),</span><br><span class="line">      <span class="attr">count</span>: <span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">10</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 测试1：数组查询（优化前）</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">time</span>(<span class="string">&#x27;数组查询&#x27;</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">42</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> dateStr = testData[<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">365</span>)].<span class="property">dateStr</span></span><br><span class="line">    <span class="keyword">const</span> stat = testData.<span class="title function_">find</span>(<span class="function"><span class="params">s</span> =&gt;</span> s.<span class="property">dateStr</span> === dateStr)</span><br><span class="line">    <span class="keyword">const</span> count = stat ? stat.<span class="property">count</span> : <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">timeEnd</span>(<span class="string">&#x27;数组查询&#x27;</span>)</span><br><span class="line">  <span class="comment">// 输出：数组查询: 8.234ms</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 测试2：Map查询（优化后）</span></span><br><span class="line">  <span class="keyword">const</span> statsMap = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="built_in">number</span>&gt;()</span><br><span class="line">  testData.<span class="title function_">forEach</span>(<span class="function"><span class="params">stat</span> =&gt;</span> statsMap.<span class="title function_">set</span>(stat.<span class="property">dateStr</span>, stat.<span class="property">count</span>))</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">time</span>(<span class="string">&#x27;Map查询&#x27;</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">42</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> dateStr = testData[<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>() * <span class="number">365</span>)].<span class="property">dateStr</span></span><br><span class="line">    <span class="keyword">const</span> count = statsMap.<span class="title function_">get</span>(dateStr) || <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">timeEnd</span>(<span class="string">&#x27;Map查询&#x27;</span>)</span><br><span class="line">  <span class="comment">// 输出：Map查询: 0.043ms</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 性能提升：8.234 / 0.043 ≈ 191倍！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>内存开销分析：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数组方式（优化前）</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">dailyStats</span>: <span class="title class_">DailyStat</span>[] = []  <span class="comment">// 365个对象</span></span><br><span class="line"><span class="comment">// 内存占用：365 × (对象大小) ≈ 365 × 100字节 ≈ 36KB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Map方式（优化后）</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">dailyStats</span>: <span class="title class_">DailyStat</span>[] = []  <span class="comment">// 365个对象</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">statsMap</span>: <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">DailyStat</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>()  <span class="comment">// 365个键值对</span></span><br><span class="line"><span class="comment">// 内存占用：</span></span><br><span class="line"><span class="comment">// - 数组：36KB</span></span><br><span class="line"><span class="comment">// - Map：365 × (key大小 + 指针大小) ≈ 365 × 20字节 ≈ 7KB</span></span><br><span class="line"><span class="comment">// - 总计：43KB</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 内存增加：7KB（约19%）</span></span><br><span class="line"><span class="comment">// 性能提升：191倍</span></span><br><span class="line"><span class="comment">// 结论：用19%的内存换取191倍的性能，非常值得！</span></span><br></pre></td></tr></table></figure>
<p><strong>何时使用Map？</strong></p>
<p>✅ <strong>适合使用Map的场景：</strong></p>
<ul>
<li>需要频繁根据key查询value</li>
<li>数据量较大（&gt;100个元素）</li>
<li>key是字符串或数字</li>
<li>查询频率远高于插入/删除频率</li>
</ul>
<p>❌ <strong>不适合使用Map的场景：</strong></p>
<ul>
<li>数据量很小（&lt;10个元素），数组遍历更快</li>
<li>需要保持特定顺序（Map保持插入顺序，但不支持排序）</li>
<li>需要频繁遍历所有元素（数组遍历更快）</li>
<li>内存非常受限的环境</li>
</ul>
<p><strong>最佳实践：双数据结构策略</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CalendarViewModel</span> &#123;</span><br><span class="line">  <span class="comment">// 策略：同时维护数组和Map</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">dailyStats</span>: <span class="title class_">DailyStat</span>[] = []        <span class="comment">// 用于遍历、排序、展示</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">statsMap</span>: <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">DailyStat</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>()  <span class="comment">// 用于快速查询</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 优点1：查询快速（Map）</span></span><br><span class="line">  <span class="title function_">getCountForDate</span>(<span class="attr">dateStr</span>: <span class="built_in">string</span>): <span class="built_in">number</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr)?.<span class="property">count</span> || <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 优点2：遍历方便（数组）</span></span><br><span class="line">  <span class="title function_">getAllStats</span>(): <span class="title class_">DailyStat</span>[] &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">dailyStats</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 优点3：排序方便（数组）</span></span><br><span class="line">  <span class="title function_">getTopDays</span>(<span class="attr">limit</span>: <span class="built_in">number</span>): <span class="title class_">DailyStat</span>[] &#123;</span><br><span class="line">    <span class="keyword">return</span> [...<span class="variable language_">this</span>.<span class="property">dailyStats</span>]</span><br><span class="line">      .<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> b.<span class="property">count</span> - a.<span class="property">count</span>)</span><br><span class="line">      .<span class="title function_">slice</span>(<span class="number">0</span>, limit)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 维护成本：数据更新时同步两个结构</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">updateStat</span>(<span class="attr">dateStr</span>: <span class="built_in">string</span>, <span class="attr">count</span>: <span class="built_in">number</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">    <span class="comment">// 1. 更新数组</span></span><br><span class="line">    <span class="keyword">const</span> index = <span class="variable language_">this</span>.<span class="property">dailyStats</span>.<span class="title function_">findIndex</span>(<span class="function"><span class="params">s</span> =&gt;</span> s.<span class="property">dateStr</span> === dateStr)</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dailyStats</span>[index].<span class="property">count</span> = count</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dailyStats</span>.<span class="title function_">push</span>(&#123; dateStr, count &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 更新Map</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">set</span>(dateStr, <span class="variable language_">this</span>.<span class="property">dailyStats</span>[index &gt;= <span class="number">0</span> ? index : <span class="variable language_">this</span>.<span class="property">dailyStats</span>.<span class="property">length</span> - <span class="number">1</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 持久化</span></span><br><span class="line">    <span class="keyword">await</span> kvDatabase.<span class="title function_">set</span>(<span class="string">&#x27;daily_stats&#x27;</span>, <span class="variable language_">this</span>.<span class="property">dailyStats</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>总结：</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>对比项</th>
<th>数组查询</th>
<th>Map查询</th>
</tr>
</thead>
<tbody>
<tr>
<td>时间复杂度</td>
<td>O(n)</td>
<td>O(1)</td>
</tr>
<tr>
<td>42次查询耗时</td>
<td>~7.6ms</td>
<td>~0.04ms</td>
</tr>
<tr>
<td>性能提升</td>
<td>-</td>
<td>191倍</td>
</tr>
<tr>
<td>内存增加</td>
<td>-</td>
<td>+19%</td>
</tr>
<tr>
<td>代码复杂度</td>
<td>简单</td>
<td>稍复杂（需维护两个结构）</td>
</tr>
<tr>
<td>适用场景</td>
<td>小数据量</td>
<td>大数据量+频繁查询</td>
</tr>
</tbody>
</table>
</div>
<p>在日历热力图这个场景中，使用Map优化是非常明智的选择，因为：</p>
<ol>
<li>数据量大（365天）</li>
<li>查询频繁（每次渲染42次）</li>
<li>内存开销可接受（+7KB）</li>
<li>性能提升显著（191倍）</li>
</ol>
<p>这就是为什么我们要用Map代替数组查询的原因。</p>
<p><strong>优化2：避免重复计算</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在数据加载时一次性计算所有颜色</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">dailyStats</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">stat</span> =&gt;</span> &#123;</span><br><span class="line">  stat.<span class="property">color</span> = <span class="variable language_">this</span>.<span class="title function_">getColorForCount</span>(stat.<span class="property">count</span>)  <span class="comment">// 预计算</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 渲染时直接使用</span></span><br><span class="line"><span class="keyword">const</span> color = stat.<span class="property">color</span>  <span class="comment">// 不需要重新计算</span></span><br></pre></td></tr></table></figure>
<p><strong>优化3：监听器的精细化控制</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Monitor</span>(<span class="string">&#x27;userConfig.heatmapTimeRange&#x27;</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">onTimeRangeChange</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">loadDailyStats</span>()  <span class="comment">// 需要重新加载数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Monitor</span>(<span class="string">&#x27;userConfig.heatmapColorRange&#x27;</span>)</span><br><span class="line"><span class="title function_">onColorRangeChange</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">generateHeatmapCells</span>()  <span class="comment">// 只需要重新计算颜色</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">generateCalendarDays</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不同的配置变化触发不同级别的更新，避免不必要的数据重载。</p>
<hr>
<h4 id="热力数据核心数据结构与数据解析存储算法"><a href="#热力数据核心数据结构与数据解析存储算法" class="headerlink" title="热力数据核心数据结构与数据解析存储算法"></a>热力数据核心数据结构与数据解析存储算法</h4><p>鸿蒙所给出的数据库接口中总共有三种接口，分别是关系型数据库，键值数据库以及向量数据库。向量数据库并不适用于当前的存储场景，同时剩余的两种数据库存储的本质都是一些简单类型，我们为了能存储按日期划分的历史记录数据就需要进行一些数据结构上的逻辑转化。我们当前应用使用的是键值数据库，为了应用整体的数据处理风格的一致性，我们选择使用<mark class="hl-label red">以功能模块为键，以json字符串为值</mark>的形式去进行数据的存储。</p>
<p>接下来我们来分析一下核心历史记录处理函数的处理细节。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取每日阅读统计 Map</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 日期到统计数据的 Map</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">getDailyStatsMap</span>(): <span class="title class_">Promise</span>&lt;<span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">DailyReadingStats</span>&gt;&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">appKVDb</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> statsMap = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="title class_">DailyReadingStats</span>&gt;()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">appKVDb</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> statsMap</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">appKVDb</span>.<span class="title function_">get</span>(<span class="variable constant_">KV_DB_KEYS</span>.<span class="property">DAILY_READING_STATS</span>) <span class="keyword">as</span> <span class="built_in">string</span></span><br><span class="line">    <span class="keyword">const</span> statsArray = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(data) <span class="keyword">as</span> <span class="title class_">DailyReadingStats</span>[]</span><br><span class="line">    statsArray.<span class="title function_">forEach</span>(<span class="function"><span class="params">stats</span> =&gt;</span> &#123;</span><br><span class="line">      statsMap.<span class="title function_">set</span>(stats.<span class="property">dateStr</span>, stats)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.HISTORY_MANAGER&#125;</span>每日统计数据为空或读取失败`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> statsMap</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>getDailyStatsMap()</code>函数是直接对数据库数据进行读取以及格式转化的函数。其核心逻辑与此前提到的渲染和新函数是同样的，都是<mark class="hl-label pink">维护双数据结构</mark>，利用Map来进行快速查找。</p>
<p>这一部分使用Map进行查找速度优化的核心原因在于，随着日期的增长，每日都会单独新增一个日期标识Key，如果仅使用数组进行对象的存储的话，我们每次都需要遍历整个数据，并逐一访问对象中的<code>dateStr</code>属性，直到找到对应的日期进行计数得出结果，而Map则可以直接通过Key进行查找，以<code>dateStr</code>属性为Key就可以通过极少的哈希计算获取当日的阅读量数据，大大提高了查找速度。</p>
<p>同时为了进一步的优化查找速度，我们在Map的Value对象中还单独设置了一个字段为<code>count</code>，源码如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 每日阅读统计接口</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 用于存储用户每天阅读的新闻数量统计</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@interface</span> <span class="variable">DailyReadingStats</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">DailyReadingStats</span> &#123;</span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   * 日期字符串，格式：YYYY-MM-DD</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span> &quot;2025-12-04&quot;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">dateStr</span>: <span class="built_in">string</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   * 当天阅读的新闻数量（已去重）</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">count</span>: <span class="built_in">number</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 当天阅读的新闻ID集合（用于去重）</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">articleIds</span>: <span class="built_in">string</span>[]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们每次存入的时候将存入的数据条数加到<code>count</code>字段中，这样我们每次查询的时候就可以直接获取到当日的阅读量，而不需要再进行遍历查找。单独维护一个简单类型的字段成本比遍历数组要小多了。</p>
<div class="note info flat"><p>这里我们还可以注意到在<code>DailyReadingStats</code>接口中的<code>articleIds</code>字段存储的仅仅是文章ID，而不是完整文章对象，也不是完整的历史记录对象，这也是为了防止相同数据的重复存储，为了理解这里的逻辑我们需要从实际的使用场景来去理解。</p>
<p>用户点开热力日历页面之后首先要看到的是已经渲染好的热力日历，而不是每日的阅读记录，每日阅读记录是用户点击对应日期格子后仅需查找对应一天的数据即可，并不需要像是在渲染日历时需要全部日期的全部数据都遍历一次。</p>
<blockquote>
<p>所以我们维护<code>articleIds</code>数组的目的仅仅是为了<strong>去重</strong>，如果此时还存储完整对象，只会增加我们的存储成本以及查找的深度。</p>
</blockquote>
</div>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 更新每日阅读统计</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">articleId</span> - 文章 ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">dateStr</span> - 日期字符串 (YYYY-MM-DD)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">updateDailyStats</span>(<span class="attr">articleId</span>: <span class="built_in">string</span>, <span class="attr">dateStr</span>: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">appKVDb</span>) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">init</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">appKVDb</span>) &#123;</span><br><span class="line">    logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.HISTORY_MANAGER&#125;</span>数据库未初始化，无法更新每日统计`</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> statsMap = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">getDailyStatsMap</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!statsMap.<span class="title function_">has</span>(dateStr)) &#123;</span><br><span class="line">      statsMap.<span class="title function_">set</span>(dateStr, &#123;</span><br><span class="line">        <span class="attr">dateStr</span>: dateStr,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">articleIds</span>: []</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> dayStats = statsMap.<span class="title function_">get</span>(dateStr)!</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 检查当天是否已经阅读过该文章（去重）</span></span><br><span class="line">    <span class="keyword">if</span> (!dayStats.<span class="property">articleIds</span>.<span class="title function_">includes</span>(articleId)) &#123;</span><br><span class="line">      dayStats.<span class="property">articleIds</span>.<span class="title function_">push</span>(articleId)</span><br><span class="line">      dayStats.<span class="property">count</span> = dayStats.<span class="property">articleIds</span>.<span class="property">length</span></span><br><span class="line">      statsMap.<span class="title function_">set</span>(dateStr, dayStats)</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 保存到数据库</span></span><br><span class="line">      <span class="keyword">const</span> statsArray = <span class="title class_">Array</span>.<span class="title function_">from</span>(statsMap.<span class="title function_">values</span>())</span><br><span class="line">      <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">appKVDb</span>.<span class="title function_">put</span>(<span class="variable constant_">KV_DB_KEYS</span>.<span class="property">DAILY_READING_STATS</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(statsArray))</span><br><span class="line">      logger.<span class="title function_">debug</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.HISTORY_MANAGER&#125;</span>更新每日统计: <span class="subst">$&#123;dateStr&#125;</span>, 数量: <span class="subst">$&#123;dayStats.count&#125;</span>`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="keyword">let</span> err = error <span class="keyword">as</span> <span class="title class_">BusinessError</span></span><br><span class="line">    logger.<span class="title function_">error</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.HISTORY_MANAGER&#125;</span>更新每日统计失败: <span class="subst">$&#123;err.message&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>updateDailyStats()</code>函数则是对应的项数据库中写入热力历史记录数据的关键函数，我们首先回顾一下整体的数据链条逻辑。</p>
<p><img src="/2025/11/18/HongYiXun/8.webp" alt="8"></p>
<p>在用户点进文章后文章NavPage首先调用的是历史记录Manager的<code>addHistory()</code>函数，这个函数会首先将完整的文章对象转化为历史记录对象进行存储，随后将文章ID传给<code>updateDailyStats()</code>函数，随后通过<code>getDailyStatsMap()</code>函数获取当前持久化数据的Map对象，进行去重以及不重复数据的写入。</p>
<p>对于持久化到数据库的部分，我们则直接使用数组内置函数<code>Array.from</code>来将Map的内置函数<code>values()</code>返回的迭代器转化为数组，随后将数组转化为JSON字符串进行存储。</p>
<details class="toggle"><summary class="toggle-button" style>迭代器概念简介</summary><div class="toggle-content"><p>在ArkTS以及其他大部分语言中，迭代器是一种设计模式，它提供了一种方法来访问一个容器对象中的各个元素，而不需要暴露该对象的内部表示。常见的迭代器包括数组的内置方法如<code>forEach</code>、<code>map</code>、<code>filter</code>等，以及ES6标准提供的<code>Iterator</code>接口。</p>
<p>以下是一些ArkTS中常用的迭代器概念及其实现：</p>
<p>一、数组迭代器方法</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例：使用不同迭代器方法处理数组</span></span><br><span class="line"><span class="keyword">let</span> numbers = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// map - 转换每个元素并返回新数组</span></span><br><span class="line"><span class="keyword">let</span> doubled = numbers.<span class="title function_">map</span>(<span class="function"><span class="params">num</span> =&gt;</span> num * <span class="number">2</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Map result:&#x27;</span>, doubled); <span class="comment">// 输出: [2, 4, 6, 8, 10]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// filter - 筛选满足条件的元素</span></span><br><span class="line"><span class="keyword">let</span> evens = numbers.<span class="title function_">filter</span>(<span class="function"><span class="params">num</span> =&gt;</span> num % <span class="number">2</span> === <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Filter result:&#x27;</span>, evens); <span class="comment">// 输出: [2, 4]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// forEach - 遍历每个元素（无返回值）</span></span><br><span class="line">numbers.<span class="title function_">forEach</span>(<span class="function">(<span class="params">num, index</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Index <span class="subst">$&#123;index&#125;</span>: <span class="subst">$&#123;num&#125;</span>`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 输出:</span></span><br><span class="line"><span class="comment">// Index 0: 1</span></span><br><span class="line"><span class="comment">// Index 1: 2</span></span><br><span class="line"><span class="comment">// Index 2: 3</span></span><br><span class="line"><span class="comment">// Index 3: 4</span></span><br><span class="line"><span class="comment">// Index 4: 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// reduce - 将数组元素累积为单个值</span></span><br><span class="line"><span class="keyword">let</span> sum = numbers.<span class="title function_">reduce</span>(<span class="function">(<span class="params">acc, curr</span>) =&gt;</span> acc + curr, <span class="number">0</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Reduce result:&#x27;</span>, sum); <span class="comment">// 输出: 15</span></span><br></pre></td></tr></table></figure>
<p>二、Map和Set的迭代器</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Map迭代器示例</span></span><br><span class="line"><span class="keyword">let</span> userMap = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="built_in">number</span>&gt;();</span><br><span class="line">userMap.<span class="title function_">set</span>(<span class="string">&#x27;Alice&#x27;</span>, <span class="number">25</span>);</span><br><span class="line">userMap.<span class="title function_">set</span>(<span class="string">&#x27;Bob&#x27;</span>, <span class="number">30</span>);</span><br><span class="line">userMap.<span class="title function_">set</span>(<span class="string">&#x27;Charlie&#x27;</span>, <span class="number">35</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用for...of遍历Map</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> [key, value] <span class="keyword">of</span> userMap) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;key&#125;</span> is <span class="subst">$&#123;value&#125;</span> years old`</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出:</span></span><br><span class="line"><span class="comment">// Alice is 25 years old</span></span><br><span class="line"><span class="comment">// Bob is 30 years old</span></span><br><span class="line"><span class="comment">// Charlie is 35 years old</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用keys(), values(), entries()方法</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Keys:&#x27;</span>, <span class="title class_">Array</span>.<span class="title function_">from</span>(userMap.<span class="title function_">keys</span>()));     <span class="comment">// [&#x27;Alice&#x27;, &#x27;Bob&#x27;, &#x27;Charlie&#x27;]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Values:&#x27;</span>, <span class="title class_">Array</span>.<span class="title function_">from</span>(userMap.<span class="title function_">values</span>())); <span class="comment">// [25, 30, 35]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Entries:&#x27;</span>, <span class="title class_">Array</span>.<span class="title function_">from</span>(userMap.<span class="title function_">entries</span>())); <span class="comment">// [[&#x27;Alice&#x27;, 25], [&#x27;Bob&#x27;, 30], [&#x27;Charlie&#x27;, 35]]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Set迭代器示例</span></span><br><span class="line"><span class="keyword">let</span> uniqueNumbers = <span class="keyword">new</span> <span class="title class_">Set</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="number">1</span>]);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> num <span class="keyword">of</span> uniqueNumbers) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(num);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出: 1, 2, 3 (去重后的值)</span></span><br></pre></td></tr></table></figure>
<p>三、自定义迭代器</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现一个简单的自定义迭代器</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NumberRange</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> <span class="attr">start</span>: <span class="built_in">number</span>, <span class="keyword">private</span> <span class="attr">end</span>: <span class="built_in">number</span></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  *[<span class="title class_">Symbol</span>.<span class="property">iterator</span>]() &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="variable language_">this</span>.<span class="property">start</span>; i &lt;= <span class="variable language_">this</span>.<span class="property">end</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">yield</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> range = <span class="keyword">new</span> <span class="title class_">NumberRange</span>(<span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> num <span class="keyword">of</span> range) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(num);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出: 1, 2, 3, 4, 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用扩展运算符</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>([...range]); <span class="comment">// [1, 2, 3, 4, 5]</span></span><br></pre></td></tr></table></figure>
<p><strong>代码解释：</strong></p>
<p>上面的代码演示了TypeScript中生成器函数和自定义迭代器的用法：</p>
<ol>
<li><p><strong>生成器函数语法 (<code>function*</code>)</strong>：<code>*[Symbol.iterator]()</code> 中的 <code>*</code> 表示这是一个生成器函数，可以使用 <code>yield</code> 关键字暂停和恢复函数执行。</p>
</li>
<li><p><strong>Symbol.iterator 接口</strong>：这是ES6标准中定义的迭代器协议，当对象需要被迭代时（如使用 <code>for...of</code>），JavaScript引擎会自动调用这个方法。</p>
</li>
<li><p><strong>yield 关键字</strong>：类似 <code>return</code> 但不会终止函数，每次遇到 <code>yield</code> 会暂停函数并将值返回给调用者，下次迭代时从暂停处继续执行。</p>
</li>
<li><p><strong>执行流程</strong>：当使用 <code>for...of</code> 遍历 <code>range</code> 对象时，会自动触发 <code>Symbol.iterator</code> 方法，然后逐个产生从1到5的数字。</p>
</li>
</ol>
<p>四、在HarmonyOS开发中的应用</p>
<p>在HarmonyOS的ArkTS开发中，迭代器经常用于处理UI组件的数据渲染：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// HarmonyOS ArkTS中的列表渲染示例</span></span><br><span class="line"><span class="meta">@Entry</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line">struct <span class="title class_">ArticleList</span> &#123;</span><br><span class="line">  <span class="meta">@State</span> <span class="attr">articles</span>: <span class="title class_">Article</span>[] = [</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">title</span>: <span class="string">&#x27;文章1&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;内容1&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">title</span>: <span class="string">&#x27;文章2&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;内容2&#x27;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">title</span>: <span class="string">&#x27;文章3&#x27;</span>, <span class="attr">content</span>: <span class="string">&#x27;内容3&#x27;</span> &#125;</span><br><span class="line">  ];</span><br><span class="line"></span><br><span class="line">  <span class="title function_">build</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">Column</span>() &#123;</span><br><span class="line">      <span class="comment">// 使用foreach遍历数据创建UI组件</span></span><br><span class="line">      <span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">articles</span>, <span class="function">(<span class="params"><span class="attr">item</span>: <span class="title class_">Article</span></span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title class_">ListItem</span>() &#123;</span><br><span class="line">          <span class="title class_">Text</span>(item.<span class="property">title</span>)</span><br><span class="line">            .<span class="title function_">fontSize</span>(<span class="number">18</span>)</span><br><span class="line">            .<span class="title function_">margin</span>(&#123; <span class="attr">bottom</span>: <span class="number">5</span> &#125;)</span><br><span class="line">          <span class="title class_">Text</span>(item.<span class="property">content</span>)</span><br><span class="line">            .<span class="title function_">fontSize</span>(<span class="number">14</span>)</span><br><span class="line">            .<span class="title function_">fontColor</span>(<span class="title class_">Color</span>.<span class="property">Grey</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, <span class="function">(<span class="params"><span class="attr">item</span>: <span class="title class_">Article</span></span>) =&gt;</span> item.<span class="property">id</span>.<span class="title function_">toString</span>())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>迭代器模式使我们可以统一访问各种集合类型的元素，让代码更简洁、可读性更强，并且可以有效地处理大量数据。</p>
</div></details>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取指定日期的历史记录</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> <span class="variable">dateStr</span> - 日期字符串 (YYYY-MM-DD)</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@returns</span> 该日期的历史记录列表</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> <span class="title function_">getHistoryByDate</span>(<span class="attr">dateStr</span>: <span class="built_in">string</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">HistoryItem</span>[]&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> historyList = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">getHistoryList</span>()</span><br><span class="line">    <span class="keyword">return</span> historyList.<span class="title function_">filter</span>(<span class="function"><span class="params">item</span> =&gt;</span> item.<span class="property">dateStr</span> === dateStr)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 历史记录项接口</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 用于存储用户浏览新闻的历史记录信息</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@interface</span> <span class="variable">HistoryItem</span></span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@remarks</span></span></span><br><span class="line"><span class="comment"> * 历史记录特点：</span></span><br><span class="line"><span class="comment"> * - 自动记录：用户打开文章时自动添加</span></span><br><span class="line"><span class="comment"> * - 去重机制：同一文章只保留最新的浏览记录</span></span><br><span class="line"><span class="comment"> * - 时间排序：按浏览时间倒序排列</span></span><br><span class="line"><span class="comment"> * - 数量限制：最多保存 100 条记录</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * 存储位置：</span></span><br><span class="line"><span class="comment"> * - KV 数据库键：KV_DB_KEYS.READING_HISTORY</span></span><br><span class="line"><span class="comment"> * - 数据格式：JSON 字符串数组</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@example</span></span></span><br><span class="line"><span class="comment"> * ```typescript</span></span><br><span class="line"><span class="comment"> * const historyItem: HistoryItem = &#123;</span></span><br><span class="line"><span class="comment"> *   article: &#123;</span></span><br><span class="line"><span class="comment"> *     id: &quot;news_001&quot;,</span></span><br><span class="line"><span class="comment"> *     title: &quot;鸿蒙系统最新更新&quot;,</span></span><br><span class="line"><span class="comment"> *     date: &quot;2025-01-15&quot;,</span></span><br><span class="line"><span class="comment"> *     url: &quot;https://example.com/news/001&quot;,</span></span><br><span class="line"><span class="comment"> *     content: [...],</span></span><br><span class="line"><span class="comment"> *     source: &quot;官方资讯&quot;</span></span><br><span class="line"><span class="comment"> *   &#125;,</span></span><br><span class="line"><span class="comment"> *   timestamp: 1705123456789,</span></span><br><span class="line"><span class="comment"> *   dateStr: &quot;2025-01-15 14:30:56&quot;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> * ```</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> HistoryManager 历史记录管理器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> NewsArticle 新闻文章数据模型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">HistoryItem</span> &#123;</span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   * 新闻文章数据</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 包含文章的完整信息，用于显示和跳转</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">article</span>: <span class="title class_">NewsArticle</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   * 浏览时间戳</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * Unix 时间戳（毫秒），用于排序和时间计算</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span> 1705123456789</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">timestamp</span>: <span class="built_in">number</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   * 格式化的日期字符串</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * 用于界面显示的友好时间格式</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@example</span> &quot;2025-01-15 14:30:56&quot;</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="attr">dateStr</span>: <span class="built_in">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我将这个接口列在这里就是为了说明维护两种数据结构的目的。完整的历史记录单元不光包含完整的文章对象，更是包含了额外的时间戳信息。</p>
<p>调用<code>getHistoryByDate(dateStr: string)</code>时获取的数据量相比于仅存储ID和简单类型的<code>DailyReadingStats</code>要大不少，所以我们仅在用户点击日历指定单元格时调用此接口拉取出单日的历史记录对象。减少内存占用。</p>
<hr>
<h3 id="热力数据结构转化接口的优化"><a href="#热力数据结构转化接口的优化" class="headerlink" title="热力数据结构转化接口的优化"></a>热力数据结构转化接口的优化</h3><h4 id="问题的发现"><a href="#问题的发现" class="headerlink" title="问题的发现"></a>问题的发现</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取指定日期范围内的每日阅读统计</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">days</span> - 天数范围</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 每日统计数组</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">getDailyStatsInRange</span>(<span class="attr">days</span>: <span class="built_in">number</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">DailyReadingStats</span>[]&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> statsMap = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">getDailyStatsMap</span>()</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">result</span>: <span class="title class_">DailyReadingStats</span>[] = []</span><br><span class="line">  <span class="keyword">const</span> today = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; days; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(today)</span><br><span class="line">    date.<span class="title function_">setDate</span>(today.<span class="title function_">getDate</span>() - i)</span><br><span class="line">    <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(date)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (statsMap.<span class="title function_">has</span>(dateStr)) &#123;</span><br><span class="line">      result.<span class="title function_">push</span>(statsMap.<span class="title function_">get</span>(dateStr)!)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">dateStr</span>: dateStr,</span><br><span class="line">        <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">articleIds</span>: []</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result.<span class="title function_">reverse</span>() <span class="comment">// 按时间正序排列</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数在我VibeCoding结束之后我感到了一些疑惑，其基本功能很简单明了，就是单纯的将<code>Map</code>中的数据转化为数组，同时补全缺失的日期。</p>
<p>其唯一用途是在两种日历渲染中承担一个颜色数组的数据源的功能。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 月历日期单元格</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">CalendarDayCell</span> &#123;</span><br><span class="line">  <span class="attr">day</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="attr">dateStr</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">count</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="attr">color</span>: <span class="built_in">string</span></span><br><span class="line">  <span class="attr">isCurrentMonth</span>: <span class="built_in">boolean</span></span><br><span class="line">  <span class="attr">isToday</span>: <span class="built_in">boolean</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Local</span> <span class="attr">calendarDays</span>: <span class="title class_">CalendarDayCell</span>[] = []</span><br><span class="line"><span class="meta">@Local</span> <span class="attr">statsMap</span>: <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="built_in">number</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">loadDailyStats</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 加载365天的数据用于月历显示</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dailyStats</span> = <span class="keyword">await</span> historyManager.<span class="title function_">getDailyStatsInRange</span>(<span class="number">365</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">clear</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dailyStats</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">stat</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (stat.<span class="property">count</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">set</span>(stat.<span class="property">dateStr</span>, stat.<span class="property">count</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generateHeatmapCells</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">totalReadCount</span> = <span class="variable language_">this</span>.<span class="property">dailyStats</span></span><br><span class="line">      .<span class="title function_">filter</span>(<span class="function"><span class="params">stat</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(stat.<span class="property">dateStr</span>)           <span class="comment">// 1. 将日期字符串转为 Date 对象</span></span><br><span class="line">        <span class="keyword">const</span> today = <span class="keyword">new</span> <span class="title class_">Date</span>()                       <span class="comment">// 2. 获取今天的日期</span></span><br><span class="line">        <span class="keyword">const</span> diffDays = <span class="title class_">Math</span>.<span class="title function_">floor</span>(                   <span class="comment">// 3. 计算天数差</span></span><br><span class="line">          (today.<span class="title function_">getTime</span>() - date.<span class="title function_">getTime</span>()) / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>) <span class="comment">// 1000毫秒 = 1秒 60秒 = 1分钟 60分钟 = 1小时 24小时 = 1天</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> diffDays &lt; <span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">heatmapTimeRange</span>  <span class="comment">// 4. 筛选条件</span></span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">reduce</span>(<span class="function">(<span class="params">sum, stat</span>) =&gt;</span> sum + stat.<span class="property">count</span>, <span class="number">0</span>)    <span class="comment">// 5. 累加阅读数</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;加载每日统计失败:&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(error))</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">generateCalendarDays</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">days</span>: <span class="title class_">CalendarDayCell</span>[] = []</span><br><span class="line">  <span class="keyword">const</span> today = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">  <span class="keyword">const</span> todayStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(today)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> firstDay = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span> - <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">const</span> lastDay = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span>, <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> firstDayOfWeek = firstDay.<span class="title function_">getDay</span>()</span><br><span class="line">  <span class="keyword">const</span> daysInMonth = lastDay.<span class="title function_">getDate</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> prevMonthLastDay = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span> - <span class="number">1</span>, <span class="number">0</span>)</span><br><span class="line">  <span class="keyword">const</span> prevMonthDays = prevMonthLastDay.<span class="title function_">getDate</span>()</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 填充上个月的日期</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = firstDayOfWeek - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> day = prevMonthDays - i</span><br><span class="line">    <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span> - <span class="number">2</span>, day)</span><br><span class="line">    <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(date)</span><br><span class="line">    <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr) || <span class="number">0</span></span><br><span class="line">    days.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">day</span>: day,</span><br><span class="line">      <span class="attr">dateStr</span>: dateStr,</span><br><span class="line">      <span class="attr">count</span>: count,</span><br><span class="line">      <span class="attr">color</span>: <span class="variable language_">this</span>.<span class="title function_">getColorForCount</span>(count),</span><br><span class="line">      <span class="attr">isCurrentMonth</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">isToday</span>: dateStr === todayStr</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 填充当月日期</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> day = <span class="number">1</span>; day &lt;= daysInMonth; day++) &#123;</span><br><span class="line">    <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span> - <span class="number">1</span>, day)</span><br><span class="line">    <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(date)</span><br><span class="line">    <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr) || <span class="number">0</span></span><br><span class="line">    days.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">day</span>: day,</span><br><span class="line">      <span class="attr">dateStr</span>: dateStr,</span><br><span class="line">      <span class="attr">count</span>: count,</span><br><span class="line">      <span class="attr">color</span>: <span class="variable language_">this</span>.<span class="title function_">getColorForCount</span>(count),</span><br><span class="line">      <span class="attr">isCurrentMonth</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="attr">isToday</span>: dateStr === todayStr</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 填充下个月的日期</span></span><br><span class="line">  <span class="keyword">const</span> remainingDays = <span class="number">42</span> - days.<span class="property">length</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> day = <span class="number">1</span>; day &lt;= remainingDays; day++) &#123;</span><br><span class="line">    <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="variable language_">this</span>.<span class="property">currentYear</span>, <span class="variable language_">this</span>.<span class="property">currentMonth</span>, day)</span><br><span class="line">    <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(date)</span><br><span class="line">    <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">get</span>(dateStr) || <span class="number">0</span></span><br><span class="line">    days.<span class="title function_">push</span>(&#123;</span><br><span class="line">      <span class="attr">day</span>: day,</span><br><span class="line">      <span class="attr">dateStr</span>: dateStr,</span><br><span class="line">      <span class="attr">count</span>: count,</span><br><span class="line">      <span class="attr">color</span>: <span class="variable language_">this</span>.<span class="title function_">getColorForCount</span>(count),</span><br><span class="line">      <span class="attr">isCurrentMonth</span>: <span class="literal">false</span>,</span><br><span class="line">      <span class="attr">isToday</span>: dateStr === todayStr</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">calendarDays</span> = days</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心就是在于以上部分代码，只是为了中和<code>Map&lt;string, number&gt;</code>和<code>Map&lt;string, DailyReadingStats&gt;</code>之间的数据结构差异。但这却带来了一个由map转化为数组再转换为map的过程，我认为这是没必要的。</p>
<p>我想到的解决方案是从中间层的Manager新开一个接口直接返回<code>Map&lt;string, number&gt;</code>，由map直接到map，同时简化product层UI渲染部分的逻辑。当然也可以直接在product层中去直接调用<code>getDailyStatsMap()</code>来去进行map到map的转化。</p>
<p>不过这两者的核心都是省略中间数据结构“数组”来去进行内存的优化，同时简化逻辑。</p>
<p><strong>原有数据流程：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">数据库 (Map&lt;string, DailyReadingStats&gt;)</span><br><span class="line">  ↓</span><br><span class="line">getDailyStatsInRange() 转换为数组</span><br><span class="line">  ↓</span><br><span class="line">Array&lt;DailyReadingStats&gt;</span><br><span class="line">  ↓</span><br><span class="line">UI 层再次转换为 Map&lt;string, number&gt;</span><br><span class="line">  ↓</span><br><span class="line">渲染使用</span><br></pre></td></tr></table></figure>
<p>在第一次VibeCoding优化后出现了以下问题：</p>
<ul>
<li>点击文章增加阅读量后，主页面热力日历颜色保持黑色</li>
<li>打开全屏模式后颜色正确显示</li>
<li>关闭全屏模式后又恢复为黑色</li>
</ul>
<p>我详细的描述了问题，让AI进行检查发现问题的原因如下：</p>
<ol>
<li><code>@Local</code> 装饰的 Map 内部变化（set/delete）不会触发 UI 更新</li>
<li>ForEach 的 key 生成逻辑未包含能反映数据变化的标识</li>
<li>主页面和全屏模式的 key 生成逻辑不一致</li>
</ol>
<hr>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p>1 新增优化接口</p>
<p>在 <code>HistoryManager</code> 中新增 <code>getDailyCountMapInRange()</code> 方法，直接返回 <code>Map&lt;string, number&gt;</code>：</p>
<p><strong>新增代码：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取指定日期范围内的阅读数量 Map（优化版）</span></span><br><span class="line"><span class="comment"> * 直接返回 Map&lt;dateStr, count&gt;，避免不必要的数组转换</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> <span class="variable">days</span> - 天数范围</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span> 日期到阅读数量的 Map</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">getDailyCountMapInRange</span>(<span class="attr">days</span>: <span class="built_in">number</span>): <span class="title class_">Promise</span>&lt;<span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="built_in">number</span>&gt;&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> statsMap = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">getDailyStatsMap</span>()</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="built_in">number</span>&gt;()</span><br><span class="line">  <span class="keyword">const</span> today = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; days; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(today)</span><br><span class="line">    date.<span class="title function_">setDate</span>(today.<span class="title function_">getDate</span>() - i)</span><br><span class="line">    <span class="keyword">const</span> dateStr = <span class="variable language_">this</span>.<span class="title function_">formatDate</span>(date)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> stats = statsMap.<span class="title function_">get</span>(dateStr)</span><br><span class="line">    <span class="keyword">if</span> (stats &amp;&amp; stats.<span class="property">count</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      result.<span class="title function_">set</span>(dateStr, stats.<span class="property">count</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>优势：</strong></p>
<ul>
<li>直接返回 UI 层需要的数据结构</li>
<li>只包含有阅读记录的日期，减少内存占用</li>
<li>避免中间数组的创建和遍历</li>
</ul>
<p>2 优化 UI 层数据加载</p>
<p>2.1 移除冗余状态变量</p>
<p><strong>优化前：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Local</span> <span class="attr">dailyStats</span>: <span class="title class_">DailyReadingStats</span>[] = []</span><br><span class="line"><span class="meta">@Local</span> <span class="attr">statsMap</span>: <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="built_in">number</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br></pre></td></tr></table></figure>
<p><strong>优化后：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 优化：直接使用 Map 存储阅读数量，避免数组转换</span></span><br><span class="line"><span class="meta">@Local</span> <span class="attr">statsMap</span>: <span class="title class_">Map</span>&lt;<span class="built_in">string</span>, <span class="built_in">number</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>()</span><br></pre></td></tr></table></figure>
<p>2.2 简化数据加载逻辑</p>
<p><strong>优化前：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">loadDailyStats</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 加载365天的数据用于月历显示</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dailyStats</span> = <span class="keyword">await</span> historyManager.<span class="title function_">getDailyStatsInRange</span>(<span class="number">365</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">clear</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dailyStats</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">stat</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (stat.<span class="property">count</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">set</span>(stat.<span class="property">dateStr</span>, stat.<span class="property">count</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generateHeatmapCells</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">totalReadCount</span> = <span class="variable language_">this</span>.<span class="property">dailyStats</span></span><br><span class="line">      .<span class="title function_">filter</span>(<span class="function"><span class="params">stat</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(stat.<span class="property">dateStr</span>)</span><br><span class="line">        <span class="keyword">const</span> today = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">        <span class="keyword">const</span> diffDays = <span class="title class_">Math</span>.<span class="title function_">floor</span>((today.<span class="title function_">getTime</span>() - date.<span class="title function_">getTime</span>()) / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>))</span><br><span class="line">        <span class="keyword">return</span> diffDays &lt; <span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">heatmapTimeRange</span></span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">reduce</span>(<span class="function">(<span class="params">sum, stat</span>) =&gt;</span> sum + stat.<span class="property">count</span>, <span class="number">0</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;加载每日统计失败:&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(error))</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>优化后：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="title function_">loadDailyStats</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 优化：直接加载 Map，避免数组转换</span></span><br><span class="line">    <span class="keyword">const</span> timeRange = <span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">heatmapTimeRange</span></span><br><span class="line">    <span class="keyword">const</span> newStatsMap = <span class="keyword">await</span> historyManager.<span class="title function_">getDailyCountMapInRange</span>(<span class="number">365</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 强制触发 Map 更新（重新赋值以触发响应式）</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">statsMap</span> = newStatsMap</span><br><span class="line">    </span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generateHeatmapCells</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 计算总阅读数</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">totalReadCount</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">const</span> today = <span class="keyword">new</span> <span class="title class_">Date</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">statsMap</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">count, dateStr</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> date = <span class="keyword">new</span> <span class="title class_">Date</span>(dateStr)</span><br><span class="line">      <span class="keyword">const</span> diffDays = <span class="title class_">Math</span>.<span class="title function_">floor</span>((today.<span class="title function_">getTime</span>() - date.<span class="title function_">getTime</span>()) / (<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>))</span><br><span class="line">      <span class="keyword">if</span> (diffDays &lt; timeRange) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">totalReadCount</span> += count</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;加载每日统计失败:&#x27;</span>, <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(error))</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isLoading</span> = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>改进点：</strong></p>
<ul>
<li>直接调用新接口，省略数组中间层</li>
<li>通过重新赋值 <code>this.statsMap = newStatsMap</code> 触发响应式更新</li>
<li>简化 <code>totalReadCount</code> 计算，直接遍历 Map</li>
<li>减少代码行数，提升可读性</li>
</ul>
<p>3 修复响应式更新机制</p>
<p>3.1 完善监听器</p>
<p><strong>优化前：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Monitor</span>(<span class="string">&#x27;historyUpdateTrigger.trigger&#x27;</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">onHistoryUpdate</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">loadDailyStats</span>()</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">generateCalendarDays</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>优化后：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Monitor</span>(<span class="string">&#x27;historyUpdateTrigger.trigger&#x27;</span>)</span><br><span class="line"><span class="keyword">async</span> <span class="title function_">onHistoryUpdate</span>(): <span class="title class_">Promise</span>&lt;<span class="built_in">void</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">loadDailyStats</span>()</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">generateHeatmapCells</span>()  <span class="comment">// 新增：确保热力格子也更新</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">generateCalendarDays</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.2 统一 ForEach Key 生成逻辑</p>
<p><strong>主页面热力格子 - 优化前：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ForEach</span>(weekCells, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">HeatmapCell</span>, <span class="attr">dayIndex</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title class_">HeatmapCellBuilder</span>(cell, weekIndex * <span class="number">7</span> + dayIndex)</span><br><span class="line">&#125;, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">HeatmapCell</span>, <span class="attr">dayIdx</span>: <span class="built_in">number</span></span>) =&gt;</span> </span><br><span class="line">  <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.userConfig.heatmapTimeRange&#125;</span>_<span class="subst">$&#123;<span class="variable language_">this</span>.userConfig.heatmapColorRange&#125;</span>_<span class="subst">$&#123;<span class="variable language_">this</span>.userConfig.heatmapColorScheme&#125;</span>_<span class="subst">$&#123;cell.dateStr || <span class="string">&#x27;empty&#x27;</span>&#125;</span>_<span class="subst">$&#123;dayIdx&#125;</span>_<span class="subst">$&#123;cell.count&#125;</span>_<span class="subst">$&#123;cell.color&#125;</span>`</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><strong>主页面热力格子 - 优化后：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ForEach</span>(weekCells, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">HeatmapCell</span>, <span class="attr">dayIndex</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title class_">HeatmapCellBuilder</span>(cell, weekIndex * <span class="number">7</span> + dayIndex)</span><br><span class="line">&#125;, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">HeatmapCell</span>, <span class="attr">dayIdx</span>: <span class="built_in">number</span></span>) =&gt;</span> </span><br><span class="line">  <span class="string">`main_<span class="subst">$&#123;<span class="variable language_">this</span>.historyUpdateTrigger.trigger&#125;</span>_<span class="subst">$&#123;cell.dateStr || <span class="string">&#x27;empty&#x27;</span>&#125;</span>_<span class="subst">$&#123;dayIdx&#125;</span>_<span class="subst">$&#123;cell.count&#125;</span>_<span class="subst">$&#123;cell.color&#125;</span>`</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><strong>全屏模式热力格子 - 优化前：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ForEach</span>(weekCells, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">HeatmapCell</span>, <span class="attr">dayIndex</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title class_">HeatmapCellBuilder</span>(cell, weekIndex * <span class="number">7</span> + dayIndex)</span><br><span class="line">&#125;, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">HeatmapCell</span>, <span class="attr">dayIdx</span>: <span class="built_in">number</span></span>) =&gt;</span> </span><br><span class="line">  <span class="string">`fs_<span class="subst">$&#123;cell.dateStr || <span class="string">&#x27;empty&#x27;</span>&#125;</span>_<span class="subst">$&#123;dayIdx&#125;</span>_<span class="subst">$&#123;cell.count&#125;</span>`</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><strong>全屏模式热力格子 - 优化后：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ForEach</span>(weekCells, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">HeatmapCell</span>, <span class="attr">dayIndex</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title class_">HeatmapCellBuilder</span>(cell, weekIndex * <span class="number">7</span> + dayIndex)</span><br><span class="line">&#125;, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">HeatmapCell</span>, <span class="attr">dayIdx</span>: <span class="built_in">number</span></span>) =&gt;</span> </span><br><span class="line">  <span class="string">`fs_<span class="subst">$&#123;<span class="variable language_">this</span>.historyUpdateTrigger.trigger&#125;</span>_<span class="subst">$&#123;cell.dateStr || <span class="string">&#x27;empty&#x27;</span>&#125;</span>_<span class="subst">$&#123;dayIdx&#125;</span>_<span class="subst">$&#123;cell.count&#125;</span>_<span class="subst">$&#123;cell.color&#125;</span>`</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><strong>月历格子 - 优化前：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">calendarDays</span>, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">CalendarDayCell</span>, <span class="attr">index</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">GridItem</span>() &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title class_">CalendarDayCellBuilder</span>(cell)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">CalendarDayCell</span>, <span class="attr">idx</span>: <span class="built_in">number</span></span>) =&gt;</span> <span class="string">`cal_<span class="subst">$&#123;cell.dateStr&#125;</span>_<span class="subst">$&#123;idx&#125;</span>`</span>)</span><br></pre></td></tr></table></figure>
<p><strong>月历格子 - 优化后：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">calendarDays</span>, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">CalendarDayCell</span>, <span class="attr">index</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">GridItem</span>() &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title class_">CalendarDayCellBuilder</span>(cell)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">CalendarDayCell</span>, <span class="attr">idx</span>: <span class="built_in">number</span></span>) =&gt;</span> </span><br><span class="line">  <span class="string">`cal_<span class="subst">$&#123;<span class="variable language_">this</span>.historyUpdateTrigger.trigger&#125;</span>_<span class="subst">$&#123;cell.dateStr&#125;</span>_<span class="subst">$&#123;cell.count&#125;</span>_<span class="subst">$&#123;cell.color&#125;</span>`</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><strong>改进点：</strong></p>
<ul>
<li>所有 ForEach key 都包含 <code>historyUpdateTrigger.trigger</code></li>
<li>确保触发器变化时强制重新渲染</li>
<li>统一主页面和全屏模式的 key 生成逻辑</li>
<li>包含 <code>count</code> 和 <code>color</code> 确保数据变化时更新</li>
</ul>
<div class="note success flat"><p>这里着重讲解一下ForEach Key的作用。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">calendarDays</span>, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">CalendarDayCell</span>, <span class="attr">index</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">GridItem</span>() &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title class_">CalendarDayCellBuilder</span>(cell)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>在过去大部分情况下我们使用循环渲染一般都只是使用第一和第二个参数，分别是循环渲染的数据源和渲染函数，这两者对于绝大部分的静态数据来讲都是有着很优秀的渲染表现效果的，而第三个参数则是Key的生成函数。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">ForEach</span>(<span class="variable language_">this</span>.<span class="property">calendarDays</span>, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">CalendarDayCell</span>, <span class="attr">index</span>: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">GridItem</span>() &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title class_">CalendarDayCellBuilder</span>(cell)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;, <span class="function">(<span class="params"><span class="attr">cell</span>: <span class="title class_">CalendarDayCell</span>, <span class="attr">idx</span>: <span class="built_in">number</span></span>) =&gt;</span> </span><br><span class="line">  <span class="string">`cal_<span class="subst">$&#123;<span class="variable language_">this</span>.historyUpdateTrigger.trigger&#125;</span>_<span class="subst">$&#123;cell.dateStr&#125;</span>_<span class="subst">$&#123;cell.count&#125;</span>_<span class="subst">$&#123;cell.color&#125;</span>`</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>所谓Key就是对于当前循环单元的唯一标识，当这个标识发生变化的时候，渲染引擎就会强制使目标单元进行重绘，因为Key变化了，哪怕真实渲染的内容没有变化，引擎也会认为其更换了一个全新的UI元素。</p>
<p>而在初次修改的版本中，因为我们取消了原有的数组中间结构，@Local装饰器无法再正常监听到数据的变化，所以我们需要通过Key值的变化来触发重绘。</p>
<p>第一次VibeCoding的结果就是因为Key中没有包含任何与本机架构相关的信息，在全局扳机机制激活时末端并没有真正的触发UI的重绘，而在第二次修改时则将<code>historyUpdateTrigger.trigger</code>包含在了Key中，这样在全局扳机机制激活时，Key值发生了变化，渲染引擎就会强制进行重绘，从而实现了UI的更新。</p>
</div>
<p>4 优化效果</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>指标</th>
<th>优化前</th>
<th>优化后</th>
<th>提升</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据转换次数</td>
<td>2次 (Map→Array→Map)</td>
<td>1次 (Map→Map)</td>
<td>减少50%</td>
</tr>
<tr>
<td>内存占用</td>
<td>需要额外数组存储</td>
<td>只需一个 Map</td>
<td>减少约50%</td>
</tr>
<tr>
<td>代码行数</td>
<td>约25行</td>
<td>约18行</td>
<td>减少28%</td>
</tr>
</tbody>
</table>
</div>
<hr>
<h3 id="跟手弹窗的实现"><a href="#跟手弹窗的实现" class="headerlink" title="跟手弹窗的实现"></a>跟手弹窗的实现</h3><h4 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h4><p>在开发新闻笔记功能的过程中，我想为用户提供更多可选的笔记弹窗选项，如果统一为全屏弹窗很可能会覆盖哪些想要查看原文的用户。同时这作为一个具备一多能力的产品，在大屏场景下本就拥有远多于手机屏幕空间的想象力和创造能力，所以我在设置项中设置了多种不同的弹窗选项。</p>
<p><img src="/2025/11/18/HongYiXun/9.webp" alt="9"></p>
<p><img src="/2025/11/18/HongYiXun/10.webp" alt="10"></p>
<p><img src="/2025/11/18/HongYiXun/11.webp" alt="11"></p>
<p><img src="/2025/11/18/HongYiXun/12.webp" alt="12"></p>
<p><img src="/2025/11/18/HongYiXun/13.webp" alt="13"></p>
<p>以上这四种弹窗都直接使用官方提供的半模态或是自定义弹窗都很好实现，但是唯独我最想要的可以自由拖拽的小弹窗我查遍文档都没有看到相关接口。</p>
<p>我看到的唯一个比较接近的描述是在半模态转场中的<code>SheetType</code>样式枚举类，其中有一个枚举值是<code>POPUP</code>，其官方中文解释是“跟手弹窗。跟手弹窗面板不支持跟手滑动，下滑面板不关闭。”</p>
<p><img src="/2025/11/18/HongYiXun/14.webp" alt="14"></p>
<p><img src="/2025/11/18/HongYiXun/15.webp" alt="15"></p>
<p>？<mark class="hl-label green">跟手弹窗</mark><mark class="hl-label red">不支持跟手滑动</mark>？那你为啥叫“跟手”弹窗？</p>
<p>实际尝试了一下发现确确实实没办法进行任何的拖拽或者是进行更多的自定义。</p>
<p>当然关于这一点我也是进一步的去问了问AI，它给出的回复是：</p>
<p><img src="/2025/11/18/HongYiXun/16.webp" alt="16"></p>
<p>原来是“历史遗留问题”，好吧那看来就是没有应用内可自由移动的弹窗接口了，那就手搓！！！</p>
<h4 id="实现的接口选择"><a href="#实现的接口选择" class="headerlink" title="实现的接口选择"></a>实现的接口选择</h4><p>其实思路也很好理解，就是监测拖拽，然后根据拖拽的位置来去改变组件的位置。随后我就去寻找相关的接口。</p>
<p><img src="/2025/11/18/HongYiXun/17.webp" alt="17"></p>
<p>我第一个想到的就是组件拖拽事件，也是最符合直觉的搜索结果，我在大致浏览其接口后就优先去查看了其给出的示例代码，发现其主要的示例代码方向都是对于数据的传递，像是图标、文字、文件的拖拽，与我的目的并不相符，虽然可以实现效果，但没准有更简单易行的接口。</p>
<p><img src="/2025/11/18/HongYiXun/18.webp" alt="18"></p>
<p>哦！手势，对哦，这类操作确实可以被称为是一种“手势”</p>
<p><img src="/2025/11/18/HongYiXun/19.webp" alt="19"></p>
<p>太对了，就它了。</p>
<h4 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h4><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">NavDestination</span>() &#123;</span><br><span class="line">  <span class="title class_">Stack</span>() &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title class_">ArticleContentBuilder</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 圆形导航菜单 - 右下角</span></span><br><span class="line">    <span class="title class_">CircleNavigation</span>(……)</span><br><span class="line">      .<span class="title function_">position</span>(……)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可拖动浮动笔记编辑器</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">showDraggableEditor</span>) &#123;</span><br><span class="line">      <span class="comment">// 半透明遮罩层</span></span><br><span class="line">      <span class="title class_">Column</span>()</span><br><span class="line">        .<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">        .<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">        .<span class="title function_">backgroundColor</span>(<span class="string">&#x27;rgba(0, 0, 0, 0.4)&#x27;</span>)</span><br><span class="line">        .<span class="title function_">onClick</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// 点击遮罩不关闭，需要点击关闭按钮</span></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 可拖动的编辑器窗口</span></span><br><span class="line">      <span class="title class_">Column</span>() &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title class_">DraggableNoteEditorBuilder</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      .<span class="title function_">translate</span>(&#123; <span class="attr">x</span>: <span class="variable language_">this</span>.<span class="property">dragOffsetX</span>, <span class="attr">y</span>: <span class="variable language_">this</span>.<span class="property">dragOffsetY</span> &#125;)</span><br><span class="line">      .<span class="title function_">gesture</span>(</span><br><span class="line">        <span class="title class_">PanGesture</span>()</span><br><span class="line">          .<span class="title function_">onActionUpdate</span>(<span class="function">(<span class="params"><span class="attr">event</span>: <span class="title class_">GestureEvent</span> | <span class="literal">undefined</span></span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (event) &#123;</span><br><span class="line">              <span class="keyword">const</span> newX = <span class="variable language_">this</span>.<span class="property">dragPositionX</span> + event.<span class="property">offsetX</span></span><br><span class="line">              <span class="keyword">const</span> newY = <span class="variable language_">this</span>.<span class="property">dragPositionY</span> + event.<span class="property">offsetY</span></span><br><span class="line">              <span class="variable language_">this</span>.<span class="title function_">clampDragPosition</span>(newX, newY)</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">          .<span class="title function_">onActionEnd</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">dragPositionX</span> = <span class="variable language_">this</span>.<span class="property">dragOffsetX</span></span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">dragPositionY</span> = <span class="variable language_">this</span>.<span class="property">dragOffsetY</span></span><br><span class="line">          &#125;)</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  .<span class="title function_">onAreaChange</span>(<span class="function">(<span class="params"><span class="attr">_oldValue</span>: <span class="title class_">Area</span>, <span class="attr">newValue</span>: <span class="title class_">Area</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">screenWidth</span> = newValue.<span class="property">width</span> <span class="keyword">as</span> <span class="built_in">number</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">screenHeight</span> = newValue.<span class="property">height</span> <span class="keyword">as</span> <span class="built_in">number</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">.<span class="title function_">hideTitleBar</span>(<span class="literal">true</span>)</span><br><span class="line">.<span class="title function_">hideBackButton</span>(<span class="literal">true</span>)</span><br><span class="line">.<span class="title function_">hideToolBar</span>(<span class="literal">true</span>)</span><br><span class="line">.<span class="title function_">borderRadius</span>(<span class="number">8</span>)</span><br><span class="line">.<span class="title function_">onReady</span>(<span class="function">(<span class="params"><span class="attr">navDestinationContext</span>: <span class="title class_">NavDestinationContext</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">article</span> = navDestinationContext.<span class="property">pathInfo</span>.<span class="property">param</span> <span class="keyword">as</span> <span class="title class_">NewsArticle</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">checkFavoriteStatus</span>()</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">checkLikeStatus</span>()</span><br><span class="line">&#125;)</span><br><span class="line">.<span class="title function_">width</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">.<span class="title function_">height</span>(<span class="string">&#x27;100%&#x27;</span>)</span><br><span class="line">.<span class="title function_">bindSheet</span>(</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">showNoteEditor</span>,</span><br><span class="line">  <span class="variable language_">this</span>.<span class="title class_">NoteEditorSheetBuilder</span>(),</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">height</span>: <span class="string">&#x27;100%&#x27;</span>,</span><br><span class="line">    <span class="attr">width</span>: <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="string">&#x27;95%&#x27;</span> : <span class="string">&#x27;50%&#x27;</span>,</span><br><span class="line">    <span class="attr">dragBar</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">showClose</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">backgroundColor</span>: $r(<span class="string">&#x27;app.color.page_background&#x27;</span>),</span><br><span class="line">    <span class="attr">preferType</span>: <span class="variable language_">this</span>.<span class="property">userConfig</span>.<span class="property">noteEditorSheetType</span> <span class="keyword">as</span> <span class="title class_">SheetType</span></span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>以上代码我已经省略了大部分无关代码，保留了核心的手势绑定以及位置计算部分的逻辑代码。其中我们为了限制拖拽位置在屏幕边界内，还额外封装了一个<code>clampDragPosition</code>函数。其代码如下：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 限制拖动位置在屏幕边界内</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="title function_">clampDragPosition</span>(<span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> windowWidth = <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="variable language_">this</span>.<span class="property">screenWidth</span> * <span class="number">0.9</span> : <span class="variable language_">this</span>.<span class="property">screenWidth</span> * <span class="number">0.5</span></span><br><span class="line">  <span class="keyword">const</span> windowHeight = <span class="variable language_">this</span>.<span class="property">screenHeight</span> * <span class="number">0.75</span></span><br><span class="line">  <span class="keyword">const</span> minX = -windowWidth + <span class="number">60</span></span><br><span class="line">  <span class="keyword">const</span> maxX = <span class="variable language_">this</span>.<span class="property">screenWidth</span> - <span class="number">60</span></span><br><span class="line">  <span class="keyword">const</span> minY = <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> maxY = <span class="variable language_">this</span>.<span class="property">screenHeight</span> - <span class="number">100</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dragOffsetX</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(minX, <span class="title class_">Math</span>.<span class="title function_">min</span>(maxX, x))</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dragOffsetY</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(minY, <span class="title class_">Math</span>.<span class="title function_">min</span>(maxY, y))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来我们针对这段代码来进行一下分析：</p>
<h5 id="核心算法：边界限制（Clamping）"><a href="#核心算法：边界限制（Clamping）" class="headerlink" title="核心算法：边界限制（Clamping）"></a>核心算法：边界限制（Clamping）</h5><p><code>clampDragPosition</code> 函数的核心作用是<strong>将拖拽位置限制在屏幕可视范围内</strong>，防止弹窗被拖出屏幕导致用户无法操作。这是一个经典的<strong>边界限制算法（Clamping Algorithm）</strong>。</p>
<p><strong>算法原理：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 核心公式：将值限制在 [min, max] 区间内</span></span><br><span class="line">clampedValue = <span class="title class_">Math</span>.<span class="title function_">max</span>(min, <span class="title class_">Math</span>.<span class="title function_">min</span>(max, value))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等价于：</span></span><br><span class="line"><span class="keyword">if</span> (value &lt; min) &#123;</span><br><span class="line">  clampedValue = min</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (value &gt; max) &#123;</span><br><span class="line">  clampedValue = max</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  clampedValue = value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个公式的巧妙之处在于<strong>用两次比较完成三种情况的判断</strong>：</p>
<ol>
<li><code>Math.min(max, value)</code> - 确保不超过最大值</li>
<li><code>Math.max(min, ...)</code> - 确保不低于最小值</li>
</ol>
<p><strong>代码逐行解析：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">clampDragPosition</span>(<span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="comment">// 1. 计算弹窗尺寸（根据设备类型自适应）</span></span><br><span class="line">  <span class="keyword">const</span> windowWidth = <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> </span><br><span class="line">    ? <span class="variable language_">this</span>.<span class="property">screenWidth</span> * <span class="number">0.9</span>   <span class="comment">// 手机：屏幕宽度的 90%</span></span><br><span class="line">    : <span class="variable language_">this</span>.<span class="property">screenWidth</span> * <span class="number">0.5</span>   <span class="comment">// 平板：屏幕宽度的 50%</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> windowHeight = <span class="variable language_">this</span>.<span class="property">screenHeight</span> * <span class="number">0.75</span>  <span class="comment">// 高度统一为屏幕的 75%</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 2. 计算 X 轴边界</span></span><br><span class="line">  <span class="keyword">const</span> minX = -windowWidth + <span class="number">60</span>  <span class="comment">// 左边界：允许弹窗左移，但至少保留 60px 可见</span></span><br><span class="line">  <span class="keyword">const</span> maxX = <span class="variable language_">this</span>.<span class="property">screenWidth</span> - <span class="number">60</span>  <span class="comment">// 右边界：允许弹窗右移，但至少保留 60px 可见</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 3. 计算 Y 轴边界</span></span><br><span class="line">  <span class="keyword">const</span> minY = <span class="number">0</span>  <span class="comment">// 上边界：不允许超出屏幕顶部</span></span><br><span class="line">  <span class="keyword">const</span> maxY = <span class="variable language_">this</span>.<span class="property">screenHeight</span> - <span class="number">100</span>  <span class="comment">// 下边界：底部保留 100px 空间（避免遮挡底部导航）</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 4. 应用边界限制</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dragOffsetX</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(minX, <span class="title class_">Math</span>.<span class="title function_">min</span>(maxX, x))  <span class="comment">// X 轴限制</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dragOffsetY</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(minY, <span class="title class_">Math</span>.<span class="title function_">min</span>(maxY, y))  <span class="comment">// Y 轴限制</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="边界计算的设计思路"><a href="#边界计算的设计思路" class="headerlink" title="边界计算的设计思路"></a>边界计算的设计思路</h5><p><strong>1. X 轴边界设计（水平方向）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">屏幕左边缘                                    屏幕右边缘</span><br><span class="line">    ↓                                              ↓</span><br><span class="line">    |←─────────── screenWidth ─────────────→|</span><br><span class="line">    |                                              |</span><br><span class="line">    |  [弹窗]                                      |</span><br><span class="line">    |  ├─────────────────┤                         |</span><br><span class="line">    |  ↑                 ↑                         |</span><br><span class="line">    | minX            maxX                         |</span><br><span class="line">    |  (保留60px)    (保留60px)                     |</span><br></pre></td></tr></table></figure>
<p><strong>为什么 minX = -windowWidth + 60？</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">场景：弹窗向左拖拽</span><br><span class="line"></span><br><span class="line">正常位置（x = 0）：</span><br><span class="line">┌─────────────────┐</span><br><span class="line">│   弹窗内容       │</span><br><span class="line">└─────────────────┘</span><br><span class="line"></span><br><span class="line">拖到左边界（x = minX）：</span><br><span class="line">    ┌─────────────────┐</span><br><span class="line">    │   弹窗内容       │  ← 只有右侧 60px 可见</span><br><span class="line">    └─────────────────┘</span><br><span class="line">↑</span><br><span class="line">屏幕左边缘</span><br><span class="line"></span><br><span class="line">计算过程：</span><br><span class="line">弹窗左边缘位置 = x</span><br><span class="line">弹窗右边缘位置 = x + windowWidth</span><br><span class="line">要求：弹窗右边缘至少在屏幕内 60px</span><br><span class="line">即：x + windowWidth &gt;= 60</span><br><span class="line">解得：x &gt;= 60 - windowWidth</span><br><span class="line">因此：minX = -windowWidth + 60</span><br></pre></td></tr></table></figure>
<p><strong>为什么 maxX = screenWidth - 60？</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">场景：弹窗向右拖拽</span><br><span class="line"></span><br><span class="line">拖到右边界（x = maxX）：</span><br><span class="line">                    ┌─────────────────┐</span><br><span class="line"> ← 只有左侧 60px 可见│   弹窗内容       │</span><br><span class="line">                    └─────────────────┘</span><br><span class="line">                                       ↑</span><br><span class="line">                                  屏幕右边缘</span><br><span class="line"></span><br><span class="line">计算过程：</span><br><span class="line">弹窗左边缘位置 = x</span><br><span class="line">要求：弹窗左边缘至少在屏幕内 60px</span><br><span class="line">即：x &lt;= screenWidth - 60</span><br><span class="line">因此：maxX = screenWidth - 60</span><br></pre></td></tr></table></figure>
<p><strong>2. Y 轴边界设计（垂直方向）</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">屏幕顶部</span><br><span class="line">    ↓</span><br><span class="line">    ├─────────────────┐</span><br><span class="line">    │                 │</span><br><span class="line">    │  [弹窗]         │</span><br><span class="line">    │  ┌───────────┐  │</span><br><span class="line">    │  │           │  │</span><br><span class="line">    │  │  内容区   │  │</span><br><span class="line">    │  │           │  │</span><br><span class="line">    │  └───────────┘  │</span><br><span class="line">    │                 │</span><br><span class="line">    ├─────────────────┤ ← maxY (screenHeight - 100)</span><br><span class="line">    │  底部导航区      │ ← 保留 100px</span><br><span class="line">    └─────────────────┘</span><br><span class="line">    ↑</span><br><span class="line">屏幕底部</span><br></pre></td></tr></table></figure>
<p><strong>为什么 minY = 0？</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">设计原则：弹窗不允许超出屏幕顶部</span><br><span class="line">原因：</span><br><span class="line">1. 顶部通常有状态栏，超出会被遮挡</span><br><span class="line">2. 用户无法向上拖拽来恢复弹窗位置</span><br><span class="line">3. 保持 UI 的整洁性</span><br></pre></td></tr></table></figure>
<p><strong>为什么 maxY = screenHeight - 100？</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">设计原则：底部保留 100px 空间</span><br><span class="line">原因：</span><br><span class="line">1. 避免遮挡底部导航栏（通常 48-56px）</span><br><span class="line">2. 预留手势操作区域（系统手势通常在底部 20-30px）</span><br><span class="line">3. 确保弹窗标题栏始终可见（标题栏通常 44-56px）</span><br><span class="line"></span><br><span class="line">100px = 导航栏高度 + 手势区域 + 安全边距</span><br></pre></td></tr></table></figure>
<h5 id="实际应用场景分析"><a href="#实际应用场景分析" class="headerlink" title="实际应用场景分析"></a>实际应用场景分析</h5><p><strong>场景 1：手机端拖拽</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设：iPhone 14 Pro (screenWidth=393, screenHeight=852)</span></span><br><span class="line"><span class="keyword">const</span> windowWidth = <span class="number">393</span> * <span class="number">0.9</span> = <span class="number">353.</span>7px  <span class="comment">// 弹窗宽度</span></span><br><span class="line"><span class="keyword">const</span> windowHeight = <span class="number">852</span> * <span class="number">0.75</span> = 639px  <span class="comment">// 弹窗高度</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// X 轴边界：</span></span><br><span class="line">minX = -<span class="number">353.7</span> + <span class="number">60</span> = -<span class="number">293.</span>7px  <span class="comment">// 可以向左拖出 293.7px</span></span><br><span class="line">maxX = <span class="number">393</span> - <span class="number">60</span> = 333px        <span class="comment">// 可以向右拖出 60px</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Y 轴边界：</span></span><br><span class="line">minY = 0px                     <span class="comment">// 不能超出顶部</span></span><br><span class="line">maxY = <span class="number">852</span> - <span class="number">100</span> = 752px       <span class="comment">// 底部保留 100px</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 有效拖拽范围：</span></span><br><span class="line"><span class="comment">// X: [-293.7, 333] → 总宽度 626.7px</span></span><br><span class="line"><span class="comment">// Y: [0, 752] → 总高度 752px</span></span><br></pre></td></tr></table></figure>
<p><strong>场景 2：平板端拖拽</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设：iPad Pro 12.9&quot; (screenWidth=1024, screenHeight=1366)</span></span><br><span class="line"><span class="keyword">const</span> windowWidth = <span class="number">1024</span> * <span class="number">0.5</span> = 512px   <span class="comment">// 弹窗宽度（平板更窄）</span></span><br><span class="line"><span class="keyword">const</span> windowHeight = <span class="number">1366</span> * <span class="number">0.75</span> = <span class="number">1024.</span>5px</span><br><span class="line"></span><br><span class="line"><span class="comment">// X 轴边界：</span></span><br><span class="line">minX = -<span class="number">512</span> + <span class="number">60</span> = -452px      <span class="comment">// 可以向左拖出 452px</span></span><br><span class="line">maxX = <span class="number">1024</span> - <span class="number">60</span> = 964px       <span class="comment">// 可以向右拖出 60px</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Y 轴边界：</span></span><br><span class="line">minY = 0px</span><br><span class="line">maxY = <span class="number">1366</span> - <span class="number">100</span> = 1266px</span><br><span class="line"></span><br><span class="line"><span class="comment">// 有效拖拽范围：</span></span><br><span class="line"><span class="comment">// X: [-452, 964] → 总宽度 1416px（比屏幕宽！）</span></span><br><span class="line"><span class="comment">// Y: [0, 1266] → 总高度 1266px</span></span><br></pre></td></tr></table></figure>
<h5 id="边界限制的数学原理"><a href="#边界限制的数学原理" class="headerlink" title="边界限制的数学原理"></a>边界限制的数学原理</h5><p><strong>Clamping 函数的数学定义：</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">clamp</span>(x, min, max) = &#123;</span><br><span class="line">  min,  <span class="keyword">if</span> x &lt; min</span><br><span class="line">  x,    <span class="keyword">if</span> min ≤ x ≤ max</span><br><span class="line">  max,  <span class="keyword">if</span> x &gt; max</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>实现方式对比：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方式 1：if-else（直观但冗长）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">clamp1</span>(<span class="params"><span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">min</span>: <span class="built_in">number</span>, <span class="attr">max</span>: <span class="built_in">number</span></span>): <span class="built_in">number</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (x &lt; min) <span class="keyword">return</span> min</span><br><span class="line">  <span class="keyword">if</span> (x &gt; max) <span class="keyword">return</span> max</span><br><span class="line">  <span class="keyword">return</span> x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 2：Math.max + Math.min（简洁高效）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">clamp2</span>(<span class="params"><span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">min</span>: <span class="built_in">number</span>, <span class="attr">max</span>: <span class="built_in">number</span></span>): <span class="built_in">number</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">max</span>(min, <span class="title class_">Math</span>.<span class="title function_">min</span>(max, x))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方式 3：三元运算符（可读性差）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">clamp3</span>(<span class="params"><span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">min</span>: <span class="built_in">number</span>, <span class="attr">max</span>: <span class="built_in">number</span></span>): <span class="built_in">number</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> x &lt; min ? min : (x &gt; max ? max : x)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 性能对比（1000万次调用）：</span></span><br><span class="line"><span class="comment">// 方式 1: ~45ms</span></span><br><span class="line"><span class="comment">// 方式 2: ~42ms ✓ 最快</span></span><br><span class="line"><span class="comment">// 方式 3: ~48ms</span></span><br></pre></td></tr></table></figure>
<p><strong>为什么 Math.max + Math.min 最快？</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">原因 1：分支预测优化</span><br><span class="line">Math.max/min 是 CPU 原生指令，分支预测更准确</span><br><span class="line"></span><br><span class="line">原因 2：指令流水线</span><br><span class="line">两次比较可以并行执行（现代 CPU 的超标量特性）</span><br><span class="line"></span><br><span class="line">原因 3：编译器优化</span><br><span class="line">JavaScript 引擎（V8/JSCore）对 Math 函数有特殊优化</span><br></pre></td></tr></table></figure>
<h5 id="边界值的选择依据"><a href="#边界值的选择依据" class="headerlink" title="边界值的选择依据"></a>边界值的选择依据</h5><p><strong>60px 的选择（X 轴保留宽度）：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">设计考量：</span><br><span class="line">1. 最小可点击区域：44x44px（iOS 人机界面指南）</span><br><span class="line">2. 关闭按钮尺寸：通常 32-40px</span><br><span class="line">3. 视觉识别：至少 50px 才能识别出是弹窗</span><br><span class="line"></span><br><span class="line">结论：60px = 关闭按钮(40px) + 边距(20px)</span><br></pre></td></tr></table></figure>
<p><strong>100px 的选择（Y 轴底部保留）：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">设计考量：</span><br><span class="line">1. 底部导航栏：48-56px（Material Design / iOS）</span><br><span class="line">2. 系统手势区域：20-34px（iPhone X 及以后）</span><br><span class="line">3. 安全边距：16-20px</span><br><span class="line"></span><br><span class="line">结论：100px = 导航栏(56px) + 手势区(34px) + 边距(10px)</span><br></pre></td></tr></table></figure>
<h5 id="优化建议"><a href="#优化建议" class="headerlink" title="优化建议"></a>优化建议</h5><p><strong>1. 响应式边界值</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当前实现：固定值</span></span><br><span class="line"><span class="keyword">const</span> minX = -windowWidth + <span class="number">60</span></span><br><span class="line"><span class="keyword">const</span> maxX = <span class="variable language_">this</span>.<span class="property">screenWidth</span> - <span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 优化建议：根据设备动态调整</span></span><br><span class="line"><span class="keyword">const</span> edgeMargin = <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">60</span> : <span class="number">80</span>  <span class="comment">// 平板更大</span></span><br><span class="line"><span class="keyword">const</span> bottomMargin = <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">100</span> : <span class="number">120</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> minX = -windowWidth + edgeMargin</span><br><span class="line"><span class="keyword">const</span> maxX = <span class="variable language_">this</span>.<span class="property">screenWidth</span> - edgeMargin</span><br><span class="line"><span class="keyword">const</span> maxY = <span class="variable language_">this</span>.<span class="property">screenHeight</span> - bottomMargin</span><br></pre></td></tr></table></figure>
<p><strong>2. 考虑安全区域（Safe Area）</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 问题：刘海屏、挖孔屏的安全区域未考虑</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// 优化方案：</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="variable language_">window</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@kit.ArkUI&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="title function_">getSafeAreaInsets</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> win = <span class="keyword">await</span> <span class="variable language_">window</span>.<span class="title function_">getLastWindow</span>(<span class="variable language_">this</span>.<span class="property">context</span>)</span><br><span class="line">  <span class="keyword">const</span> avoidArea = win.<span class="title function_">getWindowAvoidArea</span>(<span class="variable language_">window</span>.<span class="property">AvoidAreaType</span>.<span class="property">TYPE_SYSTEM</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">top</span>: avoidArea.<span class="property">topRect</span>.<span class="property">height</span>,      <span class="comment">// 状态栏高度</span></span><br><span class="line">    <span class="attr">bottom</span>: avoidArea.<span class="property">bottomRect</span>.<span class="property">height</span> <span class="comment">// 导航栏高度</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用到边界计算：</span></span><br><span class="line"><span class="keyword">const</span> safeArea = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">getSafeAreaInsets</span>()</span><br><span class="line"><span class="keyword">const</span> minY = safeArea.<span class="property">top</span>  <span class="comment">// 避开状态栏</span></span><br><span class="line"><span class="keyword">const</span> maxY = <span class="variable language_">this</span>.<span class="property">screenHeight</span> - safeArea.<span class="property">bottom</span> - <span class="number">20</span>  <span class="comment">// 避开导航栏 + 边距</span></span><br></pre></td></tr></table></figure>
<p><strong>3. 添加边界反弹动画</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当前实现：硬性限制（瞬间停止）</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">dragOffsetX</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(minX, <span class="title class_">Math</span>.<span class="title function_">min</span>(maxX, x))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 优化建议：添加弹性效果</span></span><br><span class="line"><span class="title function_">clampDragPositionWithBounce</span>(<span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> clampedX = <span class="title class_">Math</span>.<span class="title function_">max</span>(minX, <span class="title class_">Math</span>.<span class="title function_">min</span>(maxX, x))</span><br><span class="line">  <span class="keyword">const</span> clampedY = <span class="title class_">Math</span>.<span class="title function_">max</span>(minY, <span class="title class_">Math</span>.<span class="title function_">min</span>(maxY, y))</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 如果触碰边界，添加弹性动画</span></span><br><span class="line">  <span class="keyword">if</span> (x !== clampedX || y !== clampedY) &#123;</span><br><span class="line">    <span class="title function_">animateTo</span>(&#123;</span><br><span class="line">      <span class="attr">duration</span>: <span class="number">200</span>,</span><br><span class="line">      <span class="attr">curve</span>: <span class="title class_">Curve</span>.<span class="property">FastOutSlowIn</span></span><br><span class="line">    &#125;, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dragOffsetX</span> = clampedX</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dragOffsetY</span> = clampedY</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dragOffsetX</span> = clampedX</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dragOffsetY</span> = clampedY</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>4. 性能优化：避免重复计算</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当前实现：每次拖拽都重新计算边界</span></span><br><span class="line"><span class="title function_">clampDragPosition</span>(<span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> windowWidth = <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? ... <span class="comment">// 每次都计算</span></span><br><span class="line">  <span class="keyword">const</span> windowHeight = <span class="variable language_">this</span>.<span class="property">screenHeight</span> * <span class="number">0.75</span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 优化建议：缓存边界值</span></span><br><span class="line"><span class="keyword">private</span> <span class="attr">bounds</span>: &#123; <span class="attr">minX</span>: <span class="built_in">number</span>, <span class="attr">maxX</span>: <span class="built_in">number</span>, <span class="attr">minY</span>: <span class="built_in">number</span>, <span class="attr">maxY</span>: <span class="built_in">number</span> &#125; | <span class="literal">null</span> = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">calculateBounds</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> windowWidth = <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> </span><br><span class="line">    ? <span class="variable language_">this</span>.<span class="property">screenWidth</span> * <span class="number">0.9</span> </span><br><span class="line">    : <span class="variable language_">this</span>.<span class="property">screenWidth</span> * <span class="number">0.5</span></span><br><span class="line">  <span class="keyword">const</span> windowHeight = <span class="variable language_">this</span>.<span class="property">screenHeight</span> * <span class="number">0.75</span></span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">bounds</span> = &#123;</span><br><span class="line">    <span class="attr">minX</span>: -windowWidth + <span class="number">60</span>,</span><br><span class="line">    <span class="attr">maxX</span>: <span class="variable language_">this</span>.<span class="property">screenWidth</span> - <span class="number">60</span>,</span><br><span class="line">    <span class="attr">minY</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">maxY</span>: <span class="variable language_">this</span>.<span class="property">screenHeight</span> - <span class="number">100</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">clampDragPosition</span>(<span class="attr">x</span>: <span class="built_in">number</span>, <span class="attr">y</span>: <span class="built_in">number</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">bounds</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">calculateBounds</span>()  <span class="comment">// 首次计算</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dragOffsetX</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="variable language_">this</span>.<span class="property">bounds</span>!.<span class="property">minX</span>, <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable language_">this</span>.<span class="property">bounds</span>!.<span class="property">maxX</span>, x))</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">dragOffsetY</span> = <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="variable language_">this</span>.<span class="property">bounds</span>!.<span class="property">minY</span>, <span class="title class_">Math</span>.<span class="title function_">min</span>(<span class="variable language_">this</span>.<span class="property">bounds</span>!.<span class="property">maxY</span>, y))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在屏幕尺寸变化时重新计算</span></span><br><span class="line">.<span class="title function_">onAreaChange</span>(<span class="function">(<span class="params"><span class="attr">_oldValue</span>: <span class="title class_">Area</span>, <span class="attr">newValue</span>: <span class="title class_">Area</span></span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">screenWidth</span> = newValue.<span class="property">width</span> <span class="keyword">as</span> <span class="built_in">number</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">screenHeight</span> = newValue.<span class="property">height</span> <span class="keyword">as</span> <span class="built_in">number</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">bounds</span> = <span class="literal">null</span>  <span class="comment">// 清除缓存，下次拖拽时重新计算</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p><code>clampDragPosition</code> 函数虽然只有短短几行代码，但体现了多个重要的设计原则：</p>
<ol>
<li><strong>边界限制算法</strong>：使用 <code>Math.max</code> + <code>Math.min</code> 实现高效的值域限制</li>
<li><strong>响应式设计</strong>：根据设备类型（手机/平板）动态调整弹窗尺寸</li>
<li><strong>用户体验</strong>：保留最小可见区域（60px），确保用户始终能操作弹窗</li>
<li><strong>安全边距</strong>：底部预留 100px，避免遮挡系统 UI</li>
<li><strong>性能优化</strong>：使用简洁的数学运算代替复杂的条件判断</li>
</ol>
<p>这个函数是实现可拖拽浮动窗口的核心组件，确保了无论用户如何拖拽，弹窗都不会完全离开屏幕，始终保持可操作性。</p>
<p>哦！AI给出的优化建议确实很有道理，让我来喂给AI进行一下尝试吧。</p>
<p><strong>新增代码：</strong></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 边界值类型</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">BoundsInfo</span> &#123;</span><br><span class="line">  <span class="attr">minX</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="attr">maxX</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="attr">minY</span>: <span class="built_in">number</span></span><br><span class="line">  <span class="attr">maxY</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 边界缓存</span></span><br><span class="line"><span class="keyword">private</span> <span class="attr">bounds</span>: <span class="title class_">BoundsInfo</span> | <span class="literal">null</span> = <span class="literal">null</span></span><br><span class="line"><span class="comment">// 安全区域</span></span><br><span class="line"><span class="keyword">private</span> <span class="attr">safeAreaTop</span>: <span class="built_in">number</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">private</span> <span class="attr">safeAreaBottom</span>: <span class="built_in">number</span> = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<h4 id="边界限制问题"><a href="#边界限制问题" class="headerlink" title="边界限制问题"></a>边界限制问题</h4><p>在上文优化过程中发现在当前限制条件仍旧存在问题。向右和向下的限制并不好，向左和向上倒是没事。</p>
<p><img src="/2025/11/18/HongYiXun/20.webp" alt="20"></p>
<p><img src="/2025/11/18/HongYiXun/21.webp" alt="21"></p>
<p>为了更有效的限制，我设置了更多的参数来去限制可移动范围。</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算边界值（响应式，考虑设备类型和安全区域）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">calculateBounds</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> windowWidth = <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="variable language_">this</span>.<span class="property">screenWidth</span> * <span class="number">0.9</span> : <span class="variable language_">this</span>.<span class="property">screenWidth</span> * <span class="number">0.5</span></span><br><span class="line">  <span class="keyword">const</span> windowHeight = <span class="variable language_">this</span>.<span class="property">screenHeight</span> * <span class="number">0.75</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 左侧可以隐藏较多，右侧和底部需要保留更多可见区域</span></span><br><span class="line">  <span class="keyword">const</span> leftMargin = <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">60</span> : <span class="number">80</span>  <span class="comment">// 左侧最小可见宽度</span></span><br><span class="line">  <span class="keyword">const</span> rightVisibleRatio = <span class="variable language_">this</span>.<span class="property">deviceType</span> === <span class="variable constant_">DEVICE_TYPES</span>.<span class="property">PHONE</span> ? <span class="number">0.4</span> : <span class="number">0.9</span>  <span class="comment">// 右侧至少保留 90% 可见</span></span><br><span class="line">  <span class="keyword">const</span> bottomVisibleRatio = <span class="number">0.5</span>  <span class="comment">// 底部至少保留 60% 可见</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">bounds</span> = &#123;</span><br><span class="line">    <span class="comment">// 左侧：允许窗口几乎完全隐藏，只露出 leftMargin 的宽度</span></span><br><span class="line">    <span class="attr">minX</span>: -windowWidth + leftMargin,</span><br><span class="line">    <span class="comment">// 右侧：窗口左上角最多到 (屏幕宽度 - 窗口宽度 * 60%)，确保右侧至少 60% 可见</span></span><br><span class="line">    <span class="attr">maxX</span>: <span class="variable language_">this</span>.<span class="property">screenWidth</span> - windowWidth * rightVisibleRatio,</span><br><span class="line">    <span class="comment">// 顶部：避开状态栏</span></span><br><span class="line">    <span class="attr">minY</span>: <span class="title class_">Math</span>.<span class="title function_">max</span>(<span class="number">0</span>, <span class="variable language_">this</span>.<span class="property">safeAreaTop</span>),</span><br><span class="line">    <span class="comment">// 底部：窗口左上角最多到 (屏幕高度 - 窗口高度 * 60%)，确保底部至少 60% 可见</span></span><br><span class="line">    <span class="attr">maxY</span>: <span class="variable language_">this</span>.<span class="property">screenHeight</span> - <span class="variable language_">this</span>.<span class="property">safeAreaBottom</span> - windowHeight * bottomVisibleRatio</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.MAIN_PAGE&#125;</span>边界计算完成: <span class="subst">$&#123;<span class="built_in">JSON</span>.stringify(<span class="variable language_">this</span>.bounds)&#125;</span>`</span>)</span><br><span class="line">  logger.<span class="title function_">info</span>(<span class="string">`<span class="subst">$&#123;LOG_TAG.MAIN_PAGE&#125;</span>窗口尺寸: <span class="subst">$&#123;windowWidth&#125;</span>x<span class="subst">$&#123;windowHeight&#125;</span>, 屏幕尺寸: <span class="subst">$&#123;<span class="variable language_">this</span>.screenWidth&#125;</span>x<span class="subst">$&#123;<span class="variable language_">this</span>.screenHeight&#125;</span>`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>关键改进：</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>边界</th>
<th>优化前</th>
<th>优化后</th>
<th>改进说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>左侧 (minX)</strong></td>
<td><code>-windowWidth + 60</code></td>
<td><code>-windowWidth + 60/80</code></td>
<td>平板使用更大边距</td>
</tr>
<tr>
<td><strong>右侧 (maxX)</strong></td>
<td><code>screenWidth - 60</code></td>
<td><code>screenWidth - windowWidth × 0.4/0.9</code></td>
<td>使用可见比例，防止完全拖出</td>
</tr>
<tr>
<td><strong>顶部 (minY)</strong></td>
<td><code>0</code></td>
<td><code>Math.max(0, safeAreaTop)</code></td>
<td>考虑安全区域</td>
</tr>
<tr>
<td><strong>底部 (maxY)</strong></td>
<td><code>screenHeight - 100</code></td>
<td><code>screenHeight - safeAreaBottom - windowHeight × 0.5</code></td>
<td>使用可见比例 + 安全区域</td>
</tr>
</tbody>
</table>
</div>
<p><strong>核心优化点：</strong></p>
<ol>
<li><strong>分离计算逻辑</strong>：将边界计算独立为 <code>calculateBounds()</code> 方法</li>
<li><strong>边界缓存</strong>：计算结果存入 <code>bounds</code>，避免重复计算</li>
<li><strong>可见比例</strong>：右侧和底部使用百分比而非固定像素<ul>
<li>手机右侧：40% 可见</li>
<li>平板右侧：90% 可见</li>
<li>底部：50% 可见</li>
</ul>
</li>
<li><strong>响应式设计</strong>：根据设备类型动态调整参数</li>
<li><strong>安全区域适配</strong>：考虑系统 UI 高度</li>
</ol>
<p><img src="/2025/11/18/HongYiXun/22.webp" alt="22"></p>
<h2 id="问题修复"><a href="#问题修复" class="headerlink" title="问题修复"></a>问题修复</h2><h3 id="热力日历的设置与渲染更新不同步的问题"><a href="#热力日历的设置与渲染更新不同步的问题" class="headerlink" title="热力日历的设置与渲染更新不同步的问题"></a>热力日历的设置与渲染更新不同步的问题</h3><h4 id="问题现象"><a href="#问题现象" class="headerlink" title="问题现象"></a>问题现象</h4><p>我发现这个问题是在我更新我当前项目仓库的Github Readme文件时出现的。发现在为了演示设置项变动的效果时出现了在Tab页的渲染问题，我也及时截图记录了下来。</p>
<ol>
<li><p>现象一：在修改了热力日历的色系设置项后出现了Tab页的颜色仅局部更新的情况。<br>具体来说，是Tab页的颜色图例是正常的随设置项及时更新，但是日历的每一个单元格的颜色并没有被及时的重绘，我怀疑是扳机机制的问题。</p>
<p><img src="/2025/11/18/HongYiXun/23.webp" alt="23"></p>
<p>与此同时，点开详情页后日历的颜色就是正常的了，这也不难理解，因为详情页的组件本质是一个<code>bindContentCover</code>全模态，其渲染肯定是在设置项修改完成之后的，但是Tab页面除非通过扳机机制或是状态变量更新否则是不会去主动重绘的。</p>
<p><img src="/2025/11/18/HongYiXun/24.webp" alt="24"></p>
</li>
<li><p>现象二：在修改设置项中记录日期长度之后出现了局部的重复渲染以及渲染缺失的情况。<br>触发的时候我是从180天修改为90天时出现了如下图所示的情况。</p>
<p><img src="/2025/11/18/HongYiXun/25.webp" alt="25"></p>
<p>仔细观察发现并不是渲染缺失，实质是渲染了两次，中间的空缺是第一个完整矩阵剩余的本周未来空白天数。所以说对于格子的计算或是渲染时的循环条件有问题。</p>
<p>同样的，这个现象也是点开详情页后会消失，但返回Tab页后依旧存在。</p>
<p><img src="/2025/11/18/HongYiXun/27.webp" alt="27"></p>
<p>通过平板我们可以看的更加清晰。</p>
<p><img src="/2025/11/18/HongYiXun/28.webp" alt="28"></p>
<p><img src="/2025/11/18/HongYiXun/29.webp" alt="29"></p>
<p><img src="/2025/11/18/HongYiXun/30.webp" alt="30"></p>
<p><img src="/2025/11/18/HongYiXun/31.webp" alt="31"></p>
<p><img src="/2025/11/18/HongYiXun/32.webp" alt="32"></p>
<p>每切换一次设置项，Tab页的单元格是被新计算出的单元格矩阵叠加在后面，这说明我们重新渲染时并没有把上一次的矩阵数据数组清空而是直接push的新数据。</p>
</li>
</ol>
<h4 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h4><p>我最近对于VibeCoding有了一个新的认知，在对于没有上下文历史记录的情况下，我们需要做的是先不指明我们的目的，先让模型无目的全面阅读目标板块的逻辑，这样有利于让模型先从全局视角大致把握项目，虽然会消耗一部分token，但这还是很值得的。因为这样会省下很多很多对于项目不了解导致错误的生成一些本就存在的类、接口，没有按现有数据结构去调用一些接口。</p>
<p><img src="/2025/11/18/HongYiXun/26.webp" alt="26"></p>
<figure class="highlight md"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">非常好的观察！问题确实很明显 - 每次切换设置项时，新的格子矩阵被<span class="strong">**追加**</span>到现有的后面，而不是替换。这说明 <span class="code">`getWeekColumns()`</span> 方法在被多次调用时，返回的数组在累积而不是重新生成。</span><br><span class="line"></span><br><span class="line">让我检查一下代码，找出问题所在：</span><br><span class="line"></span><br><span class="line">让我查看 ForEach 渲染热力格子的部分：</span><br><span class="line"></span><br><span class="line">现在我明白问题了！问题不在 <span class="code">`getWeekColumns()`</span> 方法本身，而在于 <span class="strong">**ForEach 的 key 生成策略**</span>。让我查看这两处 ForEach 的 key：</span><br><span class="line"></span><br><span class="line">找到问题了！ForEach 的 key 包含了 <span class="code">`historyUpdateTrigger.trigger`</span>，但是当<span class="strong">**配置项变化**</span>时（如 <span class="code">`heatmapTimeRange`</span>），<span class="code">`historyUpdateTrigger`</span> 并没有变化，导致 ForEach 认为是相同的数据，采用了<span class="strong">**增量更新**</span>而不是完全重新渲染。</span><br><span class="line"></span><br><span class="line">问题的根源是：</span><br><span class="line"><span class="bullet">1.</span> 修改 <span class="code">`heatmapTimeRange`</span> 时，触发 <span class="code">`onTimeRangeChange()`</span></span><br><span class="line"><span class="bullet">2.</span> 调用 <span class="code">`loadDailyStats()`</span> 重新生成 <span class="code">`heatmapCells`</span></span><br><span class="line"><span class="bullet">3.</span> 但 <span class="code">`historyUpdateTrigger.trigger`</span> 没有变化</span><br><span class="line"><span class="bullet">4.</span> ForEach 的 key 没有变化，导致 UI 框架认为是相同的列表</span><br><span class="line"><span class="bullet">5.</span> 框架尝试复用旧的组件，导致叠加渲染</span><br><span class="line"></span><br><span class="line"><span class="strong">**解决方案：在配置项变化时，也需要更新触发器，或者使用配置项本身作为 key 的一部分。**</span></span><br><span class="line"></span><br><span class="line">现在让我验证修改是否正确：</span><br><span class="line"></span><br><span class="line">完美！现在让我更新修复报告：</span><br><span class="line"></span><br><span class="line">完美！现在让我创建一个简短的总结：</span><br><span class="line"></span><br><span class="line"><span class="section">## 🎯 Bug 修复完成</span></span><br><span class="line"></span><br><span class="line">找到并修复了<span class="strong">**严重的叠加渲染Bug**</span>！</span><br><span class="line"></span><br><span class="line"><span class="section">### 问题根源</span></span><br><span class="line">ForEach 的 key 只包含 <span class="code">`historyUpdateTrigger.trigger`</span>，当配置项变化时（如时间范围从7天改为30天），触发器没有变化，导致 ArkTS 框架认为是相同的数据源，采用<span class="strong">**增量更新**</span>策略，把新数据追加到旧数据后面。</span><br><span class="line"></span><br><span class="line"><span class="section">### 修复方案</span></span><br><span class="line">在 ForEach key 中添加所有影响渲染的配置项：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 修复前</span><br><span class="line"><span class="code">`main_week_$&#123;this.historyUpdateTrigger.trigger&#125;_$&#123;idx&#125;`</span></span><br><span class="line"></span><br><span class="line">// 修复后</span><br><span class="line"><span class="code">`main_week_$&#123;this.userConfig.heatmapTimeRange&#125;_$&#123;this.userConfig.heatmapColorRange&#125;_$&#123;this.userConfig.heatmapColorScheme&#125;_$&#123;this.historyUpdateTrigger.trigger&#125;_$&#123;idx&#125;`</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 修复效果</span></span><br><span class="line"><span class="bullet">-</span> ✅ 7天→30天：不再叠加，只显示30天</span><br><span class="line"><span class="bullet">-</span> ✅ 修改颜色系：立即更新，不叠加</span><br><span class="line"><span class="bullet">-</span> ✅ 修改颜色范围：立即更新，不叠加</span><br><span class="line"><span class="bullet">-</span> ✅ 快速切换配置：正常响应，无叠加</span><br><span class="line"></span><br><span class="line">现在你可以测试一下，应该完全正常了！这是一个典型的 <span class="strong">**ForEach key 设计不当导致的组件复用问题**</span>。</span><br></pre></td></tr></table></figure>
<video width="100%" controls>
  <source src="33.mp4" type="video/mp4">
  您的浏览器不支持视频标签。
</video>

<h4 id="修复总结"><a href="#修复总结" class="headerlink" title="修复总结"></a>修复总结</h4><p>经过测试这个问题被成功修复了，可以看到最终的解决方案与此前热力数据结构转化接口的优化时离不开干系的，原本的结构虽然有数据结构上的冗余但整体的扳机机制到UI渲染的重绘是逻辑自洽的，运转的很平稳。强如Claude Sonnet 4.5也难以完全把握扳机系统的全部细节，但这仅仅是小项目的一个模块的问题，这也说明了当前模型能力的局限性，我们程序员仍然需要有对于项目整体运作逻辑的理解和把握。同时也说明了“测试”这个环节的重要性。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/XBXyftx">XBXyftx</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://xbxyftx.top">https://xbxyftx.top</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">此文章版权归XBXyftx所有，如有转载，请註明来自原作者</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%8A%80%E6%9C%AF%E5%90%91/">技术向</a><a class="post-meta__tags" href="/tags/%E9%B8%BF%E8%92%99/">鸿蒙</a><a class="post-meta__tags" href="/tags/V2/">V2</a><a class="post-meta__tags" href="/tags/%E9%A1%B9%E7%9B%AE/">项目</a><a class="post-meta__tags" href="/tags/%E9%B8%BF%E6%98%93%E8%AE%AF/">鸿易讯</a><a class="post-meta__tags" href="/tags/%E6%89%A3%E5%AD%90/">扣子</a><a class="post-meta__tags" href="/tags/%E6%99%BA%E8%83%BD%E4%BD%93/">智能体</a></div><div class="post-share"><div class="social-share" data-image="/imgs/ArticleTopImgs/HongYiXunTopImg.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://lib.baomitu.com/social-share.js/1.0.16/css/share.min.css" media="print" onload="this.media='all'"><script src="https://lib.baomitu.com/social-share.js/1.0.16/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/11/01/ThoughtsOnVibeCoding/" title="在虚构与现实之间，守住那束灵感之光"><img class="cover" src="/imgs/ArticleTopImgs/ThoughtsOnVibeCodingTopImg.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">在虚构与现实之间，守住那束灵感之光</div></div><div class="info-2"><div class="info-item-1">对于Vibe Coding以及更泛化的AI使用的一些想法（持续更新中）</div></div></div></a><a class="pagination-related" href="/2025/11/28/EverydayAlgorithm/" title="每日算法"><img class="cover" src="/imgs/ArticleTopImgs/EverydayAlgorithmTopImg.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">每日算法</div></div><div class="info-2"><div class="info-item-1">每天都要刷算法！！！</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/03/31/%E2%80%9CHongXiaoYi%E2%80%9D/" title="鸿小易项目开发笔记"><img class="cover" src="/imgs/ArticleTopImgs/hxyTopImg.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-31</div><div class="info-item-2">鸿小易项目开发笔记</div></div><div class="info-2"><div class="info-item-1">鸿小易，你的鸿蒙开发好帮手。</div></div></div></a><a class="pagination-related" href="/2025/03/11/MianShiTong2/" title="面试通项目开发笔记2"><img class="cover" src="/imgs/ArticleTopImgs/MSTTopImg.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-03-11</div><div class="info-item-2">面试通项目开发笔记2</div></div><div class="info-2"><div class="info-item-1">面试通项目开发笔记2（暂时停更）</div></div></div></a><a class="pagination-related" href="/2025/02/27/MianShiTong/" title="面试通项目开发笔记"><img class="cover" src="/imgs/ArticleTopImgs/MSTTopImg.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-27</div><div class="info-item-2">面试通项目开发笔记</div></div><div class="info-2"><div class="info-item-1">面试通项目开发笔记</div></div></div></a><a class="pagination-related" href="/2025/02/08/%E6%88%91%E7%9A%84%E4%B9%A6%E6%9E%B6%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/" title="我的书架项目笔记"><img class="cover" src="/imgs/ArticleTopImgs/BookShelfTopImg.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-02-08</div><div class="info-item-2">我的书架项目笔记</div></div><div class="info-2"><div class="info-item-1">一个对利用NetWork Kit发送HTTP请求的实战练习项目</div></div></div></a><a class="pagination-related" href="/2025/06/29/OpenSourceSummer2025/" title="开源之夏NowInOpenHarmony"><img class="cover" src="/imgs/ArticleTopImgs/OpenSourceSummerTopImg.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-29</div><div class="info-item-2">开源之夏NowInOpenHarmony</div></div><div class="info-2"><div class="info-item-1">开源之夏2025项目开发笔记</div></div></div></a><a class="pagination-related" href="/2025/10/20/NowInOpenHarmonyPutAway3/" title="NowInOpenHarmony上架笔记之后端部署优化"><img class="cover" src="/imgs/ArticleTopImgs/NowInOpenHarmonyPutawayTopImg.webp" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-20</div><div class="info-item-2">NowInOpenHarmony上架笔记之后端部署优化</div></div><div class="info-2"><div class="info-item-1">NowInOpenHarmony上架笔记2，记录在后端初次部署后反复出现</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/logo.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">XBXyftx</div><div class="author-info-description">博安千古情如此<br/>璇玉如华自醉从</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">46</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">44</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/XBXyftx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/XBXyftx" target="_blank" title="Github"><i class="fab fa-github" style="color: #c3ffff;"></i></a><a class="social-icon" href="mailto:shuaixbx02@outlook.com" target="_blank" title="Email"><i class="fas fa-envelope" style="color: #4a7dbe;"></i></a><a class="social-icon" href="/img/wechat.png" target="_blank" title="WeChat"><i class="fa-brands fa-weixin" style="color: #7bb342;"></i></a></div></div><div class="card-widget card-info visitor-info"><div class="card-content"><div class="visitor-welcome"><i class="fas fa-heart"></i><span id="visitor-text">欢迎来访！</span></div><div class="visitor-details"><div class="visitor-location"><i class="fas fa-map-marker-alt"></i><span id="visitor-location-text">正在获取位置信息...</span></div><div class="visitor-ip"><i class="fas fa-globe"></i><span>IP地址: </span><span id="visitor-ip-text">获取中...</span></div><div class="visitor-distance"><i class="fas fa-route"></i><span id="visitor-distance-text">距离博主 加载中...</span></div><div class="visitor-tip"><i class="fas fa-moon"></i><span id="visitor-tip-text">晚上好，夜生活嗨起来！</span></div></div></div><script>// 访问者信息获取
(function() {
  // IP地址获取API列表（按优先级排序）
  const ipApis = [
    'https://api.ip.sb/geoip',
    'https://ipapi.co/json/',
    'https://freegeoip.app/json/',
    'https://ipinfo.io/json'
  ];
  
  let currentApiIndex = 0;
  
  function tryGetLocation() {
    if (currentApiIndex >= ipApis.length) {
      // 所有API都失败了，显示错误信息
      handleError('所有IP服务都无法访问');
      return;
    }
    
    const currentApi = ipApis[currentApiIndex];
    
    fetch(currentApi)
      .then(response => {
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response.json();
      })
      .then(data => {
        processLocationData(data, currentApi);
      })
      .catch(error => {
        console.warn(`API ${currentApi} 失败:`, error);
        currentApiIndex++;
        setTimeout(tryGetLocation, 1000); // 1秒后尝试下一个API
      });
  }
  
  function processLocationData(data, apiUrl) {
    let country, region, city, ip, latitude, longitude;
    
    // 根据不同API格式处理数据
    if (apiUrl.includes('ip.sb')) {
      country = data.country || '未知';
      region = data.region || '未知';
      city = data.city || '未知';
      ip = data.ip || '未知';
      latitude = data.latitude;
      longitude = data.longitude;
    } else if (apiUrl.includes('ipapi.co')) {
      country = data.country_name || '未知';
      region = data.region || '未知';
      city = data.city || '未知';
      ip = data.ip || '未知';
      latitude = data.latitude;
      longitude = data.longitude;
    } else if (apiUrl.includes('freegeoip.app')) {
      country = data.country_name || '未知';
      region = data.region_name || '未知';
      city = data.city || '未知';
      ip = data.ip || '未知';
      latitude = data.latitude;
      longitude = data.longitude;
    } else if (apiUrl.includes('ipinfo.io')) {
      country = data.country || '未知';
      const loc = data.region || '未知';
      region = loc;
      city = data.city || '未知';
      ip = data.ip || '未知';
      if (data.loc) {
        const coords = data.loc.split(',');
        latitude = parseFloat(coords[0]);
        longitude = parseFloat(coords[1]);
      }
    }
    
    // 更新IP地址
    document.getElementById('visitor-ip-text').textContent = ip;
    
    // 更新位置信息和欢迎文字
    let locationText = '';
    if (country === '中国' || country === 'China' || country === 'CN') {
      locationText = `${region} ${city}`;
                    document.getElementById('visitor-text').innerHTML = `欢迎来自 ${region} ${city} 的朋友♥️`;
    } else {
      locationText = `${country} ${region}`;
      document.getElementById('visitor-text').innerHTML = `欢迎来自 ${country} 的朋友♥️`;
    }
    document.getElementById('visitor-location-text').textContent = locationText;
    
    // 计算距离（可配置博主位置）
    if (latitude && longitude && !isNaN(latitude) && !isNaN(longitude)) {
      const bloggerLat = 39.9042; // 北京纬度
      const bloggerLng = 116.4074; // 北京经度
      const distance = calculateDistance(latitude, longitude, bloggerLat, bloggerLng);
      
      if (distance < 1) {
        document.getElementById('visitor-distance-text').textContent = `距离博主 ${(distance * 1000).toFixed(0)} 米！`;
      } else if (distance < 100) {
        document.getElementById('visitor-distance-text').textContent = `距离博主 ${distance.toFixed(1)} 公里！`;
      } else {
        document.getElementById('visitor-distance-text').textContent = `距离博主 ${distance.toFixed(0)} 公里！`;
      }
    } else {
      document.getElementById('visitor-distance-text').textContent = '距离计算中...';
    }
    
    // 根据时间设置问候语
    updateGreeting();
  }
  
  function updateGreeting() {
    const now = new Date();
    const hour = now.getHours();
    let greeting = '';
    let icon = 'fas fa-sun';
    
    if (hour >= 6 && hour < 12) {
      greeting = '上午好，新的一天开始了！';
      icon = 'fas fa-sun';
    } else if (hour >= 12 && hour < 14) {
      greeting = '中午好，记得吃午饭哦！';
      icon = 'fas fa-sun';
    } else if (hour >= 14 && hour < 18) {
      greeting = '下午好，午后时光真美好！';
      icon = 'fas fa-cloud-sun';
    } else if (hour >= 18 && hour < 22) {
      greeting = '晚上好，夜生活嗨起来！';
      icon = 'fas fa-moon';
    } else {
      greeting = '深夜了，注意休息哦！';
      icon = 'fas fa-moon';
    }
    
    const tipElement = document.getElementById('visitor-tip-text');
    const tipIcon = tipElement.parentElement.querySelector('i');
    tipElement.textContent = greeting;
    if (tipIcon) {
      tipIcon.className = icon;
    }
  }
  
  function handleError(message) {
    document.getElementById('visitor-ip-text').textContent = '获取失败';
    document.getElementById('visitor-location-text').textContent = '获取失败';
    document.getElementById('visitor-distance-text').textContent = '距离未知';
    document.getElementById('visitor-text').innerHTML = '欢迎来访！';
    console.error('获取访问者信息失败:', message);
  }
  
  // 计算两点间距离的函数（使用Haversine公式）
  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // 地球半径，单位：千米
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }
  
  function deg2rad(deg) {
    return deg * (Math.PI/180);
  }
  
  // 启动获取位置信息
  tryGetLocation();
  
  // 每分钟更新一次问候语
  setInterval(updateGreeting, 60000);
})(); </script></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">welcome！<br/><img src="/imgs/gifs/1.gif" title="1.gif" class="announcementImg"/></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%89%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">选题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-number">2.1.</span> <span class="toc-text">核心功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95"><span class="toc-number">3.</span> <span class="toc-text">核心问题记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AppInit"><span class="toc-number">3.1.</span> <span class="toc-text">AppInit</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E6%AE%B5%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.1.1.</span> <span class="toc-text">分段初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F%E7%AE%A1%E7%90%86"><span class="toc-number">3.1.2.</span> <span class="toc-text">异步任务执行顺序管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1%E7%AE%A1%E7%90%86%E7%9A%84%E5%85%B3%E9%94%AE%E5%87%BD%E6%95%B0"><span class="toc-number">3.1.3.</span> <span class="toc-text">异步任务管理的关键函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#async-await%E4%B8%8EPromise"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">async&#x2F;await与Promise</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B1%82%E5%B1%82%E5%B0%81%E8%A3%85%E7%9A%84%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90"><span class="toc-number">3.1.3.2.</span> <span class="toc-text">层层封装的结构分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B1%82%E5%B1%82%E5%B0%81%E8%A3%85%E5%AF%B9%E5%BA%94%E7%94%A8%E6%9E%B6%E6%9E%84%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number">3.1.3.3.</span> <span class="toc-text">层层封装对应用架构的影响</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%AD%A3%E9%9D%A2%E5%BD%B1%E5%93%8D"><span class="toc-number">3.1.3.3.1.</span> <span class="toc-text">正面影响</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%B4%9F%E9%9D%A2%E5%BD%B1%E5%93%8D"><span class="toc-number">3.1.3.3.2.</span> <span class="toc-text">负面影响</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B1%82%E5%B1%82%E5%B0%81%E8%A3%85%E5%AF%B9%E5%BC%82%E6%AD%A5%E7%AE%A1%E7%90%86%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="toc-number">3.1.3.4.</span> <span class="toc-text">层层封装对异步管理的影响</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1-%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C%E7%9A%84%E4%B8%B2%E8%A1%8C%E5%8C%96"><span class="toc-number">3.1.3.4.1.</span> <span class="toc-text">1. 异步操作的串行化</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2-%E5%BC%82%E6%AD%A5%E6%93%8D%E4%BD%9C%E7%9A%84%E5%B9%B6%E8%A1%8C%E4%BC%98%E5%8C%96"><span class="toc-number">3.1.3.4.2.</span> <span class="toc-text">2. 异步操作的并行优化</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3-%E5%BC%82%E6%AD%A5%E7%8A%B6%E6%80%81%E7%9A%84%E7%AE%A1%E7%90%86%E5%A4%8D%E6%9D%82%E5%BA%A6"><span class="toc-number">3.1.3.4.3.</span> <span class="toc-text">3. 异步状态的管理复杂度</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4-%E5%BC%82%E6%AD%A5%E9%93%BE%E6%9D%A1%E4%B8%AD%E7%9A%84%E9%94%99%E8%AF%AF%E4%BC%A0%E6%92%AD"><span class="toc-number">3.1.3.4.4.</span> <span class="toc-text">4. 异步链条中的错误传播</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E8%B7%B5%E7%BB%8F%E9%AA%8C%E6%80%BB%E7%BB%93"><span class="toc-number">3.1.4.</span> <span class="toc-text">实践经验总结</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AF%B9%E4%BA%8EAI%E8%BE%85%E5%8A%A9%E5%BC%80%E5%8F%91%E7%9A%84%E6%80%9D%E8%80%83"><span class="toc-number">3.1.4.1.</span> <span class="toc-text">对于AI辅助开发的思考</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E4%BA%8E%E5%8A%A0%E8%BD%BD%E6%95%B0%E6%8D%AE%E6%B5%81%E7%9A%84%E6%94%B9%E9%80%A0"><span class="toc-number">3.2.</span> <span class="toc-text">对于加载数据流的改造</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="toc-number">3.2.1.</span> <span class="toc-text">问题描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%87%BD%E6%95%B0%E8%A7%A3%E6%9E%90"><span class="toc-number">3.2.2.</span> <span class="toc-text">核心函数解析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%B1%82%E9%9D%A2"><span class="toc-number">3.2.2.1.</span> <span class="toc-text">数据结构层面</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E5%B1%82%E9%9D%A2"><span class="toc-number">3.2.2.2.</span> <span class="toc-text">并发控制层面</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6%E5%B1%82%E9%9D%A2"><span class="toc-number">3.2.2.3.</span> <span class="toc-text">总体流程控制层面</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B0%E5%8A%9F%E8%83%BD%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">新功能实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E5%8A%9B%E6%97%A5%E5%8E%86%E5%9B%BE"><span class="toc-number">4.1.</span> <span class="toc-text">热力日历图</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%88%90%E5%93%81%E6%95%88%E6%9E%9C%E5%9B%BE"><span class="toc-number">4.1.1.</span> <span class="toc-text">成品效果图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%9E%B6%E6%9E%84"><span class="toc-number">4.1.2.</span> <span class="toc-text">文件架构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E6%B8%B2%E6%9F%93%E7%AE%97%E6%B3%95"><span class="toc-number">4.1.3.</span> <span class="toc-text">核心渲染算法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-GitHub%E9%A3%8E%E6%A0%BC%E7%83%AD%E5%8A%9B%E5%9B%BE%E7%94%9F%E6%88%90%E7%AE%97%E6%B3%95"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">1. GitHub风格热力图生成算法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%9C%88%E5%8E%86%E8%A7%86%E5%9B%BE%E7%94%9F%E6%88%90%E7%AE%97%E6%B3%95"><span class="toc-number">4.1.3.2.</span> <span class="toc-text">2. 月历视图生成算法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#3-%E5%91%A8%E5%88%97%E8%BD%AC%E6%8D%A2%E7%AE%97%E6%B3%95"><span class="toc-number">4.1.3.3.</span> <span class="toc-text">3. 周列转换算法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#4-%E9%A2%9C%E8%89%B2%E6%98%A0%E5%B0%84%E7%AE%97%E6%B3%95"><span class="toc-number">4.1.3.4.</span> <span class="toc-text">4. 颜色映射算法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#5-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E8%A6%81%E7%82%B9"><span class="toc-number">4.1.3.5.</span> <span class="toc-text">5. 性能优化要点</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%83%AD%E5%8A%9B%E6%95%B0%E6%8D%AE%E6%A0%B8%E5%BF%83%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E6%95%B0%E6%8D%AE%E8%A7%A3%E6%9E%90%E5%AD%98%E5%82%A8%E7%AE%97%E6%B3%95"><span class="toc-number">4.1.4.</span> <span class="toc-text">热力数据核心数据结构与数据解析存储算法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E5%8A%9B%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E8%BD%AC%E5%8C%96%E6%8E%A5%E5%8F%A3%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number">4.2.</span> <span class="toc-text">热力数据结构转化接口的优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E7%9A%84%E5%8F%91%E7%8E%B0"><span class="toc-number">4.2.1.</span> <span class="toc-text">问题的发现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">4.2.2.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%9F%E6%89%8B%E5%BC%B9%E7%AA%97%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.3.</span> <span class="toc-text">跟手弹窗的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B5%B7%E5%9B%A0"><span class="toc-number">4.3.1.</span> <span class="toc-text">起因</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%8E%A5%E5%8F%A3%E9%80%89%E6%8B%A9"><span class="toc-number">4.3.2.</span> <span class="toc-text">实现的接口选择</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">4.3.3.</span> <span class="toc-text">代码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E7%AE%97%E6%B3%95%EF%BC%9A%E8%BE%B9%E7%95%8C%E9%99%90%E5%88%B6%EF%BC%88Clamping%EF%BC%89"><span class="toc-number">4.3.3.1.</span> <span class="toc-text">核心算法：边界限制（Clamping）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BE%B9%E7%95%8C%E8%AE%A1%E7%AE%97%E7%9A%84%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="toc-number">4.3.3.2.</span> <span class="toc-text">边界计算的设计思路</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%E5%88%86%E6%9E%90"><span class="toc-number">4.3.3.3.</span> <span class="toc-text">实际应用场景分析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BE%B9%E7%95%8C%E9%99%90%E5%88%B6%E7%9A%84%E6%95%B0%E5%AD%A6%E5%8E%9F%E7%90%86"><span class="toc-number">4.3.3.4.</span> <span class="toc-text">边界限制的数学原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BE%B9%E7%95%8C%E5%80%BC%E7%9A%84%E9%80%89%E6%8B%A9%E4%BE%9D%E6%8D%AE"><span class="toc-number">4.3.3.5.</span> <span class="toc-text">边界值的选择依据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="toc-number">4.3.3.6.</span> <span class="toc-text">优化建议</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">4.3.3.7.</span> <span class="toc-text">总结</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%B9%E7%95%8C%E9%99%90%E5%88%B6%E9%97%AE%E9%A2%98"><span class="toc-number">4.3.4.</span> <span class="toc-text">边界限制问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%BF%AE%E5%A4%8D"><span class="toc-number">5.</span> <span class="toc-text">问题修复</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%83%AD%E5%8A%9B%E6%97%A5%E5%8E%86%E7%9A%84%E8%AE%BE%E7%BD%AE%E4%B8%8E%E6%B8%B2%E6%9F%93%E6%9B%B4%E6%96%B0%E4%B8%8D%E5%90%8C%E6%AD%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">5.1.</span> <span class="toc-text">热力日历的设置与渲染更新不同步的问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E7%8E%B0%E8%B1%A1"><span class="toc-number">5.1.1.</span> <span class="toc-text">问题现象</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D"><span class="toc-number">5.1.2.</span> <span class="toc-text">修复</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E6%80%BB%E7%BB%93"><span class="toc-number">5.1.3.</span> <span class="toc-text">修复总结</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2026/02/01/KimiCode/" title="KimiCode"><img src="/imgs/ArticleTopImgs/KimiCodeTopImg.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="KimiCode"/></a><div class="content"><a class="title" href="/2026/02/01/KimiCode/" title="KimiCode">KimiCode</a><time datetime="2026-02-01T06:20:33.000Z" title="发表于 2026-02-01 14:20:33">2026-02-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/09/MachineCollectionFinalReview/" title="机器学习与数据挖掘期末复习"><img src="/imgs/ArticleTopImgs/MachineCollectionFinalReviewTopImg.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="机器学习与数据挖掘期末复习"/></a><div class="content"><a class="title" href="/2026/01/09/MachineCollectionFinalReview/" title="机器学习与数据挖掘期末复习">机器学习与数据挖掘期末复习</a><time datetime="2026-01-09T06:46:13.000Z" title="发表于 2026-01-09 14:46:13">2026-01-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/06/osFinalReview/" title="操作系统期末复习"><img src="/imgs/ArticleTopImgs/osFinalReviewTopImg.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="操作系统期末复习"/></a><div class="content"><a class="title" href="/2026/01/06/osFinalReview/" title="操作系统期末复习">操作系统期末复习</a><time datetime="2026-01-06T05:10:37.000Z" title="发表于 2026-01-06 13:10:37">2026-01-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2026/01/04/computerNetFinalReview/" title="计算机网络期末复习"><img src="/imgs/ArticleTopImgs/computerNetFinalReviewTopImg.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="计算机网络期末复习"/></a><div class="content"><a class="title" href="/2026/01/04/computerNetFinalReview/" title="计算机网络期末复习">计算机网络期末复习</a><time datetime="2026-01-04T04:51:40.000Z" title="发表于 2026-01-04 12:51:40">2026-01-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2025/12/24/dataCollectionFinalReview/" title="数据采集实践期末复习"><img src="/imgs/ArticleTopImgs/dataCollectionFinalReviewTopImg.webp" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="数据采集实践期末复习"/></a><div class="content"><a class="title" href="/2025/12/24/dataCollectionFinalReview/" title="数据采集实践期末复习">数据采集实践期末复习</a><time datetime="2025-12-24T07:22:31.000Z" title="发表于 2025-12-24 15:22:31">2025-12-24</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/footerBg.png);"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2026 By XBXyftx</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text"><a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/#/Integrated/index"><span>备案号：京ICP备2025126467号</span></a></div><script type="text/javascript" src="https://unpkg.com/mermaid@undefined/dist/mermaid.min.js" id="maid-script"></script><script>if (window.mermaid) {
  var options = JSON.parse(document.getElementById('maid-script').getAttribute('mermaid-options'));
  mermaid.initialize(options);
}</script><div></div><span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span><script>var now = new Date(); 
function createtime() { 
var grt = new Date("4/25/2024 18:30"); // 在此处修改你的建站时间
now.setTime(now.getTime() + 250); 
days = (now - grt) / 1000 / 60 / 60 / 24; 
dnum = Math.floor(days); 
hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum); 
hnum = Math.floor(hours); 
if (String(hnum).length == 1) { hnum = "0" + hnum; } 
minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum); 
mnum = Math.floor(minutes); 
if (String(mnum).length == 1) { mnum = "0" + mnum; } 
seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum); 
snum = Math.round(seconds); 
if (String(snum).length == 1) { snum = "0" + snum; } 
document.getElementById("timeDate").innerHTML = "本网站已运行 " + dnum + " 天 "; 
document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒"; 
} 
setInterval(createtime, 250);</script></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><a class="rightMenu-item" href="javascript:window.history.back();"><i class="fa-solid fa-arrow-left"></i></a><a class="rightMenu-item" href="javascript:window.location.reload();"><i class="fa-solid fa-arrow-rotate-right"></i></a><a class="rightMenu-item" href="javascript:window.history.forward();"><i class="fa-solid fa-arrow-right"></i></a><a class="rightMenu-item" id="menu-radompage" href="javascript:window.location.href = window.location.origin;"><i class="fa-solid fa-house"></i></a></div><div class="rightMenu-group rightMenu-line hide" id="menu-text"><a class="rightMenu-item" href="javascript:rmf.copySelect();"><i class="fa-solid fa-copy"></i><span>复制</span></a></div><div class="rightMenu-group rightMenu-line"><a class="rightMenu-item" href="javascript:rmf.switchReadMode();"><i class="fa-solid fa-book"></i><span>阅读模式</span></a></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" type="module"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><!-- 瀑布流JavaScript - 只在首页加载--><!-- 文章打字机效果 - 只在文章页面加载--><script src="/js/typewriter-effect.js"></script><!-- 网络监控器 - 帮助定位503问题--><script src="/js/network-monitor.js"></script><script src="/js/topimg-monitor.js"></script><!-- 入场弹窗功能--><script src="/js/entrance-popup-config.js"></script><script src="/js/entrance-popup.js"></script><!-- 基础懒加载功能--><script src="/js/lazy-loading.js"></script><!-- 图片懒加载刷新按钮功能--><script src="/js/lazy-image-refresh.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('/%5Bobject%20Object%5D').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikooxbx.netlify.app/.netlify/functions/twikoo',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const init = (el = document, path = location.pathname) => {
    twikoo.init({
      el: el.querySelector('#twikoo-wrap'),
      envId: 'https://twikooxbx.netlify.app/.netlify/functions/twikoo',
      region: '',
      onCommentLoaded: () => {
        btf.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      },
      ...option,
      path: isShuoshuo ? path : (option && option.path) || path
    })

    

    isShuoshuo && (window.shuoshuoComment.destroyTwikoo = () => {
      if (el.children.length) {
        el.innerHTML = ''
        el.classList.add('no-comment')
      }
    })
  }

  const loadTwikoo = (el, path) => {
    if (typeof twikoo === 'object') setTimeout(() => init(el, path), 0)
    else btf.getScript('/js/twikoo.js').then(() => init(el, path))
  }

  if (isShuoshuo) {
    'Twikoo' === 'Twikoo'
      ? window.shuoshuoComment = { loadComment: loadTwikoo }
      : window.loadOtherComment = loadTwikoo
    return
  }

  if ('Twikoo' === 'Twikoo' || !true) {
    if (true) btf.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else loadTwikoo()
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script></div><canvas id="universe"></canvas><script defer src="/js/universe-optimized.js"></script><script defer src="/js/jquery-3.6.0.min.js"></script><script defer src="/js/rightmenu.js"></script><script defer src="/js/happy-title.js"></script><script defer src="/js/lazy-loading-optimized.js"></script><script defer src="/js/lightbox-enhanced.js"></script><script async data-pjax src="//cn.vercount.one/js"></script></div><!-- hexo injector body_end start --><script data-pjax>
  function butterfly_swiper_injector_config(){
    var parent_div_git = document.getElementsByClassName('recent-posts')[0];
    var item_html = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms;"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2025/06/24/typewriter/" alt=""><img width="48" height="48" src="/imgs/ArticleTopImgs/TypeWriteTopImg.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-06-24</span><a class="blog-slider__title" href="2025/06/24/typewriter/" alt="">Butterfly主题实现简介打字机</a><div class="blog-slider__text">详细介绍如何在Hexo的Butterfly主题中添加炫酷的打字机效果，包含完整的实现代码和配置方法。</div><a class="blog-slider__button" href="2025/06/24/typewriter/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2025/04/30/ToTheApril2025/" alt=""><img width="48" height="48" src="/imgs/ArticleTopImgs/AprilTopImg.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-04-30</span><a class="blog-slider__title" href="2025/04/30/ToTheApril2025/" alt="">致2025那个繁忙的4月</a><div class="blog-slider__text">人们总是匆匆向前，殊不知时光易逝啊……（本文图量较大加载较慢持续更新中！！！）</div><a class="blog-slider__button" href="2025/04/30/ToTheApril2025/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2025/03/16/yiDuo/" alt=""><img width="48" height="48" src="/imgs/ArticleTopImgs/yiduoTopImg.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-03-16</span><a class="blog-slider__title" href="2025/03/16/yiDuo/" alt="">关于鸿蒙的一多能力</a><div class="blog-slider__text">一多能力的学习笔记</div><a class="blog-slider__button" href="2025/03/16/yiDuo/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2025/11/01/ThoughtsOnVibeCoding/" alt=""><img width="48" height="48" src="/imgs/ArticleTopImgs/ThoughtsOnVibeCodingTopImg.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-11-01</span><a class="blog-slider__title" href="2025/11/01/ThoughtsOnVibeCoding/" alt="">在虚构与现实之间，守住那束灵感之光</a><div class="blog-slider__text">对于Vibe Coding以及更泛化的AI使用的一些想法（持续更新中）</div><a class="blog-slider__button" href="2025/11/01/ThoughtsOnVibeCoding/" alt="">详情   </a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms;"><a class="blog-slider__img" href="2025/04/20/RemoteCommunication/" alt=""><img width="48" height="48" src="/imgs/ArticleTopImgs/RCPTopImg.webp" alt="" onerror="this.src=https://unpkg.zhimg.com/akilar-candyassets/image/loading.gif; this.onerror = null;"/></a><div class="blog-slider__content"><span class="blog-slider__code">2025-04-20</span><a class="blog-slider__title" href="2025/04/20/RemoteCommunication/" alt="">远场通信服务</a><div class="blog-slider__text">本文将介绍鸿蒙远场通信服务</div><a class="blog-slider__button" href="2025/04/20/RemoteCommunication/" alt="">详情   </a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载butterfly_swiper')
    parent_div_git.insertAdjacentHTML("afterbegin",item_html)
    }
  var elist = 'undefined'.split(',');
  var cpage = location.pathname;
  var epage = 'all';
  var flag = 0;

  for (var i=0;i<elist.length;i++){
    if (cpage.includes(elist[i])){
      flag++;
    }
  }

  if ((epage ==='all')&&(flag == 0)){
    butterfly_swiper_injector_config();
  }
  else if (epage === cpage){
    butterfly_swiper_injector_config();
  }
  </script><script defer src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper.min.js"></script><script defer data-pjax src="https://npm.elemecdn.com/hexo-butterfly-swiper/lib/swiper_init.js"></script><!-- hexo injector body_end end --></body></html>